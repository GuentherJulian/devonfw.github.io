<!DOCTYPE html><html lang="en"><head><style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style><style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
<meta http-equiv="Content-Type" content="text/html; charset=">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Updated at 2019-11-13 14:14:18 UTC">

<!-- ******** SOCIAL MEDIA META ********** -->

<meta name="title" property="og:title" content="devonfw website">
<meta property="og:type" content="website">
<meta name="image" property="og:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="description" property="og:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta property="og:url" content="https://devonfw.com/index.html">

<meta name="twitter:title" content="devonfw website">
<meta name="twitter:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta name="twitter:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="twitter:card" content="summary_large_image">

<!-- ************************************* -->


<title>devonfw guide</title>
<!-- devonfw website stylesheet -->
<link rel="stylesheet" type="text/css" href="/devonfw.css">
<!-- Lunr -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.6/lunr.min.js" integrity="sha256-M/Awbb/BYh+Rh0aGjpQid26p1b2OBsrk2k9yAvQxPV0=" crossorigin="anonymous"></script>
<!-- JQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.4/styles/googlecode.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.4/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.4/lang/common.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<!-- ************** Google analytics ************ -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-151636804-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-151636804-1');
</script>

<!-- ******************************************** -->

</head>
<body id="master.asciidoc" class="book toc2 toc-left">
<div id="website-navbar" class="website-navbar">
<button id="menu-button" class="menu-button">
  <img src="/images/menu-button.svg" width="32px" height="32px" alt>
</button>

<ul>
<li>
<p><span class="image"><a class="image" href="/website/pages/welcome/welcome.html"><img alt="logo" src="/images/Logo_devonfw.svg"></a></span></p>
</li>
<li>
<p><a href="/website/pages/resources/resources.html">RESOURCES</a></p>
</li>
<li>
<p><a href="/website/pages/explore/explore.html">EXPLORE</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">DOCS</a></p>
</li>
<li>
<p><a href="/website/pages/community/community.html">COMMUNITY</a></p>
</li>
</ul>

<form class="form-inline">
  <div class="search-bar">
    <input id="search-field" type="search" class="form-control mr-sm-2" placeholder="Search by keyword(s)..." aria-label="Search" style="height: auto;">
    <div class="sb-res-pos px-4">
      <div id="click-outside" class="click-outside z-50 hidden"></div>
      <div class="col rounded px-0 border z-100 bg-white hidden search-bar-results" id="search-results-box">
      </div>
    </div>
  </div>
</form>
<a class="navbar-github text-white" href="https://github.com/devonfw/">
  <img src="/images/github-mark.png" width="auto" height="auto" alt>
</a></div>
<div id="sidebar" class="wiki-sidebar"></div>

<div id="header">
<h1>devonfw guide</h1>
<div class="details">
<span id="author" class="author">Updated at 2019-11-13 14:14:28 UTC</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<p><span class="toc-root"><a href="master.html">devonfw guide</a></span></p><ul class="sectlevel0">
<li><a href="master-general-start.asciidoc.html">I. Getting Started</a>
</li>
<li><a href="master-ide.asciidoc.html">II. devonfw ide</a>
</li>
<li><a href="master-devon4j.asciidoc.html">III. devon4j</a>
<ul class="sectlevel1">
<li><a href="master-devon4j.asciidoc_introduction.html">6. Introduction</a>
</li>
<li><a href="master-devon4j.asciidoc_coding.html">7. Coding</a>
</li>
<li><a href="master-devon4j.asciidoc_layers.html">8. Layers</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html"><span class="toc-current">9. Guides</span></a>
<ul class="sectlevel2">
<li><a href="master-devon4j.asciidoc_guides.html#guide-dependency-injection.asciidoc">9.1. Dependency Injection</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-configuration.asciidoc">9.2. Configuration</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc">9.3. Java Persistence API</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-auditing.asciidoc">9.4. Auditing</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-transactions.asciidoc">9.5. Transaction Handling</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-sql.asciidoc">9.6. SQL</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-database-migration.asciidoc">9.7. Database Migration</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-hana.asciidoc">9.8. SAP HANA</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-oracle.asciidoc">9.9. Oracle RDBMS</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-jee.asciidoc">9.10. JEE</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-logging.asciidoc">9.11. Logging</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-security.asciidoc">9.12. Security</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-access-control.asciidoc">9.13. Access-Control</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-data-permission.asciidoc">9.14. Data-permissions</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-validation.asciidoc">9.15. Validation</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-aop.asciidoc">9.16. Aspect Oriented Programming (AOP)</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-exceptions.asciidoc">9.17. Exception Handling</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-i18n.asciidoc">9.18. Internationalization</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-xml.asciidoc">9.19. XML</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-json.asciidoc">9.20. JSON</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-rest.asciidoc">9.21. REST</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-soap.asciidoc">9.22. SOAP</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-service-client.asciidoc">9.23. Service Client</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc">9.24. Testing</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-transferobject.asciidoc">9.25. Transfer-Objects</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-beanmapping.asciidoc">9.26. Bean-Mapping</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-datatype.asciidoc">9.27. Datatypes</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-accessibility.asciidoc">9.28. Accessibility</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-caching.asciidoc">9.29. Caching</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-cors-support.asciidoc">9.30. CORS support</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-blob-support.asciidoc">9.31. BLOB support</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-jdk.asciidoc">9.32. Java Development Kit</a>
</li>
<li><a href="master-devon4j.asciidoc_guides.html#guide-apm.asciidoc">9.33. Application Performance Management</a>
</li>
</ul>
</li>
<li><a href="master-devon4j.asciidoc_devonfw-development.html">10. devonfw Development</a>
</li>
<li><a href="master-devon4j.asciidoc_tutorials.html">11. Tutorials</a>
</li>
<li><a href="master-devon4j.asciidoc_for-core-developers.html">12. For Core-Developers</a>
</li>
</ul>
</li>
<li><a href="master-devon4ng.asciidoc.html">IV. devon4ng</a>
</li>
<li><a href="master-devon4net.asciidoc.html">V. devon4net</a>
</li>
<li><a href="master-devon4node.asciidoc.html">VI. devon4node</a>
</li>
<li><a href="master-devonfw-shop-floor.asciidoc.html">VII. devonfw shop floor</a>
</li>
<li><a href="master-cicdgen.asciidoc.html">VIII. cicdgen</a>
</li>
<li><a href="master-cobigen.asciidoc.html">IX. CobiGen&#x2009;&#x2014;&#x2009;Code-based incremental Generator</a>
</li>
<li><a href="master-devonfw-testing.asciidoc.html">X. devonfw testing</a>
</li>
<li><a href="master-my-thai-star.asciidoc.html">XI. MyThaiStar</a>
</li>
<li><a href="general-contributing.asciidoc.html">XII. Contributing Guide</a>
</li>
<li><a href="general-release-notes.asciidoc.html">XIII. Release Notes</a>
</li>
</ul>
</div>
</div><div id="content">
<div class="sect1">
<h2 id="master-devon4j.asciidoc_guides">9. Guides</h2>
<div class="sectionbody">
<!-- toc disabled -->
<div class="sect2">
<h3 id="guide-dependency-injection.asciidoc">9.1. Dependency Injection</h3>
<div class="paragraph">
<p>Dependency injection is one of the most important design patterns and is a key principle to a modular and component based architecture. The Java Standard for dependency injection is <a href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">javax.inject (JSR330)</a> that we use in combination with <a href="http://docs.oracle.com/javaee/5/api/javax/annotation/package-summary.html">JSR250</a>.</p>
</div>
<div class="paragraph">
<p>There are many frameworks which support this standard including all recent Java EE application servers. We recommend to use <a href="http://spring.io/">Spring</a> (also known as springframework) that we use in our example application. However, the modules we provide typically just rely on JSR330 and can be used with any compliant container.</p>
</div>
<div class="sect3">
<h4 id="guide-dependency-injection.asciidoc_key-principles">9.1.1. Key Principles</h4>
<div class="paragraph">
<p>A Bean in CDI (Contexts and Dependency-Injection) or Spring is typically part of a larger component and encapsulates some piece of logic that should in general be replaceable. As an example we can think of a Use-Case, Data-Access-Object (DAO), etc. As best practice we use the following principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Separation of API and implementation</strong><br>
We create a self-contained API documented with JavaDoc. Then we create an implementation of this API that we annotate with <code>@Named</code>. This implementation is treated as secret. Code from other components that wants to use the implementation shall only rely on the API. Therefore we use dependency injection via the interface with the <code>@Inject</code> annotation.</p>
</li>
<li>
<p><strong>Stateless implementation</strong><br>
By default implementations (CDI-Beans) shall always be stateless. If you store state information in member variables you can easily run into concurrency problems and nasty bugs. This is easy to avoid by using local variables and separate state classes for complex state-information. Try to avoid stateful CDI-Beans wherever possible. Only add state if you are fully aware of what you are doing and properly document this as a warning in your JavaDoc.</p>
</li>
<li>
<p><strong>Usage of JSR330</strong><br>
We use javax.inject (JSR330) and JSR250 as a common standard that makes our code portable (works in any modern Java EE environment). However, we recommend to use the springframework as container. But we never use proprietary annotations such as <code>@Autowired</code> instead of standardized annotations like <code>@Inject</code>. Generally we avoid proprietary annotations in business code (<code>common</code> and <a href="master-devon4j.asciidoc_layers.html#guide-logic-layer.asciidoc">logic layer</a>).</p>
</li>
<li>
<p><strong>Simple Injection-Style</strong><br>
In general you can choose between constructor, setter or field injection. For simplicity we recommend to do private field injection as it is very compact and easy to maintain. We believe that constructor injection is bad for maintenance especially in case of inheritance (if you change the dependencies you need to refactor all sub-classes). Private field injection and public setter injection are very similar but setter injection is much more verbose (often you are even forced to have javadoc for all public methods). If you are writing re-usable library code setter injection will make sense as it is more flexible. In a business application you typically do not need that and can save a lot of boiler-plate code if you use private field injection instead. Nowadays you are using container infrastructure also for your tests (see <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc">spring integration tests</a>) so there is no need to inject manually (what would require a public setter).</p>
</li>
<li>
<p><strong>KISS</strong><br>
To follow the KISS (keep it small and simple) principle we avoid advanced features (e.g. <a href="master-devon4j.asciidoc_guides.html#guide-aop.asciidoc">AOP</a>, non-singleton beans) and only use them where necessary.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="guide-dependency-injection.asciidoc_example-bean">9.1.2. Example Bean</h4>
<div class="paragraph">
<p>Here you can see the implementation of an example bean using JSR330 and JSR250:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
public class MyBeanImpl implements MyBean {
  @Inject
  private MyOtherBean myOtherBean;

  @PostConstruct
  public void init() {
    // initialization if required (otherwise omit this method)
  }

  @PreDestroy
  public void dispose() {
    // shutdown bean, free resources if required (otherwise omit this method)
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It depends on <code>MyOtherBean</code> that should be the interface of an other component that is injected into the field because of the <code>@Inject</code> annotation. To make this work there must be exactly one implementation of <code>MyOtherBean</code> in the container (in our case spring). In order to put a Bean into the container we use the <code>@Named</code> annotation so in our example we put <code>MyBeanImpl</code> into the container. Therefore it can be injected into all setters that take the interface <code>MyBean</code> as argument and are annotated with <code>@Inject</code>.</p>
</div>
<div class="paragraph">
<p>In some situations you may have an Interface that defines a kind of &quot;plugin&quot; where you can have multiple implementations in your container and want to have all of them. Then you can request a list with all instances of that interface as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @Inject
  private List&lt;MyConverter&gt; converters;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that when writing library code instead of annotating implementation with <code>@Named</code> it is better to provide <code>@Configuration</code> classes that choose the implementation via <code>@Bean</code> methods (see <a href="http://docs.spring.io/spring-javaconfig/docs/1.0.0.M4/reference/html/ch02s02.html">@Bean documentation</a>). This way you can better &quot;export&quot; specific features instead of relying library users to do a component-scan to your library code and loose control on upgrades.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-dependency-injection.asciidoc_bean-configuration">9.1.3. Bean configuration</h4>
<div class="paragraph">
<p>Wiring and Bean configuration can be found in <a href="master-devon4j.asciidoc_guides.html#guide-configuration.asciidoc">configuration guide</a>.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-configuration.asciidoc">9.2. Configuration</h3>
<div class="paragraph">
<p>An application needs to be configurable in order to allow internal setup (like CDI) but also to allow externalized configuration of a deployed package (e.g. integration into runtime environment). Using <a href="http://projects.spring.io/spring-boot/">Spring Boot</a> (must read: <a href="http://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/htmlsingle/#using-boot">Spring Boot reference</a>) we rely on a comprehensive configuration approach following a &quot;convention over configuration&quot; pattern. This guide adds on to this by detailed instructions and best-practices how to deal with configurations.</p>
</div>
<div class="paragraph">
<p>In general we distinguish the following kinds of configuration that are explained in the following sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="master-devon4j.asciidoc_guides.html#guide-configuration.asciidoc_internal-application-configuration">Internal Application configuration</a> maintained by developers</p>
</li>
<li>
<p><a href="#guide-configuration.asciidoc_externalized-environment-configuration">Externalized Environment configuration</a> maintained by operators</p>
</li>
<li>
<p><a href="master-devon4j.asciidoc_guides.html#guide-configuration.asciidoc_business-configuration">Externalized Business configuration</a> maintained by business administrators</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="guide-configuration.asciidoc_internal-application-configuration">9.2.1. Internal Application Configuration</h4>
<div class="paragraph">
<p>The application configuration contains all internal settings and wirings of the application (bean wiring, database mappings, etc.) and is maintained by the application developers at development time. There usually is a main configuration registered with main Spring Boot App, but differing configurations to support automated test of the application can be defined using profiles (not detailed in this guide).</p>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_spring-boot-application">Spring Boot Application</h5>
<div class="paragraph">
<p>The devonfw recommends using <a href="http://projects.spring.io/spring-boot/">spring-boot</a> to build web applications.
For a complete documentation see the <a href="http://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/htmlsingle/">Spring Boot Reference Guide</a>.</p>
</div>
<div class="paragraph">
<p>With spring-boot you provide a simple <em>main class</em> (also called starter class) like this:
com.devonfw.mtsj.application</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootApplication(exclude = { EndpointAutoConfiguration.class })
@EntityScan(basePackages = { &quot;com.devonfw.mtsj.application&quot; }, basePackageClasses = { AdvancedRevisionEntity.class })
@EnableGlobalMethodSecurity(jsr250Enabled = true)
@ComponentScan(basePackages = { &quot;com.devonfw.mtsj.application.general&quot;, &quot;com.devonfw.mtsj.application&quot; })
public class SpringBootApp {

  /**
   * Entry point for spring-boot based app
   *
   * @param args - arguments
   */
  public static void main(String[] args) {

    SpringApplication.run(SpringBootApp.class, args);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In an devonfw application this main class is always located in the <code>&lt;basepackage&gt;</code> of the application package namespace (see <a href="coding-conventions.html#packages">package-conventions</a>). This is because a spring boot application will automatically do a classpath scan for components (spring-beans) and entities in the package where the application main class is located including all sub-packages. You can use the <code>@ComponentScan</code> and <code>@EntityScan</code> annotations to customize this behaviour.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_standard-beans-configuration">Standard beans configuration</h5>
<div class="paragraph">
<p>For basic bean configuration we rely on spring boot using mainly configuration classes and only occasionally XML configuration files. Some key principle to understand Spring Boot auto-configuration features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring Boot auto-configuration attempts to automatically configure your Spring application based on the jar dependencies and annotated components found in your source code.</p>
</li>
<li>
<p>Auto-configuration is non-invasive, at any point you can start to define your own configuration to replace specific parts of the auto-configuration by redefining your identically named bean (see also <code>exclude</code> attribute of <code>@SpringBootApplication</code> in example code above).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Beans are configured via annotations in your java code (see <a href="master-devon4j.asciidoc_guides.html#guide-dependency-injection.asciidoc">dependency-injection</a>).</p>
</div>
<div class="paragraph">
<p>For technical configuration you will typically write additional spring config classes annotated with <code>@Configuration</code> that provide bean implementations via methods annotated with <code>@Bean</code>. See <a href="http://docs.spring.io/spring-javaconfig/docs/1.0.0.M4/reference/html/ch02s02.html">spring @Bean documentation</a> for further details. Like in XML you can also use <code>@Import</code> to make a <code>@Configuration</code> class include other configurations.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_xml-based-beans-configuration">XML-based beans configuration</h5>
<div class="paragraph">
<p>It is still possible and allowed to provide (bean-) configurations using XML, though not recommended. These configuration files are no more bundled via a main xml config file but loaded individually from their respective owners, e.g. for unit-tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringApplicationConfiguration(classes = { SpringBootApp.class }, locations = { &quot;classpath:/config/app/batch/beans-productimport.xml&quot; })
public class ProductImportJobTest extends AbstractSpringBatchIntegrationTest {
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configuration XML-files reside in an adequately named subfolder of:</p>
</div>
<div class="paragraph">
<p><code>src/main/resources/app</code></p>
</div>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_batch-configuration">Batch configuration</h5>
<div class="paragraph">
<p>In the directory <code>src/main/resources/config/app/batch</code> we place the configuration for the batch jobs. Each file within this directory represents one batch job. See <a href="master-devon4j.asciidoc_layers.html#guide-batch-layer.asciidoc">batch-layer</a> for further details.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_beanmapper-configuration">BeanMapper Configuration</h5>
<div class="paragraph">
<p>In the directory <code>src/main/resources/config/app/common</code> we place the configuration for the bean-mapping.
See <a href="guide-beanmapping.html#bean-mapper-configuration">bean-mapper configuration</a> for further details.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_security-configuration">Security configuration</h5>
<div class="paragraph">
<p>The abstract base class <code>BaseWebSecurityConfig</code> should be extended to configure web application security thoroughly.
A basic and secure configuration is provided which can be overridden or extended by subclasses.
Subclasses must use the <code>@Profile</code> annotation to further discriminate between beans used in production and testing scenarios. See the following example:</p>
</div>
<div class="listingblock">
<div class="title">Listing 5. How to extend <code>BaseWebSecurityConfig</code> for Production and Test</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
@EnableWebSecurity
@Profile(SpringProfileConstants.JUNIT)
public class TestWebSecurityConfig extends BaseWebSecurityConfig {...}

@Configuration
@EnableWebSecurity
@Profile(SpringProfileConstants.NOT_JUNIT)
public class WebSecurityConfig extends BaseWebSecurityConfig {...}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/general/service/impl/config/WebSecurityConfig.java">WebSecurityConfig</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_websocket-configuration">WebSocket configuration</h5>
<div class="paragraph">
<p>A websocket endpoint is configured within the business package as a Spring configuration class. The annotation <code>@EnableWebSocketMessageBroker</code> makes Spring Boot registering this endpoint.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package your.path.to.the.websocket.config;
...
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig extends AbstractWebSocketMessageBrokerConfigurer {
...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_database-configuration">Database Configuration</h5>
<div class="paragraph">
<p>To choose database of your choice , set <code>spring.profiles.active=XXX</code> in <code>src/main/resources/config/application.properties</code>. Also, one has to set all the active spring profiles in this <code>application.properties</code> and not in any of the other <code>application.properties</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-configuration.asciidoc_externalized-configuration">9.2.2. Externalized Configuration</h4>
<div class="paragraph">
<p>Externalized configuration is a configuration that is provided separately to a deployment package and can be maintained undisturbed by re-deployments.</p>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_environment-configuration">Environment Configuration</h5>
<div class="paragraph">
<p>The environment configuration contains configuration parameters (typically port numbers, host names, passwords, logins, timeouts, certificates, etc.) specific for the different environments. These are under the control of the operators responsible for the application.</p>
</div>
<div class="paragraph">
<p>The environment configuration is maintained in <code>application.properties</code> files, defining various properties (see <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html">common application properties</a> for a list of properties defined by the spring framework).
These properties are explained in the corresponding configuration sections of the guides for each topic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="guide-jpa.html#database-system-and-access">persistence configuration</a></p>
</li>
<li>
<p><a href="guide-service-layer.html#jax-rs-configuration">service configuration</a></p>
</li>
<li>
<p><a href="guide-logging.html#configuration">logging guide</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a general understanding how spring-boot is loading and boostrapping your <code>application.properties</code> see <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html">spring-boot external configuration</a>.
The following properties files are used in every devonfw application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>src/main/resources/application.properties</code> providing a default configuration - bundled and deployed with the application package. It further acts as a template to derive a tailored minimal environment-specific configuration.</p>
</li>
<li>
<p><code>src/main/resources/config/application.properties</code> providing additional properties only used at development time (for all local deployment scenarios). This property file is excluded from all packaging.</p>
</li>
<li>
<p><code>src/test/resources/config/application.properties</code> providing additional properties only used for testing (JUnits based on <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc">spring test</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For other environments where the software gets deployed such as <code>test</code>, <code>acceptance</code> and <code>production</code> you need to provide a tailored copy of <code>application.properties</code>. The location depends on the deployment strategy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>standalone run-able Spring Boot App using embedded tomcat: <code>config/application.properties</code> under the installation directory of the spring boot application.</p>
</li>
<li>
<p>dedicated tomcat (one tomcat per app): <code>$CATALINA_BASE/lib/config/application.properties</code></p>
</li>
<li>
<p>tomcat serving a number of apps (requires expanding the wars): <code>$CATALINA_BASE/webapps/&lt;app&gt;/WEB-INF/classes/config</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this <code>application.properties</code> you only define the minimum properties that are environment specific and inherit everything else from the bundled <code>src/main/resources/application.properties</code>. In any case, make very sure that the classloader will find the file.</p>
</div>
<div class="paragraph">
<p>Make sure your properties are thoroughly documented by providing a comment to each property. This inline documentation is most valuable for your operating department.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_business-configuration">Business Configuration</h5>
<div class="paragraph">
<p>The business configuration contains all business configuration values of the application, which can be edited by administrators through the GUI. The business configuration values are stored in the database in key/value pairs.</p>
</div>
<div class="paragraph">
<p>The database table <code>business_configuration</code> has the following columns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ID</p>
</li>
<li>
<p>Property name</p>
</li>
<li>
<p>Property type (Boolean, Integer, String)</p>
</li>
<li>
<p>Property value</p>
</li>
<li>
<p>Description</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>According to the entries in this table, the administrative GUI shows a generic form to change business configuration. The hierarchy of the properties determines the place in the GUI, so the GUI bundles properties from the same hierarchy level and name. Boolean values are shown as checkboxes, integer and string values as text fields. The properties are read and saved in a typed form, an error is raised if you try to save a string in an integer property for example.</p>
</div>
<div class="paragraph">
<p>We recommend the following base layout for the hierarchical business configuration:</p>
</div>
<div class="paragraph">
<p><code>component.[subcomponent].[subcomponent].propertyname</code></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-configuration.asciidoc_security">9.2.3. Security</h4>
<div class="paragraph">
<p>Often you need to have passwords (for databases, third-party services, etc.) as part of your configuration. These are typically environment specific (see above). However, with DevOps and continuous-deployment you might be tempted to commit such configurations into your version-control (e.g. <code>git</code>). Doing that with plain text passwords is a severe problem especially for production systems. Never do that! Instead we offer some suggestions how to deal with sensible configurations:</p>
</div>
<div class="sect4">
<h5 id="guide-configuration.asciidoc_password-encryption">Password Encryption</h5>
<div class="paragraph">
<p>A simple but reasonable approach is to configure the passwords encrypted with a master-password. The master-password should be a strong secret that is specific for each environment. It must never be committed to version-control.
In order to support encrypted passwords in spring-boot <code>application.properties</code> all you need to do is to add <a href="https://github.com/ulisesbocchio/jasypt-spring-boot#jasypt-spring-boot">jasypt-spring-boot</a> as dependency in your <code>pom.xml</code>(please check for recent version):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.github.ulisesbocchio&lt;/groupId&gt;
  &lt;artifactId&gt;jasypt-spring-boot-starter&lt;/artifactId&gt;
  &lt;version&gt;1.17&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will smoothly integrate <a href="http://jasypt.org/">jasypt</a> into your <a href="https://projects.spring.io/spring-boot/">spring-boot</a> application. Read this <a href="https://wiki.jasig.org/display/CASUM/HOWTO+Use+Jasypt+to+encrypt+passwords+in+configuration+files">HOWTO</a> to learn how to encrypt and decrypt passwords using jasypt. Here is a simple example output of an encrypted password (of course you have to use strong passwords instead of <code>secret</code> and <code>postgres</code> - this is only an example):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">----ARGUMENTS-------------------

input: postgres
password: secret

----OUTPUT----------------------

jd5ZREpBqxuN9ok0IhnXabgw7V3EoG2p</code></pre>
</div>
</div>
<div class="paragraph">
<p>The master-password can be configured on your target environment via the property <code>jasypt.encryptor.password</code>. As system properties given on the command-line are visible in the process list, we recommend to use an <code>config/application.yml</code> file only for this purpose (as we recommended to use <code>application.properties</code> for regular configs):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>jasypt:
    encryptor:
        password: secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>(of course you will replace <code>secret</code> with a strong password). In case you happen to have multiple apps on the same machine, you can symlink the <code>application.yml</code> from a central place.
Now you are able to put encrypted passwords into your <code>application.properties</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>spring.datasource.password=ENC(jd5ZREpBqxuN9ok0IhnXabgw7V3EoG2p)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To prevent jasypt to throw an exception in dev or test scenarios simply put this in your local config (<code>src/main/config/application.properties</code> and same for <code>test</code>, see above for details):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>jasypt.encryptor.password=none</code></pre>
</div>
</div>
<div class="paragraph">
<p>Is this Security by Obscurity?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Yes, from the point of view to protect the passwords on the target environment this is nothing but security by obscurity. If an attacker somehow got full access to the machine this will only cause him to spend some more time.</p>
</li>
<li>
<p>No, if someone only gets the configuration file. So all your developers might have access to the version-control where the config is stored. Others might have access to the software releases that include this configs. But without the master-password that should only be known to specific operators none else can decrypt the password (except with brute-force what will take a very long time, see jasypt for details).</p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-jpa.asciidoc">9.3. Java Persistence API</h3>
<div class="paragraph">
<p>For mapping java objects to a relational database we use the <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html">Java Persistence API (JPA)</a>.
As JPA implementation we recommend to use <a href="http://hibernate.org/orm/">hibernate</a>. For general documentation about JPA and hibernate follow the links above as we will not replicate the documentation. Here you will only find guidelines and examples how we recommend to use it properly. The following examples show how to map the data of a database to an entity. As we use JPA we abstract from <a href="master-devon4j.asciidoc_guides.html#guide-sql.asciidoc">SQL</a> here. However, you will still need a <a href="https://en.wikipedia.org/wiki/Data_definition_language">DDL</a> script for your schema and during maintenance also <a href="master-devon4j.asciidoc_guides.html#guide-database-migration.asciidoc">database migrations</a>. Please follow our <a href="master-devon4j.asciidoc_guides.html#guide-sql.asciidoc">SQL guide</a> for such artifacts.</p>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_entity">9.3.1. Entity</h4>
<div class="paragraph">
<p>Entities are part of the persistence layer and contain the actual data. They are POJOs (Plain Old Java Objects) on which the relational data of a database is mapped and vice versa. The mapping is configured via JPA annotations (<code>javax.persistence</code>). Usually an entity class corresponds to a table of a database and a property to a column of that table. A persistent entity instance then represents a row of the database table.</p>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_a-simple-entity">A Simple Entity</h5>
<div class="paragraph">
<p>The following listing shows a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Entity
@Table(name=&quot;TEXTMESSAGE&quot;)
public class MessageEntity extends ApplicationPersistenceEntity implements Message {

  private String text;

  public String getText() {
    return this.text;
  }

  public void setText(String text) {
    this.text = text;
  }
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Entity</code> annotation defines that instances of this class will be entities which can be stored in the database. The <code>@Table</code> annotation is optional and can be used to define the name of the corresponding table in the database. If it is not specified, the simple name of the entity class is used instead.</p>
</div>
<div class="paragraph">
<p>In order to specify how to map the attributes to columns we annotate the corresponding getter methods (technically also private field annotation is also possible but approaches can not be mixed).
The <code>@Id</code> annotation specifies that a property should be used as <a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc_primary-keys">primary key</a>.
With the help of the <code>@Column</code> annotation it is possible to define the name of the column that an attribute is mapped to as well as other aspects such as <code>nullable</code> or <code>unique</code>. If no column name is specified, the name of the property is used as default.</p>
</div>
<div class="paragraph">
<p>Note that every entity class needs a constructor with public or protected visibility that does not have any arguments. Moreover, neither the class nor its getters and setters may be final.</p>
</div>
<div class="paragraph">
<p>Entities should be simple POJOs and not contain business logic.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_entities-and-datatypes">Entities and Datatypes</h5>
<div class="paragraph">
<p>Standard datatypes like <code>Integer</code>, <code>BigDecimal</code>, <code>String</code>, etc. are mapped automatically by JPA. Custom <a href="master-devon4j.asciidoc_guides.html#guide-datatype.asciidoc">datatypes</a> are mapped as serialized <a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc_blob">BLOB</a> by default what is typically undesired.
In order to map atomic custom datatypes (implementations of`+SimpleDatatype`) we implement an <code>AttributeConverter</code>. ere is a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Converter(autoApply = true)
public class MoneyAttributeConverter implements AttributeConverter&lt;Money, BigDecimal&gt; {

  public BigDecimal convertToDatabaseColumn(Money attribute) {
    return attribute.getValue();
  }

  public Money convertToEntityAttribute(BigDecimal dbData) {
    return new Money(dbData);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotation <code>@Converter</code> is detected by the JPA vendor if the annotated class is in the packages to scan. Further, <code>autoApply = true</code> implies that the converter is automatically used for all properties of the handled datatype. Therefore all entities with properties of that datatype will automatically be mapped properly (in our example <code>Money</code> is mapped as <code>BigDecimal</code>).</p>
</div>
<div class="paragraph">
<p>In case you have a composite datatype that you need to map to multiple columns the JPA does not offer a real solution. As a workaround you can use a bean instead of a real datatype and declare it as <a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc_embeddable"><code>@Embeddable</code></a>. If you are using hibernate you can implement <code>CompositeUserType</code>. Via the <code>@TypeDef</code> annotation it can be registered to hibernate. If you want to annotate the <code>CompositeUserType</code> implementation itself you also need another annotation (e.g. <code>MappedSuperclass</code> tough not technically correct) so it is found by the scan.</p>
</div>
<div class="sect5">
<h6 id="guide-jpa.asciidoc_enumerations">Enumerations</h6>
<div class="paragraph">
<p>By default JPA maps Enums via their ordinal. Therefore the database will only contain the ordinals (0, 1, 2, etc.) . So , inside the database you can not easily understand their meaning. Using <code>@Enumerated</code> with <code>EnumType.STRING</code> allows to map the enum values to their name (<code>Enum.name()</code>). Both approaches are fragile when it comes to code changes and refactoring (if you change the order of the enum values or rename them) after the application is deployed to production. If you want to avoid this and get a robust mapping you can define a dedicated string in each enum value for database representation that you keep untouched. Then you treat the enum just like any other <a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc_entities-and-datatypes">custom datatype</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="guide-jpa.asciidoc_blob">BLOB</h6>
<div class="paragraph">
<p>If binary or character large objects (BLOB/CLOB) should be used to store the value of an attribute, e.g. to store an icon, the <code>@Lob</code> annotation should be used as shown in the following listing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Lob
public byte[] getIcon() {
  return this.icon;
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Using a byte array will cause problems if BLOBs get large because the entire BLOB is loaded into the RAM of the server and has to be processed by the garbage collector. For larger BLOBs the type <a href="http://docs.oracle.com/javase/7/docs/api/java/sql/Blob.html">Blob</a> and streaming should be used.
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public Blob getAttachment() {
  return this.attachment;
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="guide-jpa.asciidoc_date-and-time">Date and Time</h6>
<div class="paragraph">
<p>To store date and time related values, the temporal annotation can be used as shown in the listing below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Temporal(TemporalType.TIMESTAMP)
public java.util.Date getStart() {
  return start;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Until Java8 the java data type <code>java.util.Date</code> (or Jodatime) has to be used.
<code>TemporalType</code> defines the granularity. In this case, a precision of nanoseconds is used. If this granularity is not wanted, <code>TemporalType.DATE</code> can be used instead, which only has a granularity of milliseconds.
Mixing these two granularities can cause problems when comparing one value to another. This is why we <strong>only</strong>  use <code>TemporalType.TIMESTAMP</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="guide-jpa.asciidoc_querydsl-and-custom-types">QueryDSL and Custom Types</h6>
<div class="paragraph">
<p>Using the Aliases API of QueryDSL might result in an <code>InvalidDataAccessApiUsageException</code> when using custom datatypes in entity properties. This can be circumvented in two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure you have the following maven dependencies in your project (<code>core</code> module) to support custom types via the Aliases API:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.ow2.asm&lt;/groupId&gt;
  &lt;artifactId&gt;asm&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;cglib&lt;/groupId&gt;
  &lt;artifactId&gt;cglib&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Make sure, that all your custom types used in entities provide a non-argument constructor with at least visibility level <code>protected</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="guide-jpa.asciidoc_idref">IdRef</h6>
<div class="paragraph">
<p>IdRef can be used to reference the other entities in TOs</p>
</div>
<div class="paragraph">
<p>IdRef is just a wrapper for reference ID as Long. so instead of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private Long orderId;</code></pre>
</div>
</div>
<div class="paragraph">
<p>you can write</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private IdRef&lt;Order&gt; orderId;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using IdRef make sure that the Junit tests contains the following</p>
</div>
<div class="paragraph">
<p>Junit test should be derived from DbTest (e.g. ComponentDbTest and SubsystemDbTest).</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_primary-keys">Primary Keys</h5>
<div class="paragraph">
<p>We only use simple Long values as primary keys (IDs). By default it is auto generated (<code>@GeneratedValue(strategy=GenerationType.AUTO)</code>). This is already provided by the class <code>com.devonfw.&lt;projectName&gt;.general.dataaccess.api.AbstractPersistenceEntity</code> that you can extend.
In case you have business oriented keys (often as <code>String</code>), you can define an additional property for it and declare it as unique (<code>@Column(unique=true)</code>).
Be sure to include &quot;AUTO_INCREMENT&quot; in your sql table field ID to be able to persist data (or similar for other databases).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_relationships">9.3.2. Relationships</h4>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_n1-and-11-relationships">n:1 and 1:1 Relationships</h5>
<div class="paragraph">
<p>Entities often do not exist independently but are in some relation to each other. For example, for every period of time one of the StaffMember&#x2019;s of the restaurant example has worked, which is represented by the class <code>WorkingTime</code>, there is a relationship to this StaffMember.</p>
</div>
<div class="paragraph">
<p>The following listing shows how this can be modeled using JPA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...

@Entity
public class WorkingTimeEntity {
   ...

   private StaffMemberEntity staffMember;

   @ManyToOne
   @JoinColumn(name=&quot;STAFFMEMBER&quot;)
   public StaffMemberEntity getStaffMember() {
      return this.staffMember;
   }

   public void setStaffMember(StaffMemberEntity staffMember) {
      this.staffMember = staffMember;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To represent the relationship, an attribute of the type of the corresponding entity class that is referenced has been introduced. The relationship is a n:1 relationship, because every <code>WorkingTime</code> belongs to exactly one <code>StaffMember</code>, but a <code>StaffMember</code> usually worked more often than once.<br>
This is why the <code>@ManyToOne</code> annotation is used here. For 1:1 relationships the <code>@OneToOne</code> annotation can be used which works basically the same way. To be able to save information about the relation in the database, an additional column in the corresponding table of WorkingTime is needed which contains the primary key of the referenced StaffMember. With the <code>name</code> element of the <code>@JoinColumn</code> annotation it is possible to specify the name of this column.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_1n-and-nm-relationships">1:n and n:m Relationships</h5>
<div class="paragraph">
<p>The relationship of the example listed above is currently an unidirectional one, as there is a getter method for retrieving the <code>StaffMember</code> from the <code>WorkingTime</code> object, but not vice versa.</p>
</div>
<div class="paragraph">
<p>To make it a bidirectional one, the following code has to be added to <code>StaffMember</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private Set&lt;WorkingTimeEntity&gt; workingTimes;

  @OneToMany(mappedBy=&quot;staffMember&quot;)
  public Set&lt;WorkingTimeEntity&gt; getWorkingTimes() {
    return this.workingTimes;
  }

  public void setWorkingTimes(Set&lt;WorkingTimeEntity&gt; workingTimes) {
    this.workingTimes = workingTimes;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the relationship bidirectional, the tables in the database do not have to be changed. Instead the column that corresponds to the attribute <code>staffMember</code> in class <code>WorkingTime</code> is used, which is specified by the <code>mappedBy</code> element of the <code>@OneToMany</code> annotation. Hibernate will search for corresponding <code>WorkingTime</code> objects automatically when a <code>StaffMember</code> is loaded.</p>
</div>
<div class="paragraph">
<p>The problem with bidirectional relationships is that if a <code>WorkingTime</code> object is added to the set or list <code>workingTimes</code> in <code>StaffMember</code>, this does not have any effect in the database unless
the <code>staffMember</code> attribute of that <code>WorkingTime</code> object is set. That is why the devon4j advices not to use bidirectional relationships but to use queries instead. How to do this is shown <a href="#guide-jpa.asciidoc_queries">here</a>. If a bidirectional relationship should be used nevertheless, appropriate add and remove methods must be used.</p>
</div>
<div class="paragraph">
<p>For 1:n and n:m relations, the devon4j demands that (unordered) Sets and no other collection types are used, as shown in the listing above. The only exception is whenever an ordering is really needed, (sorted) lists can be used.<br>
For example, if <code>WorkingTime</code> objects should be sorted by their start time, this could be done like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private List&lt;WorkingTimeEntity&gt; workingTimes;

  @OneToMany(mappedBy = &quot;staffMember&quot;)
  @OrderBy(&quot;startTime asc&quot;)
  public List&lt;WorkingTimeEntity&gt; getWorkingTimes() {
    return this.workingTimes;
  }

  public void setWorkingTimes(List&lt;WorkingTimeEntity&gt; workingTimes) {
    this.workingTimes = workingTimes;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The value of the <code>@OrderBy</code> annotation consists of an attribute name of the class followed by <code>asc</code> (ascending) or <code>desc</code> (descending).</p>
</div>
<div class="paragraph">
<p>To store information about a n:m relationship, a separate table has to be used, as one column cannot store several values (at least if the database schema is in first normal form).<br>
For example if one wanted to extend the example application so that all ingredients of one <code>FoodDrink</code> can be saved and to model the ingredients themselves as entities (e.g. to store additional information about them), this could be modeled as follows (extract of class <code>FoodDrink</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private Set&lt;IngredientEntity&gt; ingredients;

  @ManyToMany()
  @JoinTable
  public Set&lt;IngredientEntity&gt; getIngredients() {
    return this.ingredients;
  }

  public void setOrders(Set&lt;IngredientEntity&gt; ingredients) {
    this.ingredients = ingredients;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Information about the relation is stored in a table called <code>BILL_ORDER</code> that has to have two columns, one for referencing the Bill, the other one for referencing the Order. Note that the <code>@JoinTable</code> annotation is not needed in this case because a separate table is the default solution here (same for n:m relations) unless there is a <code>mappedBy</code> element specified.</p>
</div>
<div class="paragraph">
<p>For 1:n relationships this solution has the disadvantage that more joins (in the database system) are needed to get a Bill with all the Orders it refers to. This might have a negative impact on performance so that the solution to store a reference to the Bill row/entity in the Order&#x2019;s table is probably the better solution in most cases.</p>
</div>
<div class="paragraph">
<p>Note that bidirectional n:m relationships are not allowed for applications based on the devon4j. Instead a third entity has to be introduced, which &quot;represents&quot; the relationship (it has two n:1 relationships).</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_eager-vs.-lazy-loading">Eager vs. Lazy Loading</h5>
<div class="paragraph">
<p>Using JPA it is possible to use either lazy or eager loading. Eager loading means that for entities retrieved from the database, other entities that are referenced by these entities are also retrieved, whereas lazy loading means that this is only done when they are actually needed, i.e. when the corresponding getter method is invoked.</p>
</div>
<div class="paragraph">
<p>Application based on the devon are strongly advised to always use lazy loading. The JPA defaults are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@OneToMany</code>: LAZY</p>
</li>
<li>
<p><code>@ManyToMany</code>: LAZY</p>
</li>
<li>
<p><code>@ManyToOne</code>: EAGER</p>
</li>
<li>
<p><code>@OneToOne</code>: EAGER</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So at least for <code>@ManyToOne</code> and <code>@OneToOne</code> you always need to override the default by providing <code>fetch = FetchType.LAZY</code>.
IMPORTANT: Please read the <a href="master-devon4j.asciidoc_guides.html#guide-jpa-performance.asciidoc">performance guide</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_cascading-relationships">Cascading Relationships</h5>
<div class="paragraph">
<p>For relations it is also possible to define whether operations are cascaded (like a recursion) to the related entity.
By default, nothing is done in these situations. This can be changed by using the <code>cascade</code> property of the annotation that specifies the relation type (<code>@OneToOne</code>, <code>@ManyToOne</code>, <code>@OneToMany</code>, <code>@ManyToOne</code>). This property accepts a <code>CascadeType</code> that offers the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PERSIST (for <code>EntityManager.persist</code>, relevant to inserted transient entities into DB)</p>
</li>
<li>
<p>REMOVE (for <code>EntityManager.remove</code> to delete entity from DB)</p>
</li>
<li>
<p>MERGE (for <code>EntityManager.merge</code>)</p>
</li>
<li>
<p>REFRESH (for <code>EntityManager.refresh</code>)</p>
</li>
<li>
<p>DETACH (for <code>EntityManager.detach</code>)</p>
</li>
<li>
<p>ALL (cascade all of the above operations)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="http://meri-stuff.blogspot.de/2012/03/jpa-tutorial.html">here</a> for more information.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_embeddable">9.3.3. Embeddable</h4>
<div class="paragraph">
<p>An embeddable Object is a way to group properties of an <a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc_entity">entity</a> into a separate Java (child) object. Unlike with implement <a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc_relationships">relationships</a> the embeddable is not a separate entity and its properties are stored (embedded) in the same table together with the entity. This is helpful to structure and reuse groups of properties.</p>
</div>
<div class="paragraph">
<p>The following example shows an <code>Address</code> implemented as an embeddable class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Embeddable
public class AddressEmbeddable {

  private String street;
  private String number;
  private Integer zipCode;
  private String city;

  @Column(name=&quot;STREETNUMBER&quot;)
  public String getNumber() {
    return number;
  }

  public void setNumber(String number) {
    this.number = number;
  }

  ...  // other getter and setter methods, equals, hashCode
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see an embeddable is similar to an entity class, but with an <code>@Embeddable</code> annotation instead of the <code>@Entity</code> annotation and without primary key or modification counter.
An Embeddable does not exist on its own but in the context of an entity.
As a simplification Embeddables do not require a separate interface and <a href="guide-transferobject.html#ETO">ETO</a> as the <a href="master-devon4j.asciidoc_guides.html#guide-beanmapping.asciidoc">bean-mapper</a> will create a copy automatically when converting the owning entity to an ETO.
However, in this case the embeddable becomes part of your <code>api</code> module that therefore needs a dependency on the <code>JPA</code>.</p>
</div>
<div class="paragraph">
<p>In addition to that the methods <code>equals(Object)</code> and <code>hashCode()</code> need to be implemented as this is required by Hibernate (it is not required for entities because they can be unambiguously identified by their primary key). For some hints on how to implement the <code>hashCode()</code> method please have a look <a href="http://stackoverflow.com/questions/113511/hash-code-implementation">here</a>.</p>
</div>
<div class="paragraph">
<p>Using this <code>AddressEmbeddable</code> inside an entity class can be done like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private AddressEmbeddable address;

  @Embedded
  public AddressEmbeddable getAddress() {
    return this.address;
  }

  public void setAddress(AddressEmbeddable address) {
    this.address = address;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Embedded</code> annotation needs to be used for embedded attributes. Note that if in all columns of the embeddable (here <code>Address</code>) are <code>null</code>, then the embeddable object itself is also <code>null</code> inside the entity. This has to be considered to avoid NullPointerException&#x2019;s. Further this causes some issues with primitive types in embeddable classes that can be avoided by only using object types instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_inheritance">9.3.4. Inheritance</h4>
<div class="paragraph">
<p>Just like normal java classes, <a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc_entity">entity</a> classes can inherit from others. The only difference is that you need to specify how to map a class hierarchy to database tables. Generic abstract super-classes for entities can simply be annotated with <code>@MappedSuperclass</code>.</p>
</div>
<div class="paragraph">
<p>For all other cases the JPA offers the annotation <code>@Inheritance</code> with the property <code>strategy</code> talking an <code>InheritanceType</code> that has the following options:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>SINGLE_TABLE</code>: This strategy uses a single table that contains all columns needed to store all entity-types of the entire inheritance hierarchy. If a column is not needed for an entity because of its type, there is a null value in this column. An additional column is introduced, which denotes the type of the entity (called <code>dtype</code>).</p>
</li>
<li>
<p><code>TABLE_PER_CLASS</code>: For each concrete entity class there is a table in the database that can store such an entity with all its attributes. An entity is only saved in the table corresponding to its most concrete type. To get all entities of a super type, joins are needed.</p>
</li>
<li>
<p><code>JOINED</code>: In this case there is a table for every entity class including abstract classes, which contains only the columns for the persistent properties of that particular class. Additionally there is a primary key column in every table. To get an entity of a class that is a subclass of another one, joins are needed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Each of the three approaches has its advantages and drawbacks, which are discussed in detail <a href="http://openjpa.apache.org/builds/1.0.4/apache-openjpa-1.0.4/docs/manual/jpa_overview_mapping_inher.html#jpa_overview_mapping_inher_tpc">here</a>. In most cases, the first one should be used, because it is usually the fastest way to do the mapping, as no joins are needed when retrieving, searching or persisting entities. Moreover it is rather simple and easy to understand.
One major disadvantage is that the first approach could lead to a table with a lot of null values, which might have a negative impact on the database size.</p>
</div>
<div class="paragraph">
<p>The inheritance strategy has to be annotated to the top-most entity of the class hierarchy (where `@MappedSuperclass`es are not considered) like in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Entity
@Inheritance(strategy=InheritanceType.SINGLE_TABLE)
public abstract class MyParentEntity extends ApplicationPersistenceEntity implements MyParent {
  ...
}

@Entity
public class MyChildEntity extends MyParentEntity implements MyChild {
  ...
}

@Entity
public class MyOtherEntity extends MyParentEntity implements MyChild {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a best practice we advise you to avoid entity hierarchies at all where possible and otherwise to keep the hierarchy as small as possible. In order to just ensure reuse or establish a common API you can consider a shared interface, a <code>@MappedSuperclass</code> or an <code>@Embeddable</code> instead of an entity hierarchy.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_repositories-and-daos">9.3.5. Repositories and DAOs</h4>
<div class="paragraph">
<p>For each entity a code unit is created that groups all database operations for that entity. We recommend to use <a href="master-devon4j.asciidoc_guides.html#guide-repository.asciidoc">spring-data repositories</a> for that as it is most efficient for developers. As an alternative there is still the classic approach using <a href="master-devon4j.asciidoc_guides.html#guide-dao.asciidoc">DAOs</a>.</p>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_concurrency-control">Concurrency Control</h5>
<div class="paragraph">
<p>The concurrency control defines the way concurrent access to the same data of a database is handled. When several users (or threads of application servers) concurrently access a database, anomalies may happen, e.g. a transaction is able to see changes from another transaction although that one did, not yet commit these changes. Most of these anomalies are automatically prevented by the database system, depending on the <a href="http://en.wikipedia.org/wiki/Isolation_(database_systems)"><em>isolation level</em></a> (property <code>hibernate.connection.isolation</code> in the <code>jpa.xml</code>, see <a href="http://docs.jboss.org/hibernate/orm/5.0/manual/en-US/html/ch03.html">here</a>).</p>
</div>
<div class="paragraph">
<p>Another anomaly is when two stakeholders concurrently access a record, do some changes and write them back to the database. The JPA addresses this with different locking strategies (see <a href="http://www.objectdb.com/java/jpa/persistence/lock">here</a>).</p>
</div>
<div class="paragraph">
<p>As a best practice we are using optimistic locking for regular end-user <a href="master-devon4j.asciidoc_layers.html#guide-service-layer.asciidoc">services</a> (OLTP) and pessimistic locking for <a href="master-devon4j.asciidoc_layers.html#guide-batch-layer.asciidoc">batches</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_optimistic-locking">Optimistic Locking</h5>
<div class="paragraph">
<p>The class <code>com.devonfw.module.jpa.persistence.api.AbstractPersistenceEntity</code> already provides optimistic locking via a <code>modificationCounter</code> with the <code>@Version</code> annotation. Therefore JPA takes care of optimistic locking for you. When entities are transferred to clients, modified and sent back for update you need to ensure the <code>modificationCounter</code> is part of the game. If you follow our guides about <a href="master-devon4j.asciidoc_guides.html#guide-transferobject.asciidoc">transfer-objects</a> and <a href="master-devon4j.asciidoc_layers.html#guide-service-layer.asciidoc">services</a> this will also work out of the box.
You only have to care about two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to deal with optimistic locking in <a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc_relationships">relationships</a>?<br>
Assume an entity <code>A</code> contains a collection of <code>B</code> entities. Should there be a locking conflict if one user modifies an instance of <code>A</code> while another user in parallel modifies an instance of <code>B</code> that is contained in the other instance? To address this , take a look at <a href="https://oasp.github.io/oasp4j_content/2.4.0/maven/apidocs/io/oasp/module/jpa/dataaccess/api/GenericDao.html#forceIncrementModificationCounter(E)">GenericDao.forceIncrementModificationCounter</a>.</p>
</li>
<li>
<p>What should happen in the UI if an <code>OptimisticLockException</code> occurred?<br>
According to KISS our recommendation is that the user gets an error displayed that tells him to do his change again on the recent data. Try to design your system and the work processing in a way to keep such conflicts rare and you are fine.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_pessimistic-locking">Pessimistic Locking</h5>
<div class="paragraph">
<p>For back-end <a href="master-devon4j.asciidoc_layers.html#guide-service-layer.asciidoc">services</a> and especially for <a href="master-devon4j.asciidoc_layers.html#guide-batch-layer.asciidoc">batches</a> optimistic locking is not suitable. A human user shall not cause a large batch process to fail because he was editing the same entity. Therefore such use-cases use pessimistic locking what gives them a kind of priority over the human users.
In your <a href="#guide-jpa.asciidoc_data-access-object">DAO</a> implementation you can provide methods that do pessimistic locking via <a href="http://docs.oracle.com/javaee/7/api/javax/persistence/EntityManager.html"><code>EntityManager</code></a> operations that take a <a href="http://docs.oracle.com/javaee/7/api/javax/persistence/LockModeType.html"><code>LockModeType</code></a>. Here is a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  getEntityManager().lock(entity, LockModeType.READ);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the <code>lock(Object, LockModeType)</code> method with <code>LockModeType.READ</code>, Hibernate will issue a <code>SELECT &#x2026;&#x200B; FOR UPDATE</code>. This means that no one else can update the entity (see <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28286/statements_10002.htm">here</a> for more information on the statement). If <code>LockModeType.WRITE</code> is specified, Hibernate issues a <code>SELECT &#x2026;&#x200B; FOR UPDATE NOWAIT</code> instead, which has has the same meaning as the statement above, but if there is already a lock, the program will not wait for this lock to be released. Instead, an exception is raised.<br>
Use one of the types if you want to modify the entity later on, for read only access no lock is required.</p>
</div>
<div class="paragraph">
<p>As you might have noticed, the behavior of Hibernate deviates from what one would expect by looking at the <code>LockModeType</code> (especially <code>LockModeType.READ</code> should not cause a <code>SELECT &#x2026;&#x200B; FOR UPDATE</code> to be issued). The framework actually deviates from what is <a href="http://docs.oracle.com/javaee/7/api/javax/persistence/LockModeType.html">specified</a> in the JPA for unknown reasons.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_database-auditing">9.3.6. Database Auditing</h4>
<div class="paragraph">
<p>See <a href="master-devon4j.asciidoc_guides.html#guide-auditing.asciidoc">auditing guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_testing-entities-and-daos">9.3.7. Testing Entities and DAOs</h4>
<div class="paragraph">
<p>See <a href="guide-testing.html#integration-testing">testing guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_principles">9.3.8. Principles</h4>
<div class="paragraph">
<p>We strongly recommend these principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the JPA where ever possible and use vendor (hibernate) specific features only for situations when JPA does not provide a solution. In the latter case consider first if you really need the feature.</p>
</li>
<li>
<p>Create your entities as simple POJOs and use JPA to annotate the getters in order to define the mapping.</p>
</li>
<li>
<p>Keep your entities simple and avoid putting advanced logic into entity methods.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_database-configuration">9.3.9. Database Configuration</h4>
<div class="paragraph">
<p>The <a href="master-devon4j.asciidoc_guides.html#guide-configuration.asciidoc">configuration</a> for spring and hibernate is already provided by devonfw in our sample application and the application template. So you only need to worry about a few things to customize.</p>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_database-system-and-access">Database System and Access</h5>
<div class="paragraph">
<p>Obviously you need to configure which type of database you want to use as well as the location and credentials to access it. The defaults are configured in <code>application-default.properties</code> that is bundled and deployed with the release of the software. It should therefore contain the properties as in the given example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">  database.url=jdbc:postgresql://database.enterprise.com/app
  database.user.login=appuser01
  database.hibernate.dialect = org.hibernate.dialect.PostgreSQLDialect
  database.hibernate.hbm2ddl.auto=validate</code></pre>
</div>
</div>
<div class="paragraph">
<p>The environment specific settings (especially passwords) are configured by the operators in <code>application.properties</code>. For further details consult the <a href="master-devon4j.asciidoc_guides.html#guide-configuration.asciidoc">configuration guide</a>. It can also override the default values. The relevant configuration properties can be seen by the following example for the development environment (located in <code>src/test/resources</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">  database.url=jdbc:postgresql://localhost/app
  database.user.password=************
  database.hibernate.hbm2ddl.auto=create</code></pre>
</div>
</div>
<div class="paragraph">
<p>For further details about <code>database.hibernate.hbm2ddl.auto</code> please see <a href="http://docs.jboss.org/hibernate/orm/5.0/manual/en-US/html/ch03.html#configuration-misc-properties">here</a>. For production and acceptance environments we use the value <code>validate</code> that should be set as default. In case you want to use Oracle RDBMS you can find additional hints <a href="guide-oracle.html#driver">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_database-migration">Database Migration</h5>
<div class="paragraph">
<p>See <a href="master-devon4j.asciidoc_guides.html#guide-database-migration.asciidoc">database migration</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_database-logging">Database Logging</h5>
<div class="paragraph">
<p>Add the following properties to <code>application.properties</code> to enable logging of database queries for debugging purposes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">spring.jpa.properties.hibernate.show_sql=true
spring.jpa.properties.hibernate.use_sql_comments=true
spring.jpa.properties.hibernate.format_sql=true</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_pooling">Pooling</h5>
<div class="paragraph">
<p>You typically want to pool JDBC connections to boost performance by recycling previous connections. There are many libraries available to do connection pooling. We recommend to use <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a>. For Oracle RDBMS see <a href="guide-oracle.html#pooling">here</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa.asciidoc_security">9.3.10. Security</h4>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_sql-injection">SQL-Injection</h5>
<div class="paragraph">
<p>A common <a href="master-devon4j.asciidoc_guides.html#guide-security.asciidoc">security</a> threat is <a href="http://en.wikipedia.org/wiki/SQL_injection">SQL-injection</a>. Never build queries with string concatenation or your code might be vulnerable as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  String query = &quot;Select op from OrderPosition op where op.comment = &quot; + userInput;
  return getEntityManager().createQuery(query).getResultList();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Via the parameter <code>userInput</code> an attacker can inject SQL (JPQL) and execute arbitrary statements in the database causing extreme damage. In order to prevent such injections you have to strictly follow our rules for <a href="#guide-jpa.asciidoc_queries">queries</a>: Use named queries for static queries and QueryDSL for dynamic queries. Please also consult the <a href="https://www.owasp.org/index.php/SQL_Injection_Prevention_Cheat_Sheet">SQL Injection Prevention Cheat Sheet</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa.asciidoc_limited-permissions-for-application">Limited Permissions for Application</h5>
<div class="paragraph">
<p>We suggest that you operate your application with a database user that has limited permissions so he can not modify the SQL schema (e.g. drop tables). For initializing the schema (DDL) or to do schema migrations use a separate user that is not used by the application itself.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa-query.asciidoc">9.3.11. Queries</h4>
<div class="paragraph">
<p>The <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html">Java Persistence API (JPA)</a> defines its own query language, the <a href="https://docs.oracle.com/html/E13946_01/ejb3_langref.html"><em>java persistence query language</em> (JPQL)</a> (see also <a href="https://docs.oracle.com/javaee/7/tutorial/persistence-querylanguage.htm">JPQL tutorial</a>), which is similar to SQL but operates on entities and their attributes instead of tables and columns.</p>
</div>
<div class="paragraph">
<p>The simplest CRUD-Queries (e.g. find an entity by its ID) are already build in the devonfw CRUD functionality (via <a href="master-devon4j.asciidoc_guides.html#guide-repository.asciidoc">Repository</a> or <a href="master-devon4j.asciidoc_guides.html#guide-dao.asciidoc">DAO</a>). For other cases you need to write your own query. We distinguish between <em>static</em> and <em>dynamic</em> queries. <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc_static-queries">Static queries</a> have a fixed JPQL query string that may only use parameters to customize the query at runtime. Instead, <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc_dynamic-queries">dynamic queries</a> can change their clauses (<code>WHERE</code>, <code>ORDER BY</code>, <code>JOIN</code>, etc.) at runtime depending on the given search criteria.</p>
</div>
<div class="sect4">
<h5 id="guide-jpa-query.asciidoc_static-queries">Static Queries</h5>
<div class="paragraph">
<p>E.g. to find all <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/dishmanagement/dataaccess/api/DishEntity.java">DishEntries</a> (from MTS sample app) that have a price not exceeding a given <code>maxPrice</code> we write the following JPQL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT dish FROM DishEntity dish WHERE dish.price &lt;= :maxPrice</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>dish</code> is used as alias (variable name) for our selected <code>DishEntity</code> (what refers to the simple name of the Java entity class). With <code>dish.price</code> we are referring to the Java property <code>price</code> (<code>getPrice()</code>/<code>setPrice(&#x2026;&#x200B;)</code>) in <code>DishEntity</code>. A named variable provided from outside (the search criteria at runtime) is specified with a colon (<code>:</code>) as prefix. Here with <code>:maxPrice</code> we reference to a variable that needs to be set via <code>query.setParameter(&quot;maxPrice&quot;, maxPriceValue)</code>. JPQL also supports indexed parameters (<code>?</code>) but they are discouraged because they easily cause confusion and mistakes.</p>
</div>
<div class="sect5">
<h6 id="guide-jpa-query.asciidoc_using-queries-to-avoid-bidirectional-relationships">Using Queries to Avoid Bidirectional Relationships</h6>
<div class="paragraph">
<p>With the usage of queries it is possible to avoid exposing relationships or modelling bidirectional relationships, which have some disadvantages (see <a href="guide-jpa.html#relationships">relationships</a>). This is especially desired for relationships between entities of different business components.
So for example to get all <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/ordermanagement/dataaccess/api/OrderLineEntity.java">OrderLineEntities</a> for a specific <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/ordermanagement/dataaccess/api/OrderEntity.java">OrderEntity</a> without using the <code>orderLines</code> relation from <code>OrderEntity</code> the following query could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT line FROM OrderLineEntity line WHERE line.order.id = :orderId</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa-query.asciidoc_dynamic-queries">Dynamic Queries</h5>
<div class="paragraph">
<p>For dynamic queries we use <a href="http://www.querydsl.com/">QueryDSL</a>. It allows to implement queries in a powerful but readable and type-safe way (unlike Criteria API). If you already know JPQL you will quickly be able to read and write QueryDSL code. It feels like JPQL but implemented in Java instead of plain text.</p>
</div>
<div class="paragraph">
<p>Please be aware that code-generation can be painful especially with large teams. We therefore recommend to use QueryDSL without code-generation. Here is an example from our sample application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  public List&lt;DishEntity&gt; findOrders(DishSearchCriteriaTo criteria) {
    DishEntity dish = Alias.alias(DishEntity.class);
    JPAQuery&lt;OrderEntity&gt; query = newDslQuery(alias); // new JPAQuery&lt;&gt;(getEntityManager()).from(Alias.$(dish));
    Range&lt;BigDecimal&gt; priceRange = criteria.getPriceRange();
    if (priceRange != null) {
      BigDecimal min = priceRange.getMin();
      if (min != null) {
        query.where(Alias.$(order.getPrice()).ge(min));
      }
      BigDecimal max = priceRange.getMax();
      if (max != null) {
        query.where(Alias.$(order.getPrice()).le(max));
      }
    }
    String name = criteria.getName();
    if ((name != null) &amp;&amp; (!name.isEmpty())) {
      // query.where(Alias.$(alias.getName()).eq(name));
      QueryUtil.get().whereString(query, Alias.$(alias.getName()), name, criteria.getNameOption());
    }
    return query.fetch();
  }</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa-query.asciidoc_using-wildcards">Using Wildcards</h5>
<div class="paragraph">
<p>For flexible queries it is often required to allow wildcards (especially in <a href="#guide-jpa-query.asciidoc_dynamic_queries">dynamic queries</a>). While users intuitively expect glob syntax the SQL and JPQL standards work different. Therefore a mapping is required. devonfw provides this on a lower level by <a href="https://github.com/devonfw/devon4j/blob/develop/modules/basic/src/main/java/com/devonfw/module/basic/common/api/query/LikePatternSyntax.java">LikePatternSyntax</a> and on a high level by <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryUtil.java#L54">QueryUtil</a> (see <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryHelper.java#L199">QueryHelper.newStringClause(&#x2026;&#x200B;)</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa-query.asciidoc_pagination">Pagination</h5>
<div class="paragraph">
<p>devonfw provides pagination support. If you are using <a href="master-devon4j.asciidoc_guides.html#guide-repository.asciidoc">spring-data repositories</a> you will get that directly from spring for static queries. Otherwise for dynamic or generally handwritten queries we provide this via <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryUtil.java#L102">QueryUtil.findPaginated(&#x2026;&#x200B;)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">boolean determineTotalHitCount = ...;
return QueryUtil.get().findPaginated(criteria.getPageable(), query, determineTotalHitCount);</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="guide-jpa-query.asciidoc_pagination-example">Pagination example</h6>
<div class="paragraph">
<p>For the table entity we can make a search request by accessing the REST endpoint with pagination support like in the following examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">POST mythaistar/services/rest/tablemanagement/v1/table/search
{
  &quot;pagination&quot;: {
    &quot;size&quot;:2,
    &quot;total&quot;:true
  }
}

//Response
{
    &quot;pagination&quot;: {
        &quot;size&quot;: 2,
        &quot;page&quot;: 1,
        &quot;total&quot;: 11
    },
    &quot;result&quot;: [
        {
            &quot;id&quot;: 101,
            &quot;modificationCounter&quot;: 1,
            &quot;revision&quot;: null,
            &quot;waiterId&quot;: null,
            &quot;number&quot;: 1,
            &quot;state&quot;: &quot;OCCUPIED&quot;
        },
        {
            &quot;id&quot;: 102,
            &quot;modificationCounter&quot;: 1,
            &quot;revision&quot;: null,
            &quot;waiterId&quot;: null,
            &quot;number&quot;: 2,
            &quot;state&quot;: &quot;FREE&quot;
        }
    ]
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As we are requesting with the <code>total</code> property set to <code>true</code> the server responds with the total count of rows for the query.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>For retrieving a concrete page, we provide the <code>page</code> attribute with the desired value. Here we also left out the <code>total</code> property so the server doesn&#x2019;t incur on the effort to calculate it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">POST mythaistar/services/rest/tablemanagement/v1/table/search
{
  &quot;pagination&quot;: {
    &quot;size&quot;:2,
    &quot;page&quot;:2
  }
}

//Response

{
    &quot;pagination&quot;: {
        &quot;size&quot;: 2,
        &quot;page&quot;: 2,
        &quot;total&quot;: null
    },
    &quot;result&quot;: [
        {
            &quot;id&quot;: 103,
            &quot;modificationCounter&quot;: 1,
            &quot;revision&quot;: null,
            &quot;waiterId&quot;: null,
            &quot;number&quot;: 3,
            &quot;state&quot;: &quot;FREE&quot;
        },
        {
            &quot;id&quot;: 104,
            &quot;modificationCounter&quot;: 1,
            &quot;revision&quot;: null,
            &quot;waiterId&quot;: null,
            &quot;number&quot;: 4,
            &quot;state&quot;: &quot;FREE&quot;
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa-query.asciidoc_query-meta-parameters">Query Meta-Parameters</h5>
<div class="paragraph">
<p>Queries can have meta-parameters and that are provided via <code>SearchCriteriaTo</code>. Besides paging (see above) we also get <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryHelper.java#L51">timeout support</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa-query.asciidoc_advanced-queries">Advanced Queries</h5>
<div class="paragraph">
<p>Writing queries can sometimes get rather complex. The current examples given above only showed very simple basics. Within this topic a lot of advanced features need to be considered like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.w3schools.com/sql/sql_join.asp">Joins</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/html/E13946_04/ejb3_langref.html#ejb3_langref_constructor">Constructor queries</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_orderby.asp">Order By</a> (Sorting)</p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_groupby.asp">Grouping</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_having.asp">Having</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_union.asp">Unions</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/cd/E11035_01/kodo41/full/html/ejb3_langref.html#ejb3_langref_subqueries">Sub-Queries</a></p>
</li>
<li>
<p>Aggregation functions like e.g. <a href="https://www.w3schools.com/sql/sql_count_avg_sum.asp">count/avg/sum</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_distinct.asp">Distinct selections</a></p>
</li>
<li>
<p>SQL Hints (see e.g. <a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#i8327">Oracle hints</a> or <a href="http://sqlhints.com/">SQL-Server hints</a>) - only when required for ultimate performance tuning</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This list is just containing the most important aspects. As we can not cover all these topics here, they are linked to external documentation that can help and guide you.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect3">
<h4 id="guide-repository.asciidoc">9.3.12. Spring-Data</h4>
<div class="paragraph">
<p>If you are using the Spring Framework and have no restrictions regarding that, we recommend to use <a href="https://projects.spring.io/spring-data-jpa/">spring-data-jpa</a> via <a href="http://repo1.maven.org/maven2/com/devonfw/java/starters/devon4j-starter-spring-data-jpa/">devon4j-starter-spring-data-jpa</a> that brings advanced integration (esp. for QueryDSL).</p>
</div>
<div class="sect4">
<h5 id="guide-repository.asciidoc_motivation">Motivation</h5>
<div class="paragraph">
<p>The benefits of spring-data are (for examples and explanations see next sections):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All you need is one single repository interface for each entity. No need for a separate implementation or other code artifacts like XML descriptors, <code>NamedQueries</code> class, etc.</p>
</li>
<li>
<p>You have all information together in one place (the repository interface) that actually belong together (where as in the classic approach you have the static <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc">queries</a> in an XML file, constants to them in <code>NamedQueries</code> class and referencing usages in DAO implementation classes).</p>
</li>
<li>
<p>Static <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc">queries</a> are most simple to realize as you do not need to write any method body. This means you can develop faster.</p>
</li>
<li>
<p>Support for paging is already build-in. Again for static <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc">query</a> method the is nothing you have to do except using the paging objects in the signature.</p>
</li>
<li>
<p>Still you have the freedom to write custom implementations via default methods within the repository interface (e.g. for dynamic queries).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="guide-repository.asciidoc_repository">Repository</h5>
<div class="paragraph">
<p>For each entity <code>&#xAB;Entity&#xBB;Entity</code> an interface is created with the name <code>&#xAB;Entity&#xBB;Repository</code> extending <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-spring-data/src/main/java/com/devonfw/module/jpa/dataaccess/api/data/DefaultRepository.java"><code>DefaultRepository</code></a>.
Such repository is the analogy to a <a href="master-devon4j.asciidoc_guides.html#guide-dao.asciidoc">Data-Access-Object (DAO)</a> used in the classic approach or when spring-data is not an option.</p>
</div>
<div class="sect5">
<h6 id="guide-repository.asciidoc_example">Example</h6>
<div class="paragraph">
<p>The following example shows how to write such a repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ExampleRepository extends DefaultRepository&lt;ExampleEntity&gt; {

  @Query(&quot;SELECT example FROM ExampleEntity example&quot; //
      + &quot; WHERE example.name = :name&quot;)
  List&lt;ExampleEntity&gt; findByName(@Param(&quot;name&quot;) String name);

  @Query(&quot;SELECT example FROM ExampleEntity example&quot; //
      + &quot; WHERE example.name = :name&quot;)
  Page&lt;ExampleEntity&gt; findByNamePaginated(@Param(&quot;name&quot;) String name, Pageable pageable);

  default Page&lt;ExampleEntity&gt; findByCriteria(ExampleSearchCriteriaTo criteria) {
    ExampleEntity alias = newDslAlias();
    JPAQuery&lt;ExampleEntity&gt; query = newDslQuery(alias);
    String name = criteria.getName();
    if ((name != null) &amp;&amp; !name.isEmpty()) {
      QueryUtil.get().whereString(query, $(alias.getName()), name, criteria.getNameOption());
    }
    return QueryUtil.get().findPaginated(criteria.getPageable(), query, false);
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>ExampleRepository</code> has the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CRUD support from spring-data (see <a href="https://docs.spring.io/spring-data/data-jpa/docs/current/api/org/springframework/data/jpa/repository/JpaRepository.html">JavaDoc</a> for details).</p>
</li>
<li>
<p>Support for <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-spring-data/src/main/java/com/devonfw/module/jpa/dataaccess/api/data/QueryDslSupport.java">QueryDSL integration</a>, <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryUtil.java">paging and more</a> as well as <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/feature/FeatureForceIncrementModificationCounter.java">locking</a> via <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-spring-data/src/main/java/com/devonfw/module/jpa/dataaccess/api/data/GenericRepository.java">GenericRepository</a></p>
</li>
<li>
<p>A static <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc">query</a> method <code>findByName</code> to find all <code>ExampleEntity</code> instances from DB that have the given name. Please note the <code>@Param</code> annotation that links the method parameter with the variable inside the query (<code>:name</code>).</p>
</li>
<li>
<p>The same with pagination support via <code>findByNamePaginated</code> method.</p>
</li>
<li>
<p>A dynamic <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc">query</a> method <code>findByCriteria</code> showing the QueryDSL and paging integration into spring-data provided by devon.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="guide-repository.asciidoc_further-examples">Further examples</h6>
<div class="paragraph">
<p>You can also read the JUnit test-case <a href="https://github.com/devonfw/devon4j/blob/develop/starters/starter-spring-data-jpa/src/test/java/com/devonfw/module/jpa/dataaccess/api/DefaultRepositoryTest.java">DefaultRepositoryTest</a> that is testing an example
<a href="https://github.com/devonfw/devon4j/blob/develop/starters/starter-spring-data-jpa/src/test/java/com/devonfw/example/component/dataaccess/api/FooRepository.java">FooRepository</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="guide-repository.asciidoc_auditing">Auditing</h6>
<div class="paragraph">
<p>In case you need <a href="master-devon4j.asciidoc_guides.html#guide-auditing.asciidoc">auditing</a>, you only need to extend <code>DefaultRevisionedRepository</code> instead of <code>DefaultRepository</code>. The auditing methods can be found in <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-spring-data/src/main/java/com/devonfw/module/jpa/dataaccess/api/data/GenericRevisionedRepository.java">GenericRevisionedRepository</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-repository.asciidoc_dependency">Dependency</h5>
<div class="paragraph">
<p>In case you want to switch to or add spring-data support to your devon application all you need is this maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- Starter for consuming REST services --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.devonfw.java.starters&lt;/groupId&gt;
  &lt;artifactId&gt;devon4j-starter-spring-data-jpa&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-repository.asciidoc_drawbacks">Drawbacks</h5>
<div class="paragraph">
<p>Spring-data also has some drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some kind of magic behind the scenes that are not so easy to understand. So in case you want to extend all your repositories without providing the implementation via a default method in a parent repository interface you need to deep-dive into spring-data. We assume that you do not need that and hope what spring-data and devon already provides out-of-the-box is already sufficient.</p>
</li>
<li>
<p>The spring-data magic also includes guessing the query from the method name. This is not easy to understand and especially to debug. Our suggestion is not to use this feature at all and either provide a <code>@Query</code> annotation or an implementation via default method.</p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect3">
<h4 id="guide-dao.asciidoc">9.3.13. Data Access Object</h4>
<div class="paragraph">
<p>The <em>Data Access Objects</em> (DAOs) are part of the persistence layer.
They are responsible for a specific <a href="#guide-dao.asciidoc_entity">entity</a> and should be named <code>&#xAB;Entity&#xBB;Dao</code> and <code>&#xAB;Entity&#xBB;DaoImpl</code>.
The DAO offers the so called CRUD-functionalities (create, retrieve, update, delete) for the corresponding entity.
Additionally a DAO may offer advanced operations such as <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc">query</a> or locking methods.</p>
</div>
<div class="sect4">
<h5 id="guide-dao.asciidoc_dao-interface">DAO Interface</h5>
<div class="paragraph">
<p>For each DAO there is an interface named <code>&#xAB;Entity&#xBB;Dao</code> that defines the API. For CRUD support and common naming we derive it from the <code>ApplicationDao</code> interface that comes with the devon application template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface MyEntityDao extends ApplicationDao&lt;MyEntity&gt; {
  List&lt;MyEntity&gt; findByCriteria(MyEntitySearchCriteria criteria);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All CRUD operations are inherited from <code>ApplicationDao</code> so you only have to declare the additional methods.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-dao.asciidoc_dao-implementation">DAO Implementation</h5>
<div class="paragraph">
<p>Implementing a DAO is quite simple. We create a class named <code>&#xAB;Entity&#xBB;DaoImpl</code> that extends <code>ApplicationDaoImpl</code> and implements your <code>&#xAB;Entity&#xBB;Dao</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyEntityDaoImpl extends ApplicationDaoImpl&lt;MyEntity&gt; implements MyEntityDao {

  public List&lt;MyEntity&gt; findByCriteria(MyEntitySearchCriteria criteria) {
    TypedQuery&lt;MyEntity&gt; query = createQuery(criteria, getEntityManager());
    return query.getResultList();
  }
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again you only need to implement the additional non-CRUD methods that you have declared in your <code>&#xAB;Entity&#xBB;Dao</code> interface.
In the DAO implementation you can use the method <code>getEntityManager()</code> to access the <code>EntityManager</code> from the JPA. You will need the <code>EntityManager</code> to create and execute <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc">queries</a>.</p>
</div>
<div class="sect5">
<h6 id="guide-dao.asciidoc_static-queries-for-dao-implementation">Static queries for DAO Implementation</h6>
<div class="paragraph">
<p>All static <a href="master-devon4j.asciidoc_guides.html#guide-jpa-query.asciidoc">queries</a> are declared in the file <code>src\main\resources\META-INF\orm.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;entity-mappings version=&quot;1.0&quot; xmlns=&quot;http://java.sun.com/xml/ns/persistence/orm&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/persistence/orm http://java.sun.com/xml/ns/persistence/orm_1_0.xsd&quot;&gt;
  &lt;named-query name=&quot;find.dish.with.max.price&quot;&gt;
    &lt;query&gt;&lt;![SELECT dish FROM DishEntity dish WHERE dish.price &lt;= :maxPrice]]&gt;&lt;/query&gt;
  &lt;/named-query&gt;
  ...
&lt;/hibernate-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When your application is started, all these static queries will be created as prepared statements. This allows better performance and also ensures that you get errors for invalid JPQL queries when you start your app rather than later when the query is used.</p>
</div>
<div class="paragraph">
<p>To avoid redundant occurrences of the query name (<code>get.open.order.positions.for.order</code>) we define a constant for each named query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class NamedQueries {
  public static final String FIND_DISH_WITH_MAX_PRICE = &quot;find.dish.with.max.price&quot;;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that changing the name of the java constant (<code>FIND_DISH_WITH_MAX_PRICE</code>) can be done easily with refactoring. Further you can trace where the query is used by searching the references of the constant.</p>
</div>
<div class="paragraph">
<p>The following listing shows how to use this query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public List&lt;DishEntity&gt; findDishByMaxPrice(BigDecimal maxPrice) {
  Query query = getEntityManager().createNamedQuery(NamedQueries.FIND_DISH_WITH_MAX_PRICE);
  query.setParameter(&quot;maxPrice&quot;, maxPrice);
  return query.getResultList();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Via <code>EntityManager.createNamedQuery(String)</code> we create an instance of <code>Query</code> for our predefined static query.
Next we use <code>setParameter(String, Object)</code> to provide a parameter (<code>maxPrice</code>) to the query. This has to be done for all parameters of the query.</p>
</div>
<div class="paragraph">
<p>Note that using the <code>createQuery(String)</code> method, which takes the entire query as string (that may already contain the parameter) is not allowed to avoid SQL injection vulnerabilities.
When the method <code>getResultList()</code> is invoked, the query is executed and the result is delivered as <code>List</code>. As an alternative, there is a method called <code>getSingleResult()</code>, which returns the entity if the query returned exactly one and throws an exception otherwise.</p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-jpa-performance.asciidoc">9.3.14. JPA Performance</h4>
<div class="paragraph">
<p>When using JPA the developer sometimes does not see or understand where and when statements to the database are triggered.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Establishing expectations Developers shouldn&#x2019;t expect to sprinkle magic pixie dust on POJOs in hopes they will become persistent.</p>
</div>
</blockquote>
<div class="attribution">
&#x2014; Dan Allen<br>
<cite>https://epdf.tips/seam-in-action.html</cite>
</div>
</div>
<div class="paragraph">
<p>So in case you do not understand what is going on under the hood of JPA, you will easily run into performance issues due to lazy loading and other effects.</p>
</div>
<div class="sect4">
<h5 id="guide-jpa-performance.asciidoc_n-plus-1-problem">N plus 1 Problem</h5>
<div class="paragraph">
<p>The most prominent phenomena is call the <em>N+1 Problem</em>.
We use entities from our <a href="https://github.com/devonfw/my-thai-star">MTS</a> demo app as an example to explain the problem.
There is a <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/dishmanagement/dataaccess/api/DishEntity.java">DishEntity</a> that has a <code>@ManyToMany</code> relation to
<a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/dishmanagement/dataaccess/api/IngredientEntity.java">IngredientEntity</a>.
Now we assume that we want to iterate all ingredients for a dish like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">DishEntity dish = dao.findDishById(dishId);
BigDecimal priceWithAllExtras = dish.getPrice();
for (IngredientEntity ingredient : dish.getExtras()) {
  priceWithAllExtras = priceWithAllExtras.add(ingredient.getPrice());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now <code>dish.getExtras()</code> is loaded lazy. Therefore the JPA vendor will provide a list with lazy initialized instances of <code>IngredientEntity</code> that only contain the ID of that entity. Now with every call of <code>ingredient.getPrice()</code> we technically trigger an SQL query statement to load the specific <code>IngredientEntity</code> by its ID from the database.
Now <code>findDishById</code> caused 1 initial query statement and for any number <code>N</code> of ingredients we are causing an additional query statement. This makes a total of <code>N+1</code> statements. As causing statements to the database is an expensive operation with a lot of overhead (creating connection, etc.) this ends in bad performance and is therefore a problem (the N+1 Problem).</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-jpa-performance.asciidoc_solving-n-plus-1-problem">Solving N plus 1 Problem</h5>
<div class="paragraph">
<p>To solve the N+1 Problem you need to change your code to only trigger a single statement instead. This can be archived in various ways. The most universal solution is to use <code>FETCH JOIN`s in order to pre-load the nested `N</code> child entities into the first level cache of the JPA vendor implementation. This will behave as if the <code>@ManyToMany</code> relation to <code>IngredientEntity</code> was having <code>FetchType.EAGER</code> but only for the that specific query and not in general. Because changing <code>@ManyToMany</code> to <code>FetchType.EAGER</code> would cause bad performance for other usecases where only the dish but not its extra ingredients are needed. For this reason all relations, including <code>@OneToOne</code> should always be <code>FetchType.LAZY</code>. Back to our example we simply replace <code>dao.findDishById(dishId)</code> with <code>dao.findDishWithExtrasById(dishId)</code> that we implement by the following JPQL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT dish FROM DishEntity dish
  LEFT JOIN FETCH dish.extras
  WHERE dish.id = :dishId</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rest of the code does not have to be changed but now <code>dish.getExtras()</code> will get the <code>IngredientEntity</code> from the first level cache where is was fetched by the initial query above.</p>
</div>
<div class="paragraph">
<p>Please note that if you only need the sum of the prices from the extras you can also create a query using an aggregator function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT sum(dish.extras.price) FROM DishEntity dish</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see you need to understand the concepts in order to get good performance.</p>
</div>
<div class="paragraph">
<p>There are many advanced topics such as creating database indexes or calculating statistics for the query optimizer to get the best performance. For such advanced topics we recommend to have a database expert in your team that cares about such things. However, understanding the <em>N+1 Problem</em> and its solutions is something that every Java developer in the team needs to understand.</p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-auditing.asciidoc">9.4. Auditing</h3>
<div class="paragraph">
<p>For database auditing we use <a href="http://envers.jboss.org/">hibernate envers</a>. If you want to use auditing ensure you have the following dependency in your pom.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.devonfw.java.modules&lt;/groupId&gt;
  &lt;artifactId&gt;devon4j-jpa-envers&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure that entity manager also scans the package from the devon4j-jpa[-envers] module in order to work properly. And make sure that correct Repository Factory Bean Class is chosen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@EntityScan(basePackages = { &quot;&#xAB;my.base.package&#xBB;&quot; }, basePackageClasses = { AdvancedRevisionEntity.class })
...
@EnableJpaRepositories(repositoryFactoryBeanClass = GenericRevisionedRepositoryFactoryBean.class)
...
public class SpringBootApp {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let your [Entity]Repository extend from DefaultRevisionedRepository instead of DefaultRepository.</p>
</div>
<div class="paragraph">
<p>The repository now has a method getRevisionHistoryMetadata(id) and getRevisionHistoryMetadata(id, boolean lazy) available to get a list of revisions for a given entity and a method find(id, revision) to load a specific revision of an entity with the given ID or getLastRevisionHistoryMetadata(id) to load last revision.
To enable auditing for a entity simply place the @Audited annotation to your entity and all entity classes it extends from.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Entity(name = &quot;Drink&quot;)
@Audited
public class DrinkEntity extends ProductEntity implements Drink {
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>When auditing is enabled for an entity an additional database table is used to store all changes to the entity table and a corresponding revision number. This table is called &lt;ENTITY_NAME&gt;_AUD per default. Another table called REVINFO is used to store all revisions. Make sure that these tables are available. They can be generated by hibernate with the following property (only for development environments).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">  database.hibernate.hbm2ddl.auto=create</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another possibility is to put them in your <a href="master-devon4j.asciidoc_guides.html#guide-database-migration.asciidoc">database migration</a> scripts like so.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE CACHED TABLE PUBLIC.REVINFO(
  id BIGINT NOT NULL generated by default as identity (start with 1),
  timestamp BIGINT NOT NULL,
  user VARCHAR(255)
);
...
CREATE CACHED TABLE PUBLIC.&lt;TABLE_NAME&gt;_AUD(
    &lt;ALL_TABLE_ATTRIBUTES&gt;,
    revtype TINYINT,
    rev BIGINT NOT NULL
);</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
<div class="sect2">
<h3 id="guide-transactions.asciidoc">9.5. Transaction Handling</h3>
<div class="paragraph">
<p>Transactions are technically processed by the <a href="master-devon4j.asciidoc_layers.html#guide-dataaccess-layer.asciidoc">data access layer</a>. However, the transaction control has to be performed in upper layers. To avoid dependencies on persistence layer and technical code in upper layers, we use <a href="master-devon4j.asciidoc_guides.html#guide-aop.asciidoc">AOP</a> to add transaction control via annotations as aspect.</p>
</div>
<div class="paragraph">
<p>We recommend using the <code>@Transactional</code> annotation (the JEE standard <code>javax.transaction.Transactional</code> rather than <code>org.springframework.transaction.annotation.Transactional</code>). We use this annotation in the <a href="master-devon4j.asciidoc_layers.html#guide-logic-layer.asciidoc">logic layer</a> to annotate business methods that participate in transactions (what typically applies to most up to all business components):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @Transactional
  public MyDataTo getData(MyCriteriaTo criteria) {
    ...
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case a <a href="master-devon4j.asciidoc_layers.html#guide-service-layer.asciidoc">service operation</a> should invoke multiple use-cases, you would end up with multiple transactions what is undesired (what if the first TX succeeds and then the second TX fails?). Therefore you would then also annotate the service operation. This is not proposed as a pattern in any case as in some rare cases you need to handle constraint-violations from the database to create a specific business exception (with specified message). In such case you have to surround the transaction with a <code>try {} catch</code> statement what is not working if that method itself is <code>@Transactional</code>.</p>
</div>
<div class="sect3">
<h4 id="guide-transactions.asciidoc_batches">9.5.1. Batches</h4>
<div class="paragraph">
<p>Transaction control for batches is a lot more complicated and is described in the <a href="master-devon4j.asciidoc_layers.html#guide-batch-layer.asciidoc">batch layer</a>.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-sql.asciidoc">9.6. SQL</h3>
<div class="paragraph">
<p>For general guides on dealing or avoiding SQL, preventing SQL-injection, etc. you should study <a href="master-devon4j.asciidoc_layers.html#guide-dataaccess-layer.asciidoc">data-access layer</a>.</p>
</div>
<div class="sect3">
<h4 id="guide-sql.asciidoc_naming-conventions">9.6.1. Naming Conventions</h4>
<div class="paragraph">
<p>Here we define naming conventions that you should follow whenever you write SQL files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All SQL-Keywords in UPPER CASE</p>
</li>
<li>
<p>Table names in upper CamelCase (e.g. <code>RestaurantOrder</code>)</p>
</li>
<li>
<p>Column names in CamelCase (e.g. <code>drinkState</code>)</p>
</li>
<li>
<p>Indentation should be 2 spaces as suggested by devonfw for every format.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="guide-sql.asciidoc_ddl">DDL</h5>
<div class="paragraph">
<p>For DDLs follow these additional guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ID column names without underscore (e.g. <code>tableId</code>)</p>
</li>
<li>
<p>Define columns and constraints inline in the statement to create the table</p>
</li>
<li>
<p>Indent column types so they all start in the same text column</p>
</li>
<li>
<p>Constraints should be named explicitly (to get a reasonable hint error messages) with:</p>
<div class="ulist">
<ul>
<li>
<p><code>PK_{table}</code> for primary key (name optional here as PK constraint are fundamental)</p>
</li>
<li>
<p><code>FK_{table}_{property}</code> for foreign keys (<code>{table}</code> and <code>{property}</code> are both on the source where the foreign key is defined)</p>
</li>
<li>
<p><code>UC_{table}_{property}[_{propertyN}]*</code> for unique constraints</p>
</li>
<li>
<p><code>CK_{table}_{check}</code> for check constraints (<code>{check}</code> describes the check, if it is defined on a single property it should start with the property).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Databases have hard limitations for names (e.g. 30 characters). If you have to shorten names try to define common abbreviations in your project for according (business) terms. Especially do not just truncate the names at the limit.</p>
</li>
<li>
<p>If possible add comments on table and columns to help DBAs understanding your schema. This is also honored by many tools (not only DBA-tools).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a brief example of a DDL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE SEQUENCE HIBERNATE_SEQUENCE START WITH 1000000;

-- *** Table ***
CREATE TABLE Table (
  id BIGINT NOT NULL AUTO_INCREMENT,
  modificationCounter INTEGER NOT NULL,
  seatsNumber INTEGER NOT NULL,
  CONSTRAINT PK_Table PRIMARY KEY(id)
);

-- *** UserRole ***
CREATE TABLE UserRole (
  id BIGINT NOT NULL AUTO_INCREMENT,
  modificationCounter INTEGER NOT NULL,
  name VARCHAR (255),
  active BOOLEAN,
  CONSTRAINT PK_UserRole PRIMARY KEY(id)
-- *** User ***
CREATE TABLE User (
  id BIGINT NOT NULL AUTO_INCREMENT,
  modificationCounter INTEGER NOT NULL,
  username VARCHAR (255) NULL,
  password VARCHAR (255) NULL,
  email VARCHAR (120) NULL,
  idRole BIGINT NOT NULL,
  CONSTRAINT PK_User PRIMARY KEY(id),
  CONSTRAINT PK_User_idRole FOREIGN KEY(idRole) REFERENCES UserRole(id) NOCHECK
);
COMMENT ON TABLE User is &apos;The users of the restaurant site&apos;;
...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-sql.asciidoc_data">Data</h5>
<div class="paragraph">
<p>For insert, update, delete, etc. of data SQL scripts should additionally follow these guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inserts always with the same order of columns in blocks for each table.</p>
</li>
<li>
<p>Insert column values always starting with id, modificationCounter, [dtype, ] &#x2026;&#x200B;</p>
</li>
<li>
<p>List columns with fixed length values (boolean, number, enums, etc.) before columns with free text to support alignment of multiple insert statements</p>
</li>
<li>
<p>Pro Tip: Get familiar with column mode of <code>notepad++</code> when editing large blocks of similar insert statements.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>INSERT INTO UserRole(id, modificationCounter, name, active) VALUES (0, 1, &apos;Customer&apos;, true);
INSERT INTO UserRole(id, modificationCounter, name, active) VALUES (1, 1, &apos;Waiter&apos;, true);
INSERT INTO User(id, modificationCounter, username, password, email, idRole) VALUES (0, 1, &apos;user0&apos;, &apos;password&apos;, &apos;user0@mail.com&apos;, 0);
INSERT INTO User(id, modificationCounter, username, password, email, idRole) VALUES (1, 1, &apos;waiter&apos;, &apos;waiter&apos;, &apos;waiter@mail.com&apos;, 1);

INSERT INTO Table(id, modificationCounter, seatsNumber) VALUES (0, 1, 4);
INSERT INTO Table(id, modificationCounter, seatsNumber) VALUES (1, 1, 4);
INSERT INTO Table(id, modificationCounter, seatsNumber) VALUES (2, 1, 4);
INSERT INTO Table(id, modificationCounter, seatsNumber) VALUES (3, 1, 4);
INSERT INTO Table(id, modificationCounter, seatsNumber) VALUES (4, 1, 6);
INSERT INTO Table(id, modificationCounter, seatsNumber) VALUES (5, 1, 6);
INSERT INTO Table(id, modificationCounter, seatsNumber) VALUES (6, 1, 6);
INSERT INTO Table(id, modificationCounter, seatsNumber) VALUES (7, 1, 8);
INSERT INTO Table(id, modificationCounter, seatsNumber) VALUES (8, 1, 8);
...</pre>
</div>
</div>
<div class="paragraph">
<p>See also <a href="master-devon4j.asciidoc_guides.html#guide-database-migration.asciidoc">Database Migrations</a>.</p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-database-migration.asciidoc">9.7. Database Migration</h3>
<div class="paragraph">
<p>For database migrations we use <a href="http://flywaydb.org/">Flyway</a>.
As illustrated <a href="https://flywaydb.org/getstarted/why">here</a> database migrations have three advantages:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Recreate a database from scratch</p>
</li>
<li>
<p>Make it clear at all times what state a database is in</p>
</li>
<li>
<p>Migrate in a deterministic way from your current version of the database to a newer one</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Flyway can be used standalone or can be integrated via its <a href="https://flywaydb.org/documentation/api/javadoc/index.html?org/flywaydb/core/Flyway.html">API</a> to make sure the database migration takes place on startup.</p>
</div>
<div class="sect3">
<h4 id="guide-database-migration.asciidoc_organizational-advice">9.7.1. Organizational Advice</h4>
<div class="paragraph">
<p>A few considerations with respect to project organization will help to implement maintainable Flyway migrations.</p>
</div>
<div class="paragraph">
<p>At first, testing and production environments must be clearly and consistently distinguished. Use the following directory structure to achieve this distinction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">  src/main/resources/db
  src/test/resources/db</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although this structure introduces redundancies, the benefit outweighs this disadvantage.
An even more fine-grained production directory structure which contains one sub folder per release should be implemented:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">  src/main/resources/db/migration/releases/X.Y/x.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Emphasizing that migration scripts below the current version must never be changed will aid the second advantage of migrations: it will always be clearly reproducible in which state the database currently is.
Here, it is important to mention that, if test data is required, it must be managed separately from the migration data in the following directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">  src/test/resources/db/migration/</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>migration</code> directory is added to aid easy usage of Flyway defaults.
Of course, test data should also be managed per release as like production data.</p>
</div>
<div class="paragraph">
<p>With regard to content, separation of concerns (SoC) is an important goal. SoC can be achieved by distinguishing and writing multiple scripts with respect to business components/use cases (or database tables in case of large volumes of master data <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>. Comprehensible file names aid this separation.</p>
</div>
<div class="paragraph">
<p>It is important to have clear responsibilities regarding the database, the persistence layer (JPA), and migrations. Therefore a dedicated database expert should be in charge of any migrations performed or she should at least be informed before any change to any of the mentioned parts is applied.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-database-migration.asciidoc_technical-configuration">9.7.2. Technical Configuration</h4>
<div class="paragraph">
<p>Database migrations can be <a href="http://flywaydb.org/documentation/migration/sql.html">SQL</a> based or <a href="http://flywaydb.org/documentation/migration/java.html">Java</a> based.</p>
</div>
<div class="paragraph">
<p>To enable auto migration on startup (not recommended for productive environment) set the following property in the <code>application.properties</code> file for an environment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">flyway.enabled=true
flyway.clean-on-validation-error=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>For development environment it is helpful to set both properties to <code>true</code> in order to simplify development. For regular environments <code>flyway.clean-on-validation-error</code> should be <code>false</code>.</p>
</div>
<div class="paragraph">
<p>If you want to use Flyway set the following property in any case to prevent Hibernate from doing changes on the database (pre-configured by default in devonfw):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">spring.jpa.hibernate.ddl-auto=validate</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting must be communicated to and coordinated with the customer and their needs.
In acceptance testing the same configuration as for the production environment should be enabled.</p>
</div>
<div class="paragraph">
<p>Since migration scripts will also be versioned the end-of-line (EOL) style must be fixated according to <a href="https://github.com/flyway/flyway/issues/253">this issue</a>. This is however solved in flyway 4.0+ and the latest devonfw release.
Also, the version numbers of migration scripts should not consist of simple ascending integer numbers like V0001<em>&#x2026;&#x200B;, V0002</em>&#x2026;&#x200B;, &#x2026;&#x200B; This naming may lead to problems when merging branches. Instead the usage of timestamps as version numbers will help to avoid such problems.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-database-migration.asciidoc_naming-conventions">9.7.3. Naming Conventions</h4>
<div class="paragraph">
<p>Database migrations should follow this naming convention:
V&lt;version&gt;__&lt;description&gt; (e.g.: V12345__Add_new_table.sql).</p>
</div>
<div class="paragraph">
<p>It is also possible to use Flyway for test data. To do so place your test data migrations in src/main/resources/db/testdata/ and set property</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">flyway.locations=classpath:db/migration/releases,classpath:db/migration/testdata</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then Flyway scans the additional location for migrations and applies all in the order specified by their version. If migrations V0001__... and V0002__... exist and a test data migration should be applied in between you can name it V0001_1__....</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-hana.asciidoc">9.8. SAP HANA</h3>
<div class="paragraph">
<p>This section contains hints for those who use <a href="https://www.sap.com/products/hana.html">SAP HANA</a>, a very powerful and fast RDBMS. If you have chosen a different persistence technology on purpose you can simply ignore this guide. Besides general hints about the driver there are tips for more tight integration with other SAP features or products.</p>
</div>
<div class="sect3">
<h4 id="guide-hana.asciidoc_driver">9.8.1. Driver</h4>
<div class="paragraph">
<p>The hana JDBC driver is available in Maven Central what makes your life very easy. All you need is the following maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
  &lt;groupId&gt;com.sap.cloud.db.jdbc&lt;/groupId&gt;
  &lt;artifactId&gt;ngdbc&lt;/artifactId&gt;
  &lt;version&gt;${hana.driver.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The variable <code>hana.driver.version</code> may be <code>2.3.55</code>, but check yourself at <a href="http://central.maven.org/maven2/com/sap/cloud/db/jdbc/ngdbc/" class="bare">http://central.maven.org/maven2/com/sap/cloud/db/jdbc/ngdbc/</a> for the proper or most recent version.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-hana.asciidoc_developer-usage">9.8.2. Developer Usage</h4>
<div class="paragraph">
<p>For your local development environment you will love the free <a href="https://developers.sap.com/topics/sap-hana-express.html">SAP HANA, Express Edition</a>.</p>
</div>
<div class="paragraph">
<p>You can run HANA in several ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On-premise</p>
<div class="ulist">
<ul>
<li>
<p>Via a <a href="https://developers.sap.com/germany/tutorials/hxe-ua-install-using-docker.html">Docker image</a> (Linux only)</p>
</li>
<li>
<p>Via a pre-configured <a href="https://developers.sap.com/group.hxe-install-vm.html">virtual machine</a> (Windows, Linux, OS X)</p>
</li>
<li>
<p>Installed natively on your <a href="https://developers.sap.com/group.hxe-install-binary.html">local machine</a> (Linux only)</p>
</li>
</ul>
</div>
</li>
<li>
<p>In the cloud</p>
<div class="ulist">
<ul>
<li>
<p>Via a pre-configured machine on the <a href="https://developers.sap.com/tutorials/hxe-gcp-getting-started-launcher.html">Google Cloud Platform</a></p>
</li>
<li>
<p>Via a pre-configured machine in the <a href="https://developers.sap.com/tutorials/hxe-ms-azure-marketplace-getting-started.html">Microsoft Azure Cloud</a></p>
</li>
<li>
<p>Via a pre-configured machine on <a href="https://developers.sap.com/tutorials/hxe-aws-setup.html">Amazon Web Services</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>To get started with SAP HANA, Express Edition you can check out the <a href="https://developers.sap.com/topics/sap-hana-express.html#tutorials">tutorials</a> at the <a href="https://developers.sap.com/">SAP Developer Center</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-hana.asciidoc_pooling">9.8.3. Pooling</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-hana.asciidoc_fuzzy-search">9.8.4. Fuzzy Search</h4>
<div class="paragraph">
<p>See <a href="https://blogs.sap.com/2015/08/28/dynamism-of-fuzzy-search-in-sap-hana/" class="bare">https://blogs.sap.com/2015/08/28/dynamism-of-fuzzy-search-in-sap-hana/</a> or the <a href="https://help.sap.com/viewer/691cb949c1034198800afde3e5be6570/latest/en-US/cc602780bb5710148aa2bf6cab3c015b.html">SAP HANA Search Developer Guide</a></p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-oracle.asciidoc">9.9. Oracle RDBMS</h3>
<div class="paragraph">
<p>This section contains hints for those who use Oracle RDBMS. If you use a different persistence technology you can simply ignore it. Besides general hints about the driver there are tips for more tight integration with other Oracle features or products. However, if you work for a project where Oracle RDBMS is settled and not going to be replaced (you are in a vendor lock-in anyway), you might want to use even more from Oracle technology to take advantage from a closer integration.</p>
</div>
<div class="sect3">
<h4 id="guide-oracle.asciidoc_xe">9.9.1. XE</h4>
<div class="paragraph">
<p>For local development you should setup Oracle XE (eXpress Edition).
You need an oracle account, then you can download it from <a href="https://www.oracle.com/technetwork/database/database-technologies/express-edition/downloads/index.html">here</a>.</p>
</div>
<div class="paragraph">
<p>The most comfortable way to run it as needed is using docker. You can build your own docker image from the downloaded RPM using the <a href="https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance">instructions and dockerfile from oracle</a>. (In case the build of the docker-image <a href="https://github.com/oracle/docker-images/issues/1133">fails reproducibly</a> and you want to give up with the Dockerfiles from Oracle you can also try this inofficial <a href="https://github.com/fuzziebrain/docker-oracle-xe">docker-oracle-xe</a> solution).</p>
</div>
<div class="paragraph">
<p>To connect to your local XE database you need to use <code>xe</code> as the <code>SID</code> of your main database that can not be changed. The <code>hostname</code> should be <code>localhost</code> and the <code>port</code> is by default <code>1521</code> if you did not remap it with docker to something else. However, starting with XE 18c you need to be aware that oracle introduced a <a href="https://docs.oracle.com/database/121/CNCPT/cdbovrvw.htm">multi-tenant architecture</a>. Hence <code>xe</code> refers to the root <code>CDB</code> while you typically want to connect to the <code>PDB</code> (pluggable database) and XE ships with exactly one of this called <code>xepdb1</code>. To connect with <code>SQL Developer</code> switch <code>Connection Type</code> from <code>Basic</code> to <code>Advanced</code> and enter the <code>Custom JDBC URL</code> like e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>jdbc:oracle:thin:@//localhost:1521/xepdb1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same way you can also connect from your devon4j app via JDBC.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-oracle.asciidoc_driver">9.9.2. Driver</h4>
<div class="paragraph">
<p>The oracle JDBC driver is not available in maven central. Depending on the Oracle DB version and the Java version, you can use either the 11g/ojdbc6, 12c/ojdbc7, or 12c/ojdbc8 version of the driver. Oracle JDBC drivers usually are backward and forward compatible so you should be able to use the 12c/ojdbc8 driver with an 11g DB etc. As a rule of thumb, use the 12c/ojdbc8 driver unless you must use Java7. All JDBC drivers can be downloaded without registration: <a href="http://www.oracle.com/technetwork/database/enterprise-edition/jdbc-112010-090769.html">11g/ojdbc6</a>, <a href="http://www.oracle.com/technetwork/database/features/jdbc/jdbc-drivers-12c-download-1958347.html">12c/ojdbc7</a>, and <a href="http://www.oracle.com/technetwork/database/features/jdbc/jdbc-ucp-122-3110062.html">12c/ojdbc8</a>. Your project should use a maven repository server such as <a href="http://www.sonatype.org/nexus/">nexus</a> or <a href="https://www.jfrog.com/open-source/">artifactory</a>.
Your dependency for the oracle driver should look as follows (use artifactId &quot;ojdbc6&quot; or &quot;ojdbc7&quot; for the older drivers):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
  &lt;groupId&gt;com.oracle&lt;/groupId&gt;
  &lt;artifactId&gt;ojdbc8&lt;/artifactId&gt;
  &lt;version&gt;${oracle.driver.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>oracle.driver.version being 11.2.0.4 for 11g/ojdbc6, or 12.1.0.1 for 12c/ojdbc7, or 12.2.0.1 for 12c/ojdbc8 or newer</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-oracle.asciidoc_pooling">9.9.3. Pooling</h4>
<div class="paragraph">
<p>In order to boost performance JDBC connections should be pooled and reused. If you are using Oracle RDBMS and do not plan to change that you can use the Oracle specific connection pool &quot;Universal Connection Pool (UCP)&quot; that is perfectly integrated with the Oracle driver. According to the documentation, UCP can even be used to <a href="https://docs.oracle.com/database/122/JJUCP/third-party-integration.htm#JJUCP8141">manage third party data sources</a>. The 11g version of UCP can be downloaded without registration <a href="http://www.oracle.com/technetwork/database/enterprise-edition/downloads/ucp-112010-099129.html">here</a>, the 12c version of UCP is available at the same download locations as the 12c JDBC driver (see above). As a rule of thumb, use the version that is the same as the JDBC driver version.
Again, you have to upload the artefact manually to your maven repository. The dependency should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
  &lt;groupId&gt;com.oracle&lt;/groupId&gt;
  &lt;artifactId&gt;ucp&lt;/artifactId&gt;
  &lt;version&gt;${oracle.ucp.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>with oracle.ucp.version being 11.2.0.4 or 12.2.0.1 or newer.</p>
</div>
<div class="paragraph">
<p>Configuration is done via application.properties like this (example):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>#Oracle UCP
# Datasource for accessing the database
spring.datasource.url=jdbc:oracle:thin:@192.168.58.2:1521:xe
spring.jpa.database-platform=org.hibernate.dialect.Oracle12cDialect
spring.datasource.user=MyUser
spring.datasource.password=ThisIsMyPassword
spring.datasource.driver-class-name=oracle.jdbc.OracleDriver
spring.datasource.schema=MySchema

spring.datasource.type=oracle.ucp.jdbc.PoolDataSourceImpl
spring.datasource.factory=oracle.ucp.jdbc.PoolDataSourceFactory
spring.datasource.factory-method=getPoolDataSource
spring.datasource.connectionFactoryClassName=oracle.jdbc.pool.OracleDataSource
spring.datasource.validateConnectionOnBorrow=true
spring.datasource.connectionPoolName=MyPool
spring.datasource.jmx-enabled=true

# Optional: Set the log level to INTERNAL_ERROR, SEVERE, WARNING, INFO, CONFIG, FINE, TRACE_10, FINER, TRACE_20, TRACE_30, or FINEST
# logging.level.oracle.ucp=INTERNAL_ERROR
# Optional: activate tracing
# logging.level.oracle.ucp.jdbc.oracle.OracleUniversalPooledConnection=TRACE

#Optional: Configures pool size manually
#spring.datasource.minPoolSize=10
#spring.datasource.maxPoolSize=40
#spring.datasource.initialPoolSize=20</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resources: <a href="http://www.oracle.com/technetwork/database/application-development/default-2248812.html">FAQ</a>, <a href="https://docs.oracle.com/database/122/JJUCP/toc.htm">developer&#x2019;s guide</a>, <a href="https://docs.oracle.com/database/122/JJUAR/toc.htm">Java API Reference</a>. For an in-depth discussion on how to use JDBC and UCP, see the Oracle documentation <a href="http://www.oracle.com/technetwork/database/application-development/jdbc-ucp-conn-mgmt-strategies-3045654.pdf">Connection Management Strategies for Java Applications using JDBC and UCP</a>.</p>
</div>
<div class="paragraph">
<p>Note: there is a bug in UCP 12.1.0.2 that results in the creation of thousands of java.lang.Timer threads over hours or days of system uptime (see <a href="https://stackoverflow.com/questions/37245827/too-many-ucp-timer-threads">article on stackoverflow</a>). Also, Oracle has a strange bug fixing / patching policy: instead of producing a fixed version 12.1.0.3 or 12.1.0.2.x, Oracle publishes collections of *.class files that must be manually patched into the ucp.jar! Therefore, use the newest versions only.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-oracle.asciidoc_messaging">9.9.4. Messaging</h4>
<div class="paragraph">
<p>In case you want to do messaging based on JMS you might consider the <a href="https://docs.oracle.com/cd/E11882_01/server.112/e11013/aq_intro.htm">Oracle JMS</a> also called Oracle Streams Advanced Queuing, or Oracle Advanced Queuing, or OAQ or AQ for short. OAQ is a JMS provider based on the Oracle RDBMS and included in the DB product for no extra fee. OAQ has some features that exceed the JMS standard like a retention time (i.e. a built-in backup mechanism that allows to make messages &quot;unread&quot; within a configurable period of time so that these messages do not have to be resent by the sending application). Also, OAQ messages are stored in relational tables so they can easily be observed by a test driver in a system test scenario.
Capgemini has used the <a href="https://projects.spring.io/spring-data-jdbc-ext/">Spring Data JDBC Extension</a> in order to process OAQ messages within <strong>the same technical transaction</strong> as the resulting Oracle RDBMS data changes <strong>without</strong> using 2PC and an XA-compliant transaction manager - which is not available out of the box in Tomcat. This is possible only due to the fact that OAQ queues and RDBMS tables actually reside in the same database. However, this is higher magic and should only be tried if high transaction rates must be achieved by avoiding 2PC.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-oracle.asciidoc_general-notes-on-the-use-of-oracle-products">9.9.5. General Notes on the use of Oracle products</h4>
<div class="paragraph">
<p>Oracle sells commercial products and receives licence fees for them. This includes access to a support organization. Therefore, at an early stage of your project, prepare for contacting <a href="https://support.oracle.com">oracle support</a> in case of technical problems. You will need the Oracle support ID <strong>of your customer</strong> [i.e. the legal entity who pays the licence fee and runs the RDBMS] and your customer must grant you permission to use it in a service request - it is not legal to use a your own support ID in a customer-related project. Your customer pays for that service anyway, so use it in case of a problem!</p>
</div>
<div class="paragraph">
<p>Software components like the JDBC driver or the UCP may be available without a registration or fee but they are protected by the Oracle Technology Network (OTN) License Agreement. The most important aspect of this licence agreement is the fact that an IT service provider is not allowed to simply download the Oracle software component, bundle it in a software artefact and deliver it to the customer. Instead, the Oracle software component must be (from a legal point of view) provided by the owner of the Oracle DB licence (i.e. your customer). This can be achieved in two ways: Advise your customer to install the Oracle software component in the application server as a library that can be used by your custom built system. Or, in cases where this is not feasible, e.g. in a OpenShift environment where the IT service provider delivers complete Docker images, you must advise your customer to (legally, i.e. documented in a written form) provide the Oracle software component to you, i.e. you don&#x2019;t download the software component from the Oracle site but receive it from your customer.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-jee.asciidoc">9.10. JEE</h3>
<div class="paragraph">
<p>This section is about Java Enterprise Edition (JEE). Regarding to our <a href="architecture.html#key-principles">key principles</a> we focus on open standards. For Java this means that we consider official standards from Java Standard and Enterprise Edition as first choice for considerations. Therefore we also decided to recommend <a href="guide-rest.html#jax-rs">JAX-RS</a> over <a href="https://spring.io/guides/gs/rest-service/">SpringMVC</a> as the latter is proprietary. Only if an existing Java standard is <strong>not</strong> suitable for current demands such as Java Server Faces (JSF), we do not officially recommend it (while you are still free to use it if you have good reasons to do so). In all other cases we officially suggest the according standard and use it in our guides, code-samples, sample application, modules, templates, etc. Examples for such standards are <a href="master-devon4j.asciidoc_guides.html#guide-jpa.asciidoc">JPA</a>, <a href="guide-rest.html#jax-rs">JAX-RS</a>, <a href="guide-soap.html#jax-ws">JAX-WS</a>, <a href="master-devon4j.asciidoc_guides.html#guide-dependency-injection.asciidoc">JSR330</a>, <a href="master-devon4j.asciidoc_guides.html#guide-access-control.asciidoc">JSR250</a>, <a href="guide-xml.html#jaxb">JAX-B</a>, etc.</p>
</div>
<div class="sect3">
<h4 id="guide-jee.asciidoc_application-server">9.10.1. Application-Server</h4>
<div class="paragraph">
<p>We designed everything based on standards to work with different technology stacks and servlet containers. However, we strongly encourage to use <a href="https://spring.io/">spring</a> and <a href="http://projects.spring.io/spring-boot/">spring-boot</a>. You are free to decide for something else but here is a list of good reasons for our decision:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Up-to-date</strong></p>
<div class="paragraph">
<p>With spring you easily keep up to date with evolving technologies (microservices, reactive, NoSQL, etc.). Most application servers put you in a jail with old legacy technology. In many cases you are even forced to use a totally outdated version of java (JVM/JDK). This may even cause severe IT-Security vulnerabilities but with expensive support you might get updates. Also with spring and open-source you need to be aware that for IT-security you need to update recently what can cost quite a lot of additional maintenance effort.</p>
</div>
</li>
<li>
<p><strong>Development speed</strong></p>
<div class="paragraph">
<p>With spring-boot you can implement and especially test your individual logic very fast. Starting the app in your IDE is very easy, fast, and realistic (close to production). You can easily write JUnit tests that startup your server application to e.g. test calls to your remote services via HTTP fast and easy. For application servers you need to bundle and deploy your app what takes more time and limits you in various ways. We are aware that this has improved in the past but also spring continuously improves and is always way ahead in this area. Further, with spring you have your configurations bundled together with the code in version control (still with ability to handle different environments) while with application servers these are configured externally and can not be easily tested during development.</p>
</div>
</li>
<li>
<p><strong>Documentation</strong></p>
<div class="paragraph">
<p>Spring has an extremely open and active community. There is documentation for everything available for free on the web. You will find solutions to almost any problem on platforms like stackoverflow. If you have a problem you are only a google search away from your solution. This is very much different for proprietary application server products.</p>
</div>
</li>
<li>
<p><strong>Helpful Exception Messages</strong></p>
<div class="paragraph">
<p>Spring is really great for developers on exception messages. If you do something wrong you get detailed and helpful messages that guide you to the problem or even the solution. This is not as great in application servers.</p>
</div>
</li>
<li>
<p><strong>Future-proof</strong></p>
<div class="paragraph">
<p>Spring has evolved really awesome over time. Since its 1.0 release in 2004 spring has continuously been improved and always caught up with important trends and innovations. Even in critical situations, when the company behind it (interface21) was sold, spring went on perfectly.
JEE went through a lot of trouble and crisis. Just look at the EJB pain stories. This happened often in the past and also recent. See <a href="https://dzone.com/articles/java-ee-8-in-crisis">JEE 8 in crisis</a>.</p>
</div>
</li>
<li>
<p><strong>Free</strong></p>
<div class="paragraph">
<p>Spring and its ecosystem is free and open-source. It still perfectly integrates with commercial solutions for specific needs. Most application servers are commercial and cost a lot of money. As of today the ROI for this is of question.</p>
</div>
</li>
<li>
<p><strong>Fun</strong></p>
<div class="paragraph">
<p>If you go to conferences or ask developers you will see that spring is popular and fun. If new developers are forced to use an old application server product they will be less motivated or even get frustrated. Especially in today&#x2019;s agile projects this is a very important aspect. In the end you will get into trouble with maintenance on the long run if you rely on a proprietary application server.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of course the vendors of application servers will tell you a different story. This is simply because they still make a lot of money from their products. We do not get paid from application servers nor from spring. We are just developers who love to build great systems. A good reason for application servers is that they combine a set of solutions to particular aspects to one product that helps to standardize your IT. However, <a href="http://www.devonfw.com/">devonfw</a> fills exactly this gap for the spring ecosystem in a very open and flexible way. However, there is one important aspect that you need to understand and be aware of:</p>
</div>
<div class="paragraph">
<p>Some big companies decided for a specific application server as their IT strategy. They may have hundreds of apps running with this application server. All their operators and developers have learned a lot of specific skills for this product and are familiar with it. If you are implementing yet another (small) app in this context it can make sense to stick with this application server. However, also they have to be aware that with every additional app they increase their technical debt.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-logging.asciidoc">9.11. Logging</h3>
<div class="paragraph">
<p>We use <a href="http://www.slf4j.org/">SLF4J</a> as API for logging. The recommended implementation is <a href="http://logback.qos.ch/">Logback</a> for which we provide additional value such as configuration templates and an appender that prevents log-forging and reformatting of stack-traces for operational optimizations.</p>
</div>
<div class="sect3">
<h4 id="guide-logging.asciidoc_usage">9.11.1. Usage</h4>
<div class="sect4">
<h5 id="guide-logging.asciidoc_maven-integration">Maven Integration</h5>
<div class="paragraph">
<p>In the pom.xml of your application add this dependency (that also adds transitive dependencies to SLF4J and logback):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.devonfw.java&lt;/groupId&gt;
  &lt;artifactId&gt;devon4j-logging&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-logging.asciidoc_configuration">Configuration</h5>
<div class="paragraph">
<p>The configuration file is logback.xml and is to put in the directory src/main/resources of your main application. For details consult the <a href="http://logback.qos.ch/manual/configuration.html">logback configuration manual</a>. devon4j provides a production ready configuration <a href="https://github.com/devonfw/devon4j/blob/develop/templates/server/src/main/resources/archetype-resources/server/src/main/resources/logback.xml">here</a>. Simply copy this configuration into your application in order to benefit from the provided <a href="master-devon4j.asciidoc_guides.html#guide-logging.asciidoc_operations">operational</a> and <a href="#guide-logging.asciidoc_guide-logging.asciidoc_security">security</a> aspects. We do not include the configuration into the devon4j-logging module to give you the freedom of customizations (e.g. tune log levels for components and integrated products and libraries of your application).</p>
</div>
<div class="paragraph">
<p>The provided logback.xml is configured to use variables defined on the config/application.properties file. On our example, the log files path point to ../logs/ in order to log to tomcat log directory when starting tomcat on the bin folder. Change it according to your custom needs.</p>
</div>
<div class="listingblock">
<div class="title">Listing 6. config/application.properties</div>
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">log.dir=../logs/</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-logging.asciidoc_logger-access">Logger Access</h5>
<div class="paragraph">
<p>The general pattern for accessing loggers from your code is a static logger instance per class. We pre-configured the development environment so you can just type LOG and hit [ctrl][space] (and then [arrow up]) to insert the code pattern line into your class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyClass {
  private static final Logger LOG = LoggerFactory.getLogger(MyClass.class);
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that in this case we are not using injection pattern but use the convenient static alternative. This is already a common solution and also has performance benefits.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-logging.asciidoc_how-to-log">How to log</h5>
<div class="paragraph">
<p>We use a common understanding of the log-levels as illustrated by the following table. This helps for better maintenance and operation of the systems by combining both views.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Log-levels</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Log-level</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Impact</strong></th>
<th class="tableblock halign-left valign-top"><strong>Active Environments</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FATAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only used for fatal errors that prevent the application to work at all (e.g. startup fails or shutdown/restart required)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator has to react immediately</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERROR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An abnormal error indicating that the processing failed due to technical problems.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator should check for known issue and otherwise inform development</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WARNING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A situation where something worked not as expected. E.g. a business exception or user validation failure occurred.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No direct reaction required. Used for problem analysis.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INFO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Important information such as context, duration, success/failure of request or process</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No direct reaction required. Used for analysis.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEBUG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Development information that provides additional context for debugging problems.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No direct reaction required. Used for analysis.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">development and testing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRACE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Like DEBUG but exhaustive information and for code that is run very frequently. Will typically cause large log-files.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No direct reaction required. Used for problem analysis.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none (turned off by default)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Exceptions (with their stacktrace) should only be logged on FATAL or ERROR level. For business exceptions typically a WARNING including the message of the exception is sufficient.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-logging.asciidoc_operations">9.11.2. Operations</h4>
<div class="sect4">
<h5 id="guide-logging.asciidoc_log-files">Log Files</h5>
<div class="paragraph">
<p>We always use the following log files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Error Log</strong>: Includes log entries to detect errors.</p>
</li>
<li>
<p><strong>Info Log</strong>: Used to analyze system status and to detect bottlenecks.</p>
</li>
<li>
<p><strong>Debug Log</strong>: Detailed information for error detection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The log file name pattern is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&#xAB;LOGTYPE&#xBB;_log_&#xAB;HOST&#xBB;_&#xAB;APPLICATION&#xBB;_&#xAB;TIMESTAMP&#xBB;.log</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Segments of Logfilename</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Element</strong></th>
<th class="tableblock halign-left valign-top"><strong>Value</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#xAB;LOGTYPE&#xBB;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">info, error, debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of log file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#xAB;HOST&#xBB;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e.g. mywebserver01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of server, where logs are generated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#xAB;APPLICATION&#xBB;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e.g. myapp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of application, which causes logs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#xAB;TIMESTAMP&#xBB;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YYYY-MM-DD_HH00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">date of log file</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Example:
error_log_mywebserver01_myapp_2013-09-16_0900.log</p>
</div>
<div class="paragraph">
<p>Error log from mywebserver01 at application myapp at 16th September 2013 9pm.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-logging.asciidoc_output-format">Output format</h5>
<div class="paragraph">
<p>We use the following output format for all log entries to ensure that searching and filtering of log entries work consistent for all logfiles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code> [D: &#xAB;timestamp&#xBB;] [P: &#xAB;priority&#xBB;] [C: &#xAB;NDC&#xBB;][T: &#xAB;thread&#xBB;][L: &#xAB;logger&#xBB;]-[M: &#xAB;message&#xBB;]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>D</strong>: Date (Timestamp in ISO8601 format e.g. 2013-09-05 16:40:36,464)</p>
</li>
<li>
<p><strong>P</strong>: Priority (the log level)</p>
</li>
<li>
<p><strong>C</strong>: <a href="master-devon4j.asciidoc_guides.html#guide-logging.asciidoc_correlation-id">Correlation ID</a> (ID to identify users across multiple systems, needed when application is distributed)</p>
</li>
<li>
<p><strong>T</strong>: Thread (Name of thread)</p>
</li>
<li>
<p><strong>L</strong>: Logger name (use class name)</p>
</li>
<li>
<p><strong>M</strong>: Message (log message)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code> [D: 2013-09-05 16:40:36,464] [P: DEBUG] [C: 12345] [T: main] [L: my.package.MyClass]-[M: My message...]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-logging.asciidoc_security">9.11.3. Security</h4>
<div class="paragraph">
<p>In order to prevent <a href="https://www.owasp.org/index.php/Log_Forging">log forging</a> attacks we provide a special appender for logback in <a href="master-devon4j.asciidoc_guides.html#guide-logging.asciidoc">devonfw-logging</a>. If you use it (see <a href="#guide-logging.asciidoc_guide-logging.asciidoc_configuration">configuration</a>) you are safe from such attacks.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-logging.asciidoc_correlation-id">9.11.4. Correlation ID</h4>
<div class="paragraph">
<p>In order to correlate separate HTTP requests to services belonging to the same user / session, we provide a servlet filter called <code>DiagnosticContextFilter</code>. This filter takes a provided correlation ID from the HTTP header <code>X-Correlation-Id</code>. If none was found, it will generate a new correlation id as <code>UUID</code>. This correlation ID is added as MDC to the logger. Therefore, it will then be included to any log message of the current request (thread). Further concepts such as <a href="master-devon4j.asciidoc_guides.html#guide-service-client.asciidoc">service invocations</a> will pass this correlation ID to subsequent calls in the application landscape. Hence you can find all log messages related to an initial request simply via the correlation ID even in highly distributed systems.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-logging.asciidoc_monitoring">9.11.5. Monitoring</h4>
<div class="paragraph">
<p>In highly distributed systems (from clustering up to microservices) it might get tedious to search for problems and details in log files. Therefore, we recommend to setup a central log and analysis server for your application landscape. Then you feed the logs from all your applications (using <a href="http://logstash.net/">logstash</a>) into that central server that adds them to a search index to allow fast searches (using <a href="http://www.elasticsearch.org/">elasticsearch</a>). This should be completed with a UI that allows dashboards and reports based on data aggregated from all the logs.
This is addressed by <a href="https://www.elastic.co/webinars/introduction-elk-stack">ELK</a> or <a href="https://www.graylog.org/">Graylog</a>.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-security.asciidoc">9.12. Security</h3>
<div class="paragraph">
<p>Security is todays most important cross-cutting concern of an application and an enterprise IT-landscape. We seriously care about security and give you detailed guides to prevent pitfalls, vulnerabilities, and other disasters. While many mistakes can be avoided by following our guidelines you still have to consider security and think about it in your design and implementation. The security guide will not only automatically prevent you from any harm, but will provide you hints and best practices already used in different software products.</p>
</div>
<div class="paragraph">
<p>An important aspect of security is proper authentication and authorization as described in <a href="master-devon4j.asciidoc_guides.html#guide-access-control.asciidoc">access-control</a>. In the following we discuss about potential vulnerabilities and protection to prevent them.</p>
</div>
<div class="sect3">
<h4 id="guide-security.asciidoc_vulnerabilities-and-protection">9.12.1. Vulnerabilities and Protection</h4>
<div class="paragraph">
<p>Independent from classical authentication and authorization mechanisms there are many common pitfalls that can lead to vulnerabilities and security issues in your application such as XSS, CSRF, SQL-injection, log-forging, etc. A good source of information about this is the <a href="https://www.owasp.org">OWASP</a>.
We address these common threats individually in <em>security</em> sections of our technological guides as a concrete solution to prevent an attack typically depends on the according technology. The following table illustrates common threats and contains links to the solutions and protection-mechanisms provided by the devonfw:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Security threats and protection-mechanisms</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Threat</strong></th>
<th class="tableblock halign-left valign-top"><strong>Protection</strong></th>
<th class="tableblock halign-left valign-top"><strong>Link to details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A1-Injection">A1 Injection</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">validate input, escape output, use proper frameworks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-jpa.html#security">SQL Injection</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A2-Broken_Authentication_and_Session_Management">A2 Broken Authentication and Session Management</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encrypt all channels, use a central identity management with strong password-policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-access-control.html#authentication">Authentication</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A3-Cross-Site_Scripting_(XSS)">A3 XSS</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">prevent injection (see A1) for HTML, JavaScript and CSS and understand same-origin-policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-client-layer.html#security">client-layer</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A4-Insecure_Direct_Object_References">A4 Insecure Direct Object References</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using direct object references (IDs) only with appropriate authorization</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-logic-layer.html#direct-object-references">logic-layer</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A5-Security_Misconfiguration">A5 Security Misconfiguration</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use devonfw application template and guides to avoid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://repo1.maven.org/maven2/io/oasp/java/templates/">application template</a> and <a href="guide-configuration.html#security">sensitive configuration</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A6-Sensitive_Data_Exposure">A6 Sensitive Data Exposure</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use secured exception facade, design your data model accordingly</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-service-layer.html#rest-exception-handling">REST exception handling</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A7-Missing_Function_Level_Access_Control">A7 Missing Function Level Access Control</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ensure proper authorization for all use-cases, use <code>@DenyAll</code> as default to enforce</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-access-control.html#configuration-on-java-method-level">Method authorization</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A8-Cross-Site_Request_Forgery_(CSRF)">A8 CSRF</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">secure mutable service operations with an explicit CSRF security token sent in HTTP header and verified on the server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-service-layer.html#csrf">service-layer security</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A9-Using_Components_with_Known_Vulnerabilities">A9 Using Components with Known Vulnerabilities</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">subscribe to security newsletters, recheck products and their versions continuously, use devonfw dependency management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cve.mitre.org/news/newsletter.html">CVE newsletter</a> and <a href="master-devon4j.asciidoc_guides.html#guide-security.asciidoc_dependency-check">dependency check</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Top_10_2013-A10-Unvalidated_Redirects_and_Forwards">A10 Unvalidated Redirects and Forwards</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Avoid using redirects and forwards, in case you need them do a security audit on the solution.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">devonfw proposes to use rich-clients (SPA/RIA). We only use redirects for login in a safe way.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.owasp.org/index.php/Log_Forging">Log-Forging</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Escape newlines in log messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-logging.html#security">logging security</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="guide-security.asciidoc_tools">9.12.2. Tools</h4>
<div class="sect4">
<h5 id="guide-security.asciidoc_dependency-check">Dependency Check</h5>
<div class="paragraph">
<p>To address <a href="https://www.owasp.org/index.php/Top_10_2013-A9-Using_Components_with_Known_Vulnerabilities">A9 Using Components with Known Vulnerabilities</a> we integrated <a href="https://www.owasp.org/index.php/OWASP_Dependency_Check">OWASP dependency check</a> into the devonfw maven build. If you build an devonfw application (sample or any app created from our <a href="master-devon4j.asciidoc_tutorials.html#tutorial-newapp.asciidoc">app-template</a>) you can activate dependency check with the <code>security</code> profile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn clean install -P security</code></pre>
</div>
</div>
<div class="paragraph">
<p>This does not run by default as it causes a huge overhead for the build performance. However , consider to build this in your CI at least nightly.
After the dependency check is performed , you will find the results in <code>target/dependency-check-report.html</code> of each module. The report will also always be generated when the site is build (<code>mvn site</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-security.asciidoc_penetration-testing">Penetration Testing</h5>
<div class="paragraph">
<p>For penetration testing (testing for vulnerabilities) of your web application, we recommend the following tools:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project">ZAP</a> (OWASP Zed Attack Proxy Project)</p>
</li>
<li>
<p><a href="http://sqlmap.org/">sqlmap</a> (or <a href="https://github.com/PaulSec/HQLmap">HQLmap</a>)</p>
</li>
<li>
<p><a href="https://nmap.org/">nmap</a></p>
</li>
<li>
<p>See the marvelous presentation <a href="https://jaxenter.com/security-open-source-toolbox-video-151314.html">Toolbox of a security professional</a> from <a href="https://www.Christian-Schneider.net">Christian Schneider</a>.</p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-access-control.asciidoc">9.13. Access-Control</h3>
<div class="paragraph">
<p>Access-Control is a central and important aspect of <a href="master-devon4j.asciidoc_guides.html#guide-security.asciidoc">Security</a>. It consists of two major aspects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#guide-access-control.asciidoc_guide-access-control.asciidoc_Authentication">Authentication</a> (Who tries to access?)</p>
</li>
<li>
<p><a href="#guide-access-control.asciidoc_guide-access-control.asciidoc_Authorization">Authorization</a> (Is the one accessing allowed to do what he wants to do?)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="guide-access-control.asciidoc_authentication">9.13.1. Authentication</h4>
<div class="paragraph">
<p>Definition:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Authentication is the verification that somebody interacting with the system is the actual subject for whom he claims to be.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The one authenticated is properly called <em>subject</em> or <a href="http://docs.oracle.com/javase/7/docs/api/java/security/Principal.html"><em>principal</em></a>. However, for simplicity we use the common term <em>user</em> even though it may not be a human (e.g. in case of a service call from an external system).</p>
</div>
<div class="paragraph">
<p>To prove his authenticity the user provides some secret called <em>credentials</em>. The most simple form of credentials is a password.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Please never implement your own authentication mechanism or credential store. You have to be aware of implicit demands such as salting and hashing credentials, password life-cycle with recovery, expiry, and renewal including email notification confirmation tokens, central password policies, etc. This is the domain of access managers and identity management systems. In a business context you will typically already find a system for this purpose that you have to integrate (e.g. via LDAP). Otherwise you should consider establishing such a system e.g. using <a href="http://keycloak.org">keycloak</a>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>We use <a href="https://projects.spring.io/spring-security/">spring-security</a> as a framework for authentication purposes.</p>
</div>
<div class="paragraph">
<p>Therefore you need to provide an implementation of <a href="https://docs.spring.io/spring-security/site/docs/4.2.x/apidocs/org/springframework/security/config/annotation/web/WebSecurityConfigurer.html">WebSecurityConfigurerAdapter</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
@EnableWebSecurity
public class MyWebSecurityConfig extends WebSecurityConfigurerAdapter {

  @Inject
  private UserDetailsService userDetailsService;
  ...
  public void configure(HttpSecurity http) throws Exception {
    http.userDetailsService(this.userDetailsService)
        .authorizeRequests().antMatchers(&quot;/public/**&quot;).permitAll()
        .anyRequest().authenticated().and()
        ...
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see spring-security offers a fluent API for easy configuration. You can simply add invocations like <code>formLogin().loginPage(&quot;/public/login&quot;)</code> or <code>httpBasic().realmName(&quot;MyApp&quot;)</code>. Also <a href="master-devon4j.asciidoc_guides.html#guide-security.asciidoc">CSRF</a> protection can be configured by invoking <code>csrf()</code>.
For further details see <a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/jc.html#jc-httpsecurity">spring Java-config for HTTP security</a>.</p>
</div>
<div class="paragraph">
<p>Further, you need to provide an implementation of the <a href="https://docs.spring.io/spring-security/site/docs/4.2.x/apidocs/org/springframework/security/core/userdetails/UserDetailsService.html">UserDetailsService</a> interface.
A good starting point comes with our application template.</p>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_preserve-original-request-anchors-after-form-login-redirect">Preserve original request anchors after form login redirect</h5>
<div class="paragraph">
<p>Spring Security will automatically redirect any unauthorized access to the defined login-page. After successful login, the user will be redirected to the original requested URL. The only pitfall is, that anchors in the request URL will not be transmitted to server and thus cannot be restored after successful login. Therefore the <code>devon4j-security</code> module provides the <code>RetainAnchorFilter</code>, which is able to inject javascript code to the source page and to the target page of any redirection. Using javascript this filter is able to retrieve the requested anchors and store them into a cookie. Heading the target URL this cookie will be used to restore the original anchors again.</p>
</div>
<div class="paragraph">
<p>To enable this mechanism you have to integrate the <code>RetainAnchorFilter</code> as follows:
First, declare the filter with</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>storeUrlPattern</code>: an regular expression matching the URL, where anchors should be stored</p>
</li>
<li>
<p><code>restoreUrlPattern</code>: an regular expression matching the URL, where anchors should be restored</p>
</li>
<li>
<p><code>cookieName</code>: the name of the cookie to save the anchors in the intermediate time</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can easily configure this as code in your <code>WebSecurityConfig</code> as following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">RetainAnchorFilter filter = new RetainAnchorFilter();
filter.setStoreUrlPattern(&quot;http://[^/]+/[^/]+/login.*&quot;);
filter.setRestoreUrlPattern(&quot;http://[^/]+/[^/]+/.*&quot;);
filter.setCookieName(&quot;TARGETANCHOR&quot;);
http.addFilterBefore(filter, UsernamePasswordAuthenticationFilter.class);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_users-vs.-systems">Users vs. Systems</h5>
<div class="paragraph">
<p>If we are talking about authentication we have to distinguish two forms of principals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>human users</p>
</li>
<li>
<p>autonomous systems</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While e.g. a Kerberos/SPNEGO Single-Sign-On makes sense for human users it is pointless for authenticating autonomous systems. So always keep this in mind when you design your authentication mechanisms and separate access for human users from access for systems.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_mixed-authentication">Mixed Authentication</h5>
<div class="paragraph">
<p>In rare cases you might need to mix multiple authentication mechanisms (form based, basic-auth, SAMLv2, OAuth, etc.) within the same app (for different URLs). For KISS this should be avoided where possible. However, when needed, you can find a solution
<a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#multiple-httpsecurity">here</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-access-control.asciidoc_authorization">9.13.2. Authorization</h4>
<div class="paragraph">
<p><strong>Definition:</strong></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Authorization is the verification that an authenticated user is allowed to perform the operation he intends to invoke.</p>
</div>
</blockquote>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_clarification-of-terms">Clarification of terms</h5>
<div class="paragraph">
<p>For clarification we also want to give a common understanding of related terms that have no unique definition and consistent usage in the wild.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Security terms related to authorization</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 85%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Term</strong></th>
<th class="tableblock halign-left valign-top"><strong>Meaning and comment</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A permission is an object that allows a principal to perform an operation in the system. This permission can be <em>granted</em> (give) or <em>revoked</em> (taken away). Sometimes people also use the term <em>right</em> what is actually wrong as a right (such as the right to be free) can not be revoked.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">We use the term group in this context for an object that contains permissions. A group may also contain other groups. Then the group represents the set of all recursively contained permissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Role</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">We consider a role as a specific form of group that also contains permissions. A role identifies a specific function of a principal. A user can act in a role.</p>
<p class="tableblock">For simple scenarios a principal has a single role associated. In more complex situations a principal can have multiple roles but has only one active role at a time that he can choose out of his assigned roles. For KISS it is sometimes sufficient to avoid this by creating multiple accounts for the few users with multiple roles. Otherwise at least avoid switching roles at run-time in clients as this may cause problems with related states. Simply restart the client with the new role as parameter in case the user wants to switch his role.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any permission, group, role, etc., which declares a control for access management.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_suggestions-on-the-access-model">Suggestions on the access model</h5>
<div class="paragraph">
<p>For the access model we give the following suggestions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each Access Control (permission, group, role, &#x2026;&#x200B;) is uniquely identified by a human readable string.</p>
</li>
<li>
<p>We create a unique permission for each use-case.</p>
</li>
<li>
<p>We define groups that combine permissions to typical and useful sets for the users.</p>
</li>
<li>
<p>We define roles as specific groups as required by our business demands.</p>
</li>
<li>
<p>We allow to associate users with a list of Access Controls.</p>
</li>
<li>
<p>For authorization of an implemented use case we determine the required permission. Furthermore, we determine the current user and verify that the required permission is contained in the tree spanned by all his associated Access Controls. If the user does not have the permission we throw a security exception and thus abort the operation and transaction.</p>
</li>
<li>
<p>We avoid negative permissions, that is a user has no permission by default and only those granted to him explicitly give him additional permission for specific things. Permissions granted can not be reduced by other permissions.</p>
</li>
<li>
<p>Technically we consider permissions as a secret of the application. Administrators shall not fiddle with individual permissions but grant them via groups. So the access management provides a list of strings identifying the Access Controls of a user. The individual application itself contains these Access Controls in a structured way, whereas each group forms a permission tree.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_naming-conventions">Naming conventions</h5>
<div class="paragraph">
<p>As stated above each Access Control is uniquely identified by a human readable string. This string should follow the naming convention:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&#xAB;app-id&#xBB;.&#xAB;local-name&#xBB;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Access Control Permissions the <code>&#xAB;local-name&#xBB;</code> again follows the convention:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&#xAB;verb&#xBB;&#xAB;object&#xBB;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The segments are defined by the following table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Segments of Access Control Permission ID</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Segment</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#xAB;app-id&#xBB;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is a unique technical but human readable string of the application (or microservice). It shall not contain special characters and especially no dot or whitespace. We recommend to use <code>lower-train-case-ascii-syntax</code>. The identity and access management should be organized on enterprise level rather than application level. Therefore permissions of different apps might easily clash (e.g. two apps might both define a group <code>ReadMasterData</code> but some user shall get this group for only one of these two apps). Using the <code>&#xAB;app-id&#xBB;.</code> prefix is a simple but powerful namespacing concept that allows you to scale and grow. You may also reserve specific &#xAB;app-id&#xBB;s for cross-cutting concerns that do not actually reflect a single app e.g to grant access to a geographic region.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shop</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#xAB;verb&#xBB;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The action that is to be performed on &#xAB;object&#xBB;. We use <code>Find</code> for searching and reading data. <code>Save</code> shall be used both for create and update. Only if you really have demands to separate these two you may use <code>Create</code> in addition to <code>Save</code>. Finally, <code>Delete</code> is used for deletions. For non CRUD actions you are free to use additional verbs such as <code>Approve</code> or <code>Reject</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Find</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#xAB;object&#xBB;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The affected object or entity. Shall be named according to your data-model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Product</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>So as an example <code>shop.FindProduct</code> will reflect the permission to search and retrieve a <code>Product</code> in the <code>shop</code> application. The group <code>shop.ReadMasterData</code> may combine all permissions to read master-data from the <code>shop</code>. However, also a group <code>shop.Admin</code> may exist for the <code>Admin</code> role of the <code>shop</code> application. Here the <code>&#xAB;local-name&#xBB;</code> is <code>Admin</code> that does not follow the <code>&#xAB;verb&#xBB;&#xAB;object&#xBB;</code> schema.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_devon4j-security">devon4j-security</h5>
<div class="paragraph">
<p>The devonfw provides a ready to use module <code>devon4j-security</code> that is based on <a href="http://projects.spring.io/spring-security/">spring-security</a> and makes your life a lot easier.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="images/Security-AccessControl.png"><img src="images/Security-AccessControl.png" alt="access-control"></a>
</div>
<div class="title">Figure 24. devon4j Security Model</div>
</div>
<div class="paragraph">
<p>The diagram shows the model of <code>devon4j-security</code> that separates two different aspects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>Identity- and Access-Management</em> is provided by according products and typically already available in the enterprise landscape (e.g. an active directory). It provides a hierarchy of <em>primary access control objects</em> (roles and groups) of a user. An administrator can grant and revoke permissions (indirectly) via this way.</p>
</li>
<li>
<p>The application security defines a hierarchy of <em>secondary access control objects</em> (groups and permissions). This is done by configuration owned by the application (see following section). The &quot;API&quot; is defined by the IDs of the primary access control objects that will be referenced from the <em>Identity- and Access-Management</em>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_access-control-config">Access Control Config</h5>
<div class="paragraph">
<p>In your application simply extend <code>AccessControlConfig</code> to configure your access control objects as code and reference it from your use-cases. An example config may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
public class ApplicationAccessControlConfig extends AccessControlConfig {

  public static final String APP_ID = &quot;MyApp&quot;;

  private static final String PREFIX = APP_ID + &quot;.&quot;;

  public static final String PERMISSION_FIND_OFFER = PREFIX + &quot;FindOffer&quot;;

  public static final String PERMISSION_SAVE_OFFER = PREFIX + &quot;SaveOffer&quot;;

  public static final String PERMISSION_DELETE_OFFER = PREFIX + &quot;DeleteOffer&quot;;

  public static final String PERMISSION_FIND_PRODUCT = PREFIX + &quot;FindProduct&quot;;

  public static final String PERMISSION_SAVE_PRODUCT = PREFIX + &quot;SaveProduct&quot;;

  public static final String PERMISSION_DELETE_PRODUCT = PREFIX + &quot;DeleteProduct&quot;;

  public static final String GROUP_READ_MASTER_DATA = PREFIX + &quot;ReadMasterData&quot;;

  public static final String GROUP_MANAGER = PREFIX + &quot;Manager&quot;;

  public static final String GROUP_ADMIN = PREFIX + &quot;Admin&quot;;

  public ApplicationAccessControlConfig() {

    super();
    AccessControlGroup readMasterData = group(GROUP_READ_MASTER_DATA, PERMISSION_FIND_OFFER, PERMISSION_FIND_PRODUCT);
    AccessControlGroup manager = group(GROUP_MANAGER, readMasterData, PERMISSION_SAVE_OFFER, PERMISSION_SAVE_PRODUCT);
    AccessControlGroup admin = group(GROUP_ADMIN, manager, PERMISSION_DELETE_OFFER, PERMISSION_DELETE_PRODUCT);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_configuration-on-java-method-level">Configuration on Java Method level</h5>
<div class="paragraph">
<p>In your use-case you can now reference a permission like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
public class UcSafeOfferImpl extends ApplicationUc implements UcSafeOffer {

  @Override
  @RolesAllowed(ApplicationAccessControlConfig.PERMISSION_SAVE_OFFER)
  public OfferEto save(OfferEto offer) { ... }
  ...
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_check-data-permissions">Check Data-Permissions</h5>
<div class="paragraph">
<p>See <a href="master-devon4j.asciidoc_guides.html#guide-data-permission.asciidoc">data permissions</a></p>
</div>
</div>
<div class="sect4">
<h5 id="guide-access-control.asciidoc_access-control-schema-deprecated">Access Control Schema (deprecated)</h5>
<div class="paragraph">
<p>The <code>access-control-schema.xml</code> approach is deprecated. The documentation can still be found in <a href="#guide-access-control-schema.asciidoc">access control schema</a>.</p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-data-permission.asciidoc">9.14. Data-permissions</h3>
<div class="paragraph">
<p>In some projects there are demands for permissions and authorization that is dependent on the processed data. E.g. a user may only be allowed to read or write data for a specific region. This is adding some additional complexity to your authorization. If you can avoid this it is always best to keep things simple. However, in various cases this is a requirement. Therefore the following sections give you guidance and patterns how to solve this properly.</p>
</div>
<div class="sect3">
<h4 id="guide-data-permission.asciidoc_structuring-your-data">9.14.1. Structuring your data</h4>
<div class="paragraph">
<p>For all your business objects (entities) that have to be secured regarding to data permissions we recommend that you create a separate interface that provides access to the relevant data required to decide about the permission. Here is a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface SecurityDataPermissionCountry {

  /**
   * @return the 2-letter ISO code of the country this object is associated with. Users need
   *         a data-permission for this country in order to read and write this object.
   */
  String getCountry();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now related business objects (entities) can implement this interface. Often such data-permissions have to be applied to an entire object-hierarchy. For security reasons we recommend that also all child-objects implement this interface. For performance reasons we recommend that the child-objects redundantly store the data-permission properties (such as <code>country</code> in the example above) and this gets simply propagated from the parent, when a child object is created.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-data-permission.asciidoc_permissions-for-processing-data">9.14.2. Permissions for processing data</h4>
<div class="paragraph">
<p>When saving or processing objects with a data-permission, we recommend to provide dedicated methods to verify the permission in an abstract base-class such as <code>AbstractUc</code> and simply call this explicitly from your business code. This makes it easy to understand and debug the code. Here is a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">protected void verifyPermission(SecurityDataPermissionCountry entity) throws AccessDeniedException;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="guide-data-permission.asciidoc_beware-of-aop">Beware of AOP</h5>
<div class="paragraph">
<p>For simple but cross-cutting data-permissions you may also use <a href="master-devon4j.asciidoc_guides.html#guide-aop.asciidoc">AOP</a>. This leads to programming aspects that reflectively scan method arguments and magically decide what to do. Be aware that this quickly gets tricky:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What if multiple of your method arguments have data-permissions (e.g. implement <code>SecurityDataPermission*</code>)?</p>
</li>
<li>
<p>What if the object to authorize is only provided as reference (e.g. <code>Long</code> or <code>IdRef</code>) and only loaded and processed inside the implementation where the AOP aspect does not apply?</p>
</li>
<li>
<p>How to express advanced data-permissions in annotations?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What we have learned is that annotations like <code>@PreAuthorize</code> from <code>spring-security</code> easily lead to the &quot;programming in string literals&quot; anti-pattern. We strongly discourage to use this anti-pattern. In such case writing your own <code>verifyPermission</code> methods that you manually call in the right places of your business-logic is much better to understand, debug and maintain.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-data-permission.asciidoc_permissions-for-reading-data">9.14.3. Permissions for reading data</h4>
<div class="paragraph">
<p>When it comes to restrictions on the data to read it becomes even more tricky. In the context of a user only entities shall be loaded from the database he is permitted to read. This is simple for loading a single entity (e.g. by its ID) as you can load it and then if not permitted throw an exception to secure your code. But what if the user is performing a search query to find many entities? For performance reasons we should only find data the user is permitted to read and filter all the rest already via the database query. But what if this is not a requirement for a single query but needs to be applied cross-cutting to tons of queries? Therefore we have the following pattern that solves your problem:</p>
</div>
<div class="paragraph">
<p>For each data-permission attribute (or set of such) we create an abstract base entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@MappedSuperclass
@EntityListeners(PermissionCheckListener.class)
@FilterDef(name = &quot;country&quot;, parameters = {@ParamDef(name = &quot;countries&quot;, type = &quot;string&quot;)})
@Filter(name = &quot;country&quot;, condition = &quot;country in (:countries)&quot;)
public abstract class SecurityDataPermissionCountryEntity extends ApplicationPersistenceEntity
    implements SecurityDataPermissionCountry {

  private String country;

  @Override
  public String getCountry() {
    return this.country;
  }

  public void setCountry(String country) {
    this.country = country;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are some special hibernate annotations <code>@EntityListeners</code>, <code>@FilterDef</code>, and <code>@Filter</code> used here allowing to apply a filter on the <code>country</code> for any (non-native) query performed by hibernate. The entity listener may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class PermissionCheckListener {

  @PostLoad
  public void read(SecurityDataPermissionCountryEntity entity) {
    PermissionChecker.getInstance().requireReadPermission(entity);
  }

  @PrePersist
  @PreUpdate
  public void write(SecurityDataPermissionCountryEntity entity) {
    PermissionChecker.getInstance().requireWritePermission(entity);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will ensure that hibernate implicitly will call these checks for every such entity when it is read from or written to the database. Further to avoid reading entities from the database the user is not permitted to (and ending up with exceptions), we create an AOP aspect that automatically activates the above declared hibernate filter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
public class PermissionCheckerAdvice implements MethodBeforeAdvice {

  @Inject
  private PermissionChecker permissionChecker;

  @PersistenceContext
  private EntityManager entityManager;

  @Override
  public void before(Method method, Object[] args, Object target) {

    Collection&lt;String&gt; permittedCountries = this.permissionChecker.getPermittedCountriesForReading();
    if (permittedCountries != null) { // null is returned for admins that may access all countries
      if (permittedCountries.isEmpty()) {
        throw new AccessDeniedException(&quot;Not permitted for any country!&quot;);
      }
      Session session = this.entityManager.unwrap(Session.class);
      session.enableFilter(&quot;country&quot;).setParameterList(&quot;countries&quot;, permittedCountries.toArray());
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally to apply this aspect to all Repositories (can easily be changed to DAOs) implement the following advisor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
public class PermissionCheckerAdvisor implements PointcutAdvisor, Pointcut, ClassFilter, MethodMatcher {

  @Inject
  private PermissionCheckerAdvice advice;

  @Override
  public Advice getAdvice() {
    return this.advice;
  }

  @Override
  public boolean isPerInstance() {
    return false;
  }

  @Override
  public Pointcut getPointcut() {
    return this;
  }

  @Override
  public ClassFilter getClassFilter() {
    return this;
  }

  @Override
  public MethodMatcher getMethodMatcher() {
    return this;
  }

  @Override
  public boolean matches(Method method, Class&lt;?&gt; targetClass) {
    return true; // apply to all methods
  }

  @Override
  public boolean isRuntime() {
    return false;
  }

  @Override
  public boolean matches(Method method, Class&lt;?&gt; targetClass, Object... args) {
    throw new IllegalStateException(&quot;isRuntime()==false&quot;);
  }

  @Override
  public boolean matches(Class&lt;?&gt; clazz) {
    // when using DAOs simply change to some class like ApplicationDao
    return DefaultRepository.class.isAssignableFrom(clazz);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-data-permission.asciidoc_managing-and-granting-the-data-permissions">9.14.4. Managing and granting the data-permissions</h4>
<div class="paragraph">
<p>Following our <a href="guide-access-control.html#authorization">authorization guide</a> we can simply create a permission for each country. We might simply reserve a prefix (as virtual <code>&#xAB;app-id&#xBB;</code>) for each data-permission to allow granting data-permissions to end-users across all applications of the IT landscape. In our example we could create access controls <code>country.DE</code>, <code>country.US</code>, <code>country.ES</code>, etc. and assign those to the users. The method <code>permissionChecker.getPermittedCountriesForReading()</code> would then scan for these access controls and only return the 2-letter country code from it.</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
Before you make your decisions how to design your access controls please clarify the following questions:
</td>
</tr>
</tbody></table>
</div>
<div class="ulist">
<ul>
<li>
<p>Do you need to separate data-permissions independent of the functional permissions? E.g. may it be required to express that a user can read data from the countries <code>ES</code> and <code>PL</code> but is only permitted to modify data from <code>PL</code>? In such case a single assignment of &quot;country-permissions&quot; to users is insufficient.</p>
</li>
<li>
<p>Do you want to grant data-permissions individually for each application (higher flexibility and complexity) or for the entire application landscape (simplicity, better maintenance for administrators)? In case of the first approach you would rather have access controls like <code>app1.country.GB</code> and <code>app2.country.GB</code>.</p>
</li>
<li>
<p>Do your data-permissions depend on objects that can be created dynamically inside your application?</p>
</li>
<li>
<p>If you want to grant data-permissions on other business objects (entities), how do you want to reference them (primary keys, business keys, etc.)? What reference is most stable? Which is most readable?</p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-validation.asciidoc">9.15. Validation</h3>
<div class="paragraph">
<p>Validation is about checking syntax and semantics of input data. Invalid data is rejected by the application.
Therefore validation is required in multiple places of an application. E.g. the <a href="master-devon4j.asciidoc_layers.html#guide-client-layer.asciidoc">GUI</a> will do validation for usability reasons to assist the user, early feedback and to prevent unnecessary server requests.
On the server-side validation has to be done for consistency and <a href="master-devon4j.asciidoc_guides.html#guide-security.asciidoc">security</a>.</p>
</div>
<div class="paragraph">
<p>In general we distinguish these forms of validation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>stateless validation</em> will produce the same result for given input at any time (for the same code/release).</p>
</li>
<li>
<p><em>stateful validation</em> is dependent on other states and can consider the same input data as valid in once case and as invalid in another.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="guide-validation.asciidoc_stateless-validation">9.15.1. Stateless Validation</h4>
<div class="paragraph">
<p>For regular, stateless validation we use the JSR303 standard that is also called bean validation (BV).
Details can be found in the <a href="http://beanvalidation.org/1.1/spec/">specification</a>.
As implementation we recommend <a href="http://hibernate.org/validator/">hibernate-validator</a>.</p>
</div>
<div class="sect4">
<h5 id="guide-validation.asciidoc_example">Example</h5>
<div class="paragraph">
<p>A description of how to enable BV can be found in the relevant <a href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/htmlsingle/#validation-beanvalidation">Spring documentation</a>. For a quick summary follow these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure that hibernate-validator is located in the classpath by adding a dependency to the pom.xml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>    &lt;dependency&gt;
      &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
      &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt;
    &lt;/dependency&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the @Validated annotation to the implementation (spring bean) to be validated. The standard use case is to annotate the logic layer implementation, i.e. the use case implementation or component facade in case of simple logic layer pattern. Thus, the validation will be executed for service requests as well as batch processing. For methods to validate go to their declaration and add constraint annotations to the method parameters.</p>
<div class="ulist">
<ul>
<li>
<p>@Valid annotation to the arguments to validate (if that class itself is annotated with constraints to check).</p>
</li>
<li>
<p>@NotNull for required arguments.</p>
</li>
<li>
<p>Other constraints (e.g. @Size) for generic arguments (e.g. of type String or Integer). However, consider to create <a href="master-devon4j.asciidoc_guides.html#guide-datatype.asciidoc">custom datatypes</a> and avoid adding too much validation logic (especially redundant in multiple places).
.<strong>BookingmanagementRestServiceImpl.java</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Validated
public class BookingmanagementRestServiceImpl implements BookingmanagementRestService {
  ...
  public BookingEto saveBooking(@Valid BookingCto booking) {
  ...</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finally add appropriate validation constraint annotations to the fields of the ETO class.
.<strong>BookingCto.java</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>  @Valid
  private BookingEto booking;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 7. <strong>BookingEto.java</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @NotNull
  @Future
  private Timestamp bookingDate;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A list with all bean validation constraint annotations available for hibernate-validator can be found <a href="http://docs.jboss.org/hibernate/stable/validator/reference/en-US/html_single/#table-spec-constraints">here</a>. In addition it is possible to configure custom constraints. Therefore it is necessary to implement a annotation and a corresponding validator. A description can also be found in the <a href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/htmlsingle/#validation-beanvalidation-spring-constraints">Spring documentation</a> or with more details in the <a href="http://docs.jboss.org/hibernate/validator/4.3/reference/en-US/html/validator-customconstraints.html">hibernate documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<strong>Bean Validation in Wildfly &gt;v8:</strong> Wildfly v8 is the first version of Wildfly implementing the JEE7 specification. It comes with bean validation based on <a href="https://samaxes.com/2014/04/jaxrs-beanvalidation-javaee7-wildfly/">hibernate-validator out of the box</a>. In case someone is running Spring in Wildfly for whatever reasons, the spring based annotation @Validated would duplicate bean validation at runtime and thus should be omitted.
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="guide-validation.asciidoc_gui-integration">GUI-Integration</h5>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-validation.asciidoc_cross-field-validation">Cross-Field Validation</h5>
<div class="paragraph">
<p>BV has poor support for this. Best practice is to create and use beans for ranges, etc. that solve this. A bean for a range could look like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class Range&lt;V extends Comparable&lt;V&gt;&gt; {

  private V min;
  private V max;

  public Range(V min, V max) {

    super();
    if ((min != null) &amp;&amp; (max != null)) {
      int delta = min.compareTo(max);
      if (delta &gt; 0) {
        throw new ValueOutOfRangeException(null, min, min, max);
      }
    }
    this.min = min;
    this.max = max;
  }

  public V getMin() ...
  public V getMax() ...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-validation.asciidoc_stateful-validation">9.15.2. Stateful Validation</h4>
<div class="paragraph">
<p>For complex and stateful business validations we do not use BV (possible with groups and context, etc.) but follow KISS and just implement this on the server in a straight forward manner.
An example is the deletion of a table in the example application. Here the state of the table must be checked first:
<strong>BookingmanagementImpl.java</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private void sendConfirmationEmails(BookingEntity booking) {

    if (!booking.getInvitedGuests().isEmpty()) {
      for (InvitedGuestEntity guest : booking.getInvitedGuests()) {
        sendInviteEmailToGuest(guest, booking);
      }
    }

    sendConfirmationEmailToHost(booking);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementing this small check with BV would be a lot more effort.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-aop.asciidoc">9.16. Aspect Oriented Programming (AOP)</h3>
<div class="paragraph">
<p><a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">AOP</a> is a powerful feature for cross-cutting concerns. However, if used extensive and for the wrong things an application can get unmaintainable. Therefore we give you the best practices where and how to use AOP properly.</p>
</div>
<div class="sect3">
<h4 id="guide-aop.asciidoc_aop-key-principles">9.16.1. AOP Key Principles</h4>
<div class="paragraph">
<p>We follow these principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We use <a href="http://docs.spring.io/spring/docs/2.5.4/reference/aop.html">spring AOP</a> based on dynamic proxies (and fallback to cglib).</p>
</li>
<li>
<p>We avoid AspectJ and other mighty and complex AOP frameworks whenever possible</p>
</li>
<li>
<p>We only use AOP where we consider it as necessary (see below).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="guide-aop.asciidoc_aop-usage">9.16.2. AOP Usage</h4>
<div class="paragraph">
<p>We recommend to use AOP with care but we consider it established for the following cross cutting concerns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="master-devon4j.asciidoc_guides.html#guide-transactions.asciidoc">Transaction-Handling</a></p>
</li>
<li>
<p><a href="guide-security.html#method-authorization">Authorization</a></p>
</li>
<li>
<p><a href="master-devon4j.asciidoc_guides.html#guide-validation.asciidoc">Validation</a></p>
</li>
<li>
<p><a href="guide-logging.html#tracing">Trace-Logging</a> (for testing and debugging)</p>
</li>
<li>
<p>Exception facades for <a href="master-devon4j.asciidoc_layers.html#guide-service-layer.asciidoc">services</a> but only if no other solution is possible (use alternatives such as <a href="guide-service-layer.html#rest-exception-handling">JAX-RS provider</a> instead).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="guide-aop.asciidoc_aop-debugging">9.16.3. AOP Debugging</h4>
<div class="paragraph">
<p>When using AOP with dynamic proxies the debugging of your code can get nasty. As you can see by the red boxes in the call stack in the debugger there is a lot of magic happening while you often just want to step directly into the implementation skipping all the AOP clutter. When using Eclipse this can easily be archived by enabling <em>step filters</em>. Therefore you have to enable the feature in the Eclipse tool bar (highlighted in read).</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="images/eclipse-debug-aop.png"><img src="images/eclipse-debug-aop.png" alt="AOP debugging"></a>
</div>
</div>
<div class="paragraph">
<p>In order to properly make this work you need to ensure that the step filters are properly configured:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="images/eclipse-debug-step-filters.png"><img src="images/eclipse-debug-step-filters.png" alt="Step Filter Configuration"></a>
</div>
</div>
<div class="paragraph">
<p>Ensure you have at least the following step-filters configured and active:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ch.qos.logback.*
com.devonfw.module.security.*
java.lang.reflect.*
java.security.*
javax.persistence.*
org.apache.commons.logging.*
org.apache.cxf.jaxrs.client.*
org.apache.tomcat.*
org.h2.*
org.springframework.*</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-exceptions.asciidoc">9.17. Exception Handling</h3>
<div class="sect3">
<h4 id="guide-exceptions.asciidoc_exception-principles">9.17.1. Exception Principles</h4>
<div class="paragraph">
<p>For exceptions we follow these principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We only use exceptions for <em>exceptional</em> situations and not for programming control flows, etc. Creating an exception in Java is expensive and hence you should not do it just for testing if something is present, valid or permitted. In the latter case design your API to return this as a regular result.</p>
</li>
<li>
<p>We use unchecked exceptions (RuntimeException)</p>
</li>
<li>
<p>We distinguish <em>internal exceptions</em> and <em>user exceptions</em>:</p>
<div class="ulist">
<ul>
<li>
<p>Internal exceptions have technical reasons. For unexpected and exotic situations it is sufficient to throw existing exceptions such as IllegalStateException. For common scenarios a own exception class is reasonable.</p>
</li>
<li>
<p>User exceptions contain a message explaining the problem for end users. Therefore we always define our own exception classes with a clear, brief but detailed message.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Our own exceptions derive from an exception base class supporting</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://m-m-m.sourceforge.net/apidocs/net/sf/mmm/util/exception/api/NlsRuntimeException.html#getUuid%28%29">unique ID per instance</a></p>
</li>
<li>
<p><a href="http://m-m-m.sourceforge.net/apidocs/net/sf/mmm/util/exception/api/NlsRuntimeException.html#getCode%28%29">Error code per class</a></p>
</li>
<li>
<p><a href="http://m-m-m.sourceforge.net/apidocs/net/sf/mmm/util/exception/api/NlsThrowable.html#getNlsMessage%28%29">message templating</a> (see <a href="master-devon4j.asciidoc_guides.html#guide-i18n.asciidoc">I18N</a>)</p>
</li>
<li>
<p><a href="http://m-m-m.sourceforge.net/apidocs/net/sf/mmm/util/exception/api/NlsRuntimeException.html#isForUser%28%29">distinguish between <em>user exceptions</em> and <em>internal exceptions</em></a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>All this is offered by <a href="http://m-m-m.sourceforge.net/apidocs/net/sf/mmm/util/exception/api/package-summary.html#documentation">mmm-util-core</a> that we propose as solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-exceptions.asciidoc_exception-example">9.17.2. Exception Example</h4>
<div class="paragraph">
<p>Here is an exception class from our sample application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class IllegalEntityStateException extends ApplicationBusinessException {

  private static final long serialVersionUID = 1L;

  public IllegalEntityStateException(Object entity, Object state) {

    this((Throwable) null, entity, state);
  }


  public IllegalEntityStateException(Object entity, Object currentState, Object newState) {

    this(null, entity, currentState, newState);
  }

  public IllegalEntityStateException(Throwable cause, Object entity, Object state) {

    super(cause, createBundle(NlsBundleApplicationRoot.class).errorIllegalEntityState(entity, state));
  }

  public IllegalEntityStateException(Throwable cause, Object entity, Object currentState, Object newState) {

    super(cause, createBundle(NlsBundleApplicationRoot.class).errorIllegalEntityStateChange(entity, currentState,
        newState));
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message templates are defined in the interface NlsBundleRestaurantRoot as following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface NlsBundleApplicationRoot extends NlsBundle {


  @NlsBundleMessage(&quot;The entity {entity} is in state {state}!&quot;)
  NlsMessage errorIllegalEntityState(@Named(&quot;entity&quot;) Object entity, @Named(&quot;state&quot;) Object state);


  @NlsBundleMessage(&quot;The entity {entity} in state {currentState} can not be changed to state {newState}!&quot;)
  NlsMessage errorIllegalEntityStateChange(@Named(&quot;entity&quot;) Object entity, @Named(&quot;currentState&quot;) Object currentState,
      @Named(&quot;newState&quot;) Object newState);


  @NlsBundleMessage(&quot;The property {property} of object {object} can not be changed!&quot;)
  NlsMessage errorIllegalPropertyChange(@Named(&quot;object&quot;) Object object, @Named(&quot;property&quot;) Object property);

  @NlsBundleMessage(&quot;There is currently no user logged in&quot;)
  NlsMessage errorNoActiveUser();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-exceptions.asciidoc_handling-exceptions">9.17.3. Handling Exceptions</h4>
<div class="paragraph">
<p>For catching and handling exceptions we follow these rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We do not catch exceptions just to wrap or to re-throw them.</p>
</li>
<li>
<p>If we catch an exception and throw a new one, we always <strong>have</strong> to provide the original exception as <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Throwable.html#getCause%28%29">cause</a> to the constructor of the new exception.</p>
</li>
<li>
<p>At the entry points of the application (e.g. a service operation) we have to catch and handle all throwables. This is done via the <em>exception-facade-pattern</em> via an explicit facade or aspect. The devon4j already provides ready-to-use implementations for this such as <a href="https://github.com/devonfw/devon4j/blob/develop/modules/rest/src/main/java/com/devonfw/module/rest/service/impl/RestServiceExceptionFacade.java">RestServiceExceptionFacade</a>. The exception facade has to&#x2026;&#x200B;</p>
<div class="ulist">
<ul>
<li>
<p>log all errors (user errors on info and technical errors on error level)</p>
</li>
<li>
<p>convert the error to a result appropriable for the client and secure for <a href="https://www.owasp.org/index.php/Top_10_2013-A6-Sensitive_Data_Exposure">Sensitive Data Exposure</a>. Especially for security exceptions only a generic security error code or message may be revealed but the details shall only be logged but <strong>not</strong> be exposed to the client. All <em>internal exceptions</em> are converted to a generic error with a message like:</p>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>An unexpected technical error has occurred. We apologize any inconvenience. Please try again later.</p>
</div>
</blockquote>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="guide-exceptions.asciidoc_common-errors">9.17.4. Common Errors</h4>
<div class="paragraph">
<p>The following errors may occur in any devon application:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Common Exceptions</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Code</strong></th>
<th class="tableblock halign-left valign-top"><strong>Message</strong></th>
<th class="tableblock halign-left valign-top"><strong>Link</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TechnicalError</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An unexpected error has occurred! We apologize any inconvenience. Please try again later.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/m-m-m/util/blob/master/exception/src/main/java/net/sf/mmm/util/exception/api/TechnicalErrorUserException.java">TechnicalErrorUserException.java</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ServiceInvoke</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#xAB;original message of the cause&#xBB;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/m-m-m/util/blob/master/exception/src/main/java/net/sf/mmm/util/exception/api/ServiceInvocationFailedException.java">ServiceInvocationFailedException.java</a></p></td>
</tr>
</tbody>
</table>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-i18n.asciidoc">9.18. Internationalization</h3>
<div class="paragraph">
<p>Internationalization (I18N) is about writing code independent from locale-specific information.
For I18N of text messages we are suggesting
<a href="http://m-m-m.sourceforge.net/apidocs/net/sf/mmm/util/nls/api/package-summary.html#documentation">mmm native-language-support</a>.</p>
</div>
<div class="paragraph">
<p>In devonfw we have developed a solution to manage text internationalization. devonfw solution comes into two aspects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bind locale information to the user.</p>
</li>
<li>
<p>Get the messages in the current user locale.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="guide-i18n.asciidoc_binding-locale-information-to-the-user">9.18.1. Binding locale information to the user</h4>
<div class="paragraph">
<p>We have defined two different points to bind locale information to user, depending on user is authenticated or not.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User not authenticated: devonfw intercepts unsecured request and extract locale from it. At first, we try to extract a <code>language</code> parameter from the request and if it is not possible, we extract locale from &#xC0;ccept-language` header.</p>
</li>
<li>
<p>User authenticated. During login process, applications developers are responsible to fill <code>language</code> parameter in the UserProfile class. This <code>language</code> parameter could be obtain from DB, LDAP, request, etc. In devonfw sample we get the locale information from database.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This image shows the entire process:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/i18n.png" alt="Internationalization">
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-i18n.asciidoc_getting-internationalizated-messages">9.18.2. Getting internationalizated messages</h4>
<div class="paragraph">
<p>devonfw has a bean that manage i18n message resolution, the <code>ApplicationLocaleResolver.</code> This bean is responsible to get the current user and extract locale information from it and read the correct properties file to get the message.</p>
</div>
<div class="paragraph">
<p>The i18n properties file must be called <code>ApplicationMessages_la_CO.properties</code> where la=language and CO=country. This is an example of a i18n properties file for English language to translate devonfw sample user roles:</p>
</div>
<div class="paragraph">
<p>ApplicationMessages_en_US.properties</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>waiter=Waiter
chief=Chief
cook=Cook
barkeeper=Barkeeper</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should define an ApplicationMessages_la_CO.properties file for every language that your application needs.</p>
</div>
<div class="paragraph">
<p><code>ApplicationLocaleResolver</code> bean is injected in <code>AbstractComponentFacade</code> class so you have available this bean in logic layer so you only need to put this code to get an internationalized message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">String msg = getApplicationLocaleResolver().getMessage(&quot;mymessage&quot;);</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-xml.asciidoc">9.19. XML</h3>
<div class="paragraph">
<p><a href="http://en.wikipedia.org/wiki/XML">XML</a> (Extensible Markup Language) is a W3C standard format for structured information. It has a large eco-system of additional standards and tools.</p>
</div>
<div class="paragraph">
<p>In Java there are many different APIs and frameworks for accessing, producing and processing XML. For the devonfw we recommend to use <a href="master-devon4j.asciidoc_guides.html#guide-xml.asciidoc_jaxb">JAXB</a> for mapping Java objects to XML and vice-versa. Further there is the popular <a href="http://docs.oracle.com/javase/7/docs/api/org/w3c/dom/package-summary.html">DOM API</a> for reading and writing smaller XML documents directly. When processing large XML documents <a href="http://en.wikipedia.org/wiki/StAX">StAX</a> is the right choice.</p>
</div>
<div class="sect3">
<h4 id="guide-xml.asciidoc_jaxb">9.19.1. JAXB</h4>
<div class="paragraph">
<p>We use <a href="http://en.wikipedia.org/wiki/Java_Architecture_for_XML_Binding">JAXB</a> to serialize Java objects to XML or vice-versa.</p>
</div>
<div class="sect4">
<h5 id="guide-xml.asciidoc_jaxb-and-inheritance">JAXB and Inheritance</h5>
<div class="paragraph">
<p>TODO @XmlSeeAlso
<a href="http://stackoverflow.com/questions/7499735/jaxb-how-to-create-xml-from-polymorphic-classes" class="bare">http://stackoverflow.com/questions/7499735/jaxb-how-to-create-xml-from-polymorphic-classes</a></p>
</div>
</div>
<div class="sect4">
<h5 id="guide-xml.asciidoc_jaxb-custom-mapping">JAXB Custom Mapping</h5>
<div class="paragraph">
<p>In order to map custom <a href="master-devon4j.asciidoc_guides.html#guide-datatype.asciidoc">datatypes</a> or other types that do not follow the Java bean conventions, you need to define a custom mapping. If you create dedicated objects dedicated for the XML mapping you can easily avoid such situations. When this is not suitable follow these instructions to define the mapping: TODO</p>
</div>
<div class="paragraph">
<p><a href="https://weblogs.java.net/blog/kohsuke/archive/2005/09/using_jaxb_20s.html" class="bare">https://weblogs.java.net/blog/kohsuke/archive/2005/09/using_jaxb_20s.html</a></p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-json.asciidoc">9.20. JSON</h3>
<div class="paragraph">
<p><a href="http://en.wikipedia.org/wiki/JSON">JSON</a> (JavaScript Object Notation) is a popular format to represent and exchange data especially for modern web-clients. For mapping Java objects to JSON and vice-versa there is no official standard API. We use the established and powerful open-source solution <a href="http://wiki.fasterxml.com/JacksonHome">Jackson</a>.
Due to problems with the wiki of fasterxml you should try this alternative link: <a href="https://github.com/FasterXML/jackson#jackson-project-home-github">Jackson/AltLink</a>.</p>
</div>
<div class="sect3">
<h4 id="guide-json.asciidoc_configure-json-mapping">9.20.1. Configure JSON Mapping</h4>
<div class="paragraph">
<p>In order to avoid polluting business objects with proprietary Jackson annotations (e.g. <code>@JsonTypeInfo</code>, <code>@JsonSubTypes</code>, <code>@JsonProperty</code>) we propose to create a separate configuration class. Every devonfw application (sample or any app created from our <a href="master-devon4j.asciidoc_tutorials.html#tutorial-newapp.asciidoc">app-template</a>) therefore has a class called <code>ApplicationObjectMapperFactory</code> that extends ObjectMapperFactory from the devon4j-rest module. It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named(&quot;ApplicationObjectMapperFactory&quot;)
public class ApplicationObjectMapperFactory extends ObjectMapperFactory {

  public RestaurantObjectMapperFactory() {
    super();
    // JSON configuration code goes here
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-json.asciidoc_json-and-inheritance">9.20.2. JSON and Inheritance</h4>
<div class="paragraph">
<p>If you are using inheritance for your objects mapped to JSON then polymorphism can not be supported out-of-the box. So in general avoid polymorphic objects in JSON mapping. However, this is not always possible.
Have a look at the following example from our sample application:</p>
</div>
<div id="guide-json.asciidoc_img-rest-inheritance" class="imageblock" style="text-align: center">
<div class="content">
<img src="images/REST-Inheritance.png" alt="inheritance class diagram">
</div>
<div class="title">Figure 25. Transfer-Objects using Inheritance</div>
</div>
<div class="paragraph">
<p>Now assume you have a <a href="guide-service-layer.html#rest">REST service operation</a> as Java method that takes a ProductEto as argument. As this is an abstract class the server needs to know the actual sub-class to instantiate.
We typically do not want to specify the classname in the JSON as this should be an implementation detail and not part of the public JSON format (e.g. in case of a service interface). Therefore we use a symbolic name for each polymorphic subtype that is provided as virtual attribute @type within the JSON data of the object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{ &quot;@type&quot;: &quot;Drink&quot;, ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore you add configuration code to the constructor of <a href="master-devon4j.asciidoc_guides.html#guide-json.asciidoc_configure-json-mapping">ApplicationObjectMapperFactory</a>. Here you can see an example from the sample application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">setBaseClasses(ProductEto.class);
addSubtypes(new NamedType(MealEto.class, &quot;Meal&quot;), new NamedType(DrinkEto.class, &quot;Drink&quot;),
  new NamedType(SideDishEto.class, &quot;SideDish&quot;));</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use <code>setBaseClasses</code> to register all top-level classes of polymorphic objects. Further we declare all concrete polymorphic sub-classes together with their symbolic name for the JSON format via <code>addSubtypes</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-json.asciidoc_custom-mapping">9.20.3. Custom Mapping</h4>
<div class="paragraph">
<p>In order to map custom <a href="master-devon4j.asciidoc_guides.html#guide-datatype.asciidoc">datatypes</a> or other types that do not follow the Java bean conventions, you need to define a custom mapping. If you create objects dedicated for the JSON mapping you can easily avoid such situations. When this is not suitable follow these instructions to define the mapping:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As an example, the use of JSR354 (<code>javax.money</code>) is appreciated in order to process monetary amounts properly. However, without custom mapping, the default mapping of Jackson will produce the following JSON for a <code>MonetaryAmount</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">&quot;currency&quot;: {&quot;defaultFractionDigits&quot;:2, &quot;numericCode&quot;:978, &quot;currencyCode&quot;:&quot;EUR&quot;},
&quot;monetaryContext&quot;: {...},
&quot;number&quot;:6.99,
&quot;factory&quot;: {...}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As clearly can be seen, the JSON contains too much information and reveals implementation secrets that do not belong here. Instead the JSON output expected and desired would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">&quot;currency&quot;:&quot;EUR&quot;,&quot;amount&quot;:&quot;6.99&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even worse, when we send the JSON data to the server, Jackson will see that <code>MonetaryAmount</code> is an interface and does not know how to instantiate it so the request will fail.
Therefore we need a customized <a href="https://github.com/FasterXML/jackson-docs/wiki/JacksonHowToCustomSerializers">Serializer</a>.</p>
</div>
</li>
<li>
<p>We implement <code>MonetaryAmountJsonSerializer</code> to define how a <code>MonetaryAmount</code> is serialized to JSON:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public final class MonetaryAmountJsonSerializer extends JsonSerializer&lt;MonetaryAmount&gt; {

  public static final String NUMBER = &quot;amount&quot;;
  public static final String CURRENCY = &quot;currency&quot;;

  public void serialize(MonetaryAmount value, JsonGenerator jgen, SerializerProvider provider) throws ... {
    if (value != null) {
      jgen.writeStartObject();
      jgen.writeFieldName(MonetaryAmountJsonSerializer.CURRENCY);
      jgen.writeString(value.getCurrency().getCurrencyCode());
      jgen.writeFieldName(MonetaryAmountJsonSerializer.NUMBER);
      jgen.writeString(value.getNumber().toString());
      jgen.writeEndObject();
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>For composite datatypes it is important to wrap the info as an object (<code>writeStartObject()</code> and <code>writeEndObject()</code>). <code>MonetaryAmount</code> provides the information we need by the <code>getCurrency()</code> and <code>getNumber()</code>. So that we can easily write them into the JSON data.</p>
</div>
</li>
<li>
<p>Next, we implement <code>MonetaryAmountJsonDeserializer</code> to define how a <code>MonetaryAmount</code> is deserialized back as Java object from JSON:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public final class MonetaryAmountJsonDeserializer extends AbstractJsonDeserializer&lt;MonetaryAmount&gt; {
  protected MonetaryAmount deserializeNode(JsonNode node) {
    BigDecimal number = getRequiredValue(node, MonetaryAmountJsonSerializer.NUMBER, BigDecimal.class);
    String currencyCode = getRequiredValue(node, MonetaryAmountJsonSerializer.CURRENCY, String.class);
    MonetaryAmount monetaryAmount =
        MonetaryAmounts.getAmountFactory().setNumber(number).setCurrency(currencyCode).create();
    return monetaryAmount;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For composite datatypes we extend from <a href="https://github.com/devonfw/devon4j/blob/develop/modules/rest/src/main/java/com/devonfw/module/rest/service/impl/json/AbstractJsonDeserializer.java"><code>AbstractJsonDeserializer</code></a> as this makes our task easier. So we already get a <code>JsonNode</code> with the parsed payload of our datatype. Based on this API it is easy to retrieve individual fields from the payload without taking care of their order, etc.
<code>AbstractJsonDeserializer</code> also provides methods such as <code>getRequiredValue</code> to read required fields and get them converted to the desired basis datatype. So we can easily read the amount and currency and construct an instance of <code>MonetaryAmount</code> via the official factory API.</p>
</div>
</li>
<li>
<p>Finally we need to register our custom (de)serializers with the following configuration code in the constructor of <a href="master-devon4j.asciidoc_guides.html#guide-json.asciidoc_configure-json-mapping">ApplicationObjectMapperFactory</a>:+</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>  SimpleModule module = getExtensionModule();
  module.addDeserializer(MonetaryAmount.class, new MonetaryAmountJsonDeserializer());
  module.addSerializer(MonetaryAmount.class, new MonetaryAmountJsonSerializer());</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can read and write <code>MonetaryAmount</code> from and to JSON as expected.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-rest.asciidoc">9.21. REST</h3>
<div class="paragraph">
<p>REST (<a href="https://en.wikipedia.org/wiki/Representational_state_transfer">REpresentational State Transfer</a>) is an inter-operable protocol for <a href="master-devon4j.asciidoc_layers.html#guide-service-layer.asciidoc">services</a> that is more lightweight than <a href="master-devon4j.asciidoc_guides.html#guide-soap.asciidoc">SOAP</a>.
However, it is no real standard and can cause confusion. Therefore we define best practices here to guide you.
<strong>ATTENTION:</strong>
REST and RESTful often implies very strict and specific rules and conventions. However different people will often have different opinions of such rules. We learned that this leads to &quot;religious discussions&quot; (starting from <code>PUT</code> vs. <code>POST</code> and IDs in path vs. payload up to Hypermedia and <a href="https://en.wikipedia.org/wiki/HATEOAS">HATEOAS</a>). These &quot;religious discussions&quot; waste a lot of time and money without adding real value in case of common business applications (if you publish your API on the internet to billions of users this is a different story). Therefore we give best practices that lead to simple, easy and pragmatic &quot;HTTP APIs&quot; (to avoid the term &quot;REST services&quot; and end &quot;religious discussions&quot;). Please also note that we do not want to assault anybody nor force anyone to follow our guidelines. Please read the following best practices carefully and be aware that they might slightly differ from what your first hit on the web will say about REST (see e.g. <a href="http://restcookbook.com/">RESTful cookbook</a>).</p>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_urls">9.21.1. URLs</h4>
<div class="paragraph">
<p>URLs are not case sensitive. Hence, we follow the best practice to use only lower-case-letters-with-hyphen-to-separate-words.
For operations in REST we distinguish the following types of URLs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>collection URL</em> is build from the rest service URL by appending the name of a collection. This is typically the name of an entity. Such URI identifies the entire collection of all elements of this type. Example: <code>https://mydomain.com/myapp/services/rest/mycomponent/v1/myentity</code></p>
</li>
<li>
<p>An <em>element URL</em> is build from a collection URL by appending an element ID. It identifies a single element (entity) within the collection. Example: <code>https://mydomain.com/myapp/services/rest/mycomponent/v1/myentity/42</code></p>
</li>
<li>
<p>A <em>search URL</em> is build from a collection URL by appending the segment <code>search</code>. The search criteria is send as <code>POST</code>. Example: <code>https://mydomain.com/myapp/services/rest/mycomponent/v1/myentity/search</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This fits perfect for <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> operations. For business operations (processing, calculation, etc.) we simply create a collection URL with the name of the business operation instead of the entity name (use a clear naming convention to avoid collisions). Then we can <code>POST</code> the input for the business operation and get the result back.</p>
</div>
<div class="paragraph">
<p>If you want to provide an entity with a different structure do not append further details to an element URL but create a separate collection URL as base.
So use <code>https://mydomain.com/myapp/services/rest/mycomponent/v1/myentity-with-details/42</code> instead of <code>https://mydomain.com/myapp/services/rest/mycomponent/v1/myentity/42/with-details</code>.
For offering a <a href="guide-transferobject.html#CTO">CTO</a> simply append <code>-cto</code> to the collection URL (e.g. <code>&#x2026;&#x200B;/myentity-cto/</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_http-methods">9.21.2. HTTP Methods</h4>
<div class="paragraph">
<p>While REST was designed as a pragmatical approach it sometimes leads to &quot;religious discussions&quot; e.g. about using <code>PUT</code> vs. <code>POST</code> (see ATTENTION notice above).
As the devonfw has a string focus on usual business applications it proposes a more &quot;pragmatic&quot; approach to REST services.</p>
</div>
<div class="paragraph">
<p>On the next table we compare the main differences between the &quot;canonical&quot; REST approach (or RESTful) and the devonfw proposal.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Usage of HTTP methods</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>HTTP Method</strong></th>
<th class="tableblock halign-left valign-top"><strong>RESTful Meaning</strong></th>
<th class="tableblock halign-left valign-top"><strong>devonfw</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read single element.</p>
<p class="tableblock">Search on an entity (with parametrized url)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read a single element.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PUT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Replace entity data.</p>
<p class="tableblock">Replace entire collection (typically not supported)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not used</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a new element in the collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create or update an element in the collection.</p>
<p class="tableblock">Search on an entity (parametrized post body)</p>
<p class="tableblock">Bulk deletion.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete an entity.</p>
<p class="tableblock">Delete an entire collection (typically not supported)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete an entity.</p>
<p class="tableblock">Delete an entire collection (typically not supported)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Please consider these guidelines and rationales:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We use <code>POST</code> on the collection URL to save an entity (<code>create</code> if no ID provided in payload otherwise <code>update</code>). This avoids pointless discussions in distinctions between <code>PUT</code> and <code>POST</code> and what to do if a <code>create</code> contains an ID in the payload or if an <code>update</code> is missing the ID property or contains a different ID in payload than in URL.</p>
</li>
<li>
<p>Hence, we do NOT use <code>PUT</code> but always use <code>POST</code> for write operations. As we always have a technical ID for each entity, we can simply distinguish create and update by the presence of the ID property.</p>
</li>
<li>
<p>Please also note that for (large) bulk deletions you may be forced to used <code>POST</code> instead of <code>DELETE</code> as according to the HTTP standard <code>DELETE</code> must not have payload and URLs are limited in length.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_http-status-codes">9.21.3. HTTP Status Codes</h4>
<div class="paragraph">
<p>Further we define how to use the HTTP status codes for REST services properly. In general the 4xx codes correspond to an error on the client side and the 5xx codes to an error on the server side.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Usage of HTTP status codes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>HTTP Code</strong></th>
<th class="tableblock halign-left valign-top"><strong>Meaning</strong></th>
<th class="tableblock halign-left valign-top"><strong>Response</strong></th>
<th class="tableblock halign-left valign-top"><strong>Comment</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">requested result</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result of successful GET</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">204</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Content</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>none</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result of successful POST, DELETE, or PUT (void return)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bad Request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error details</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The HTTP request is invalid (parse error, validation failed)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unauthorized</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>none</em> (security)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication failed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">403</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forbidden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>none</em> (security)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorization failed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">404</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not found</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>none</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either the service URL is wrong or the requested resource does not exist</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server Error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error code, UUID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Internal server error occurred (used for all technical exceptions)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_metadata">9.21.4. Metadata</h4>
<div class="paragraph">
<p>devonfw has support for the following metadata in REST service invocations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Further information</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">X-Correlation-Id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP header for a <em>correlation ID</em> that is a unique identifier to associate different requests belonging to the same session / action</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="master-devon4j.asciidoc_guides.html#guide-logging.asciidoc">Logging guide</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation errors</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standardized format for a service to communicate validation errors to the client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server-side validation is documented in the <a href="master-devon4j.asciidoc_guides.html#guide-validation.asciidoc">Validation guide</a>.</p>
<p class="tableblock">The protocol to communicate these validation errors to the client is worked on at <a href="https://github.com/oasp/oasp4j/issues/218" class="bare">https://github.com/oasp/oasp4j/issues/218</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pagination</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standardized format for a service to offer paginated access to a list of entities</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server-side support for pagination is documented in the <a href="guide-repository.html#pagination">Repository Guide</a>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_jax-rs">9.21.5. JAX-RS</h4>
<div class="paragraph">
<p>For implementing REST services we use the <a href="https://jax-rs-spec.java.net/">JAX-RS</a> standard. As an implementation we recommend <a href="http://cxf.apache.org/">CXF</a>. For <a href="master-devon4j.asciidoc_guides.html#guide-json.asciidoc">JSON</a> bindings we use <a href="http://wiki.fasterxml.com/JacksonHome">Jackson</a> while <a href="master-devon4j.asciidoc_guides.html#guide-xml.asciidoc">XML</a> binding works out-of-the-box with <a href="http://www.oracle.com/technetwork/articles/javase/index-140168.html">JAXB</a>.
To implement a service you write an interface with JAX-RS annotations for the API and a regular implementation class annotated with <code>@Named</code> to make it a spring-bean. Here is a simple example:
com.devonfw.application.mtsj.dishmanagement.service.impl.rest</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Path(&quot;/imagemanagement/v1&quot;)
@Consumes(MediaType.APPLICATION_JSON)
@Produces(MediaType.APPLICATION_JSON)
public interface ImagemanagementRestService {

  @GET
  @Path(&quot;/image/{id}/&quot;)
  public ImageEto getImage(@PathParam(&quot;id&quot;) long id);

}

@Named(&quot;ImagemanagementRestService&quot;)
public class ImagemanagementRestServiceImpl implements ImagemanagementRestService {

  @Inject
  private Imagemanagement imagemanagement;

  @Override
  public ImageEto getImage(long id) {

    return this.imagemanagement.findImage(id);
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see a REST service for the <a href="architecture.html#business-architecture">business component</a> <code>imagemanagement</code>. The method <code>getImage</code> can be accessed via HTTP GET (see <code>@GET</code>) under the URL path <code>imagemanagement/image/{id}</code> (see <code>@Path</code> annotations) where <code>{id}</code> is the ID of the requested table and will be extracted from the URL and provided as parameter <code>id</code> to the method <code>getImage</code>. It will return its result (<code>ImageEto</code>) as <a href="master-devon4j.asciidoc_guides.html#guide-json.asciidoc">JSON</a> (see <code>@Produces</code> - should already be defined as defaults in <code>RestService</code> marker interface). As you can see it delegates to the <a href="master-devon4j.asciidoc_layers.html#guide-logic-layer.asciidoc">logic</a> component <code>imagemanagement</code> that contains the actual business logic while the service itself only exposes this logic via HTTP. The REST service implementation is a regular CDI bean that can use <a href="master-devon4j.asciidoc_guides.html#guide-dependency-injection.asciidoc">dependency injection</a>.
The separation of the API as a Java interface allows to use it for <a href="master-devon4j.asciidoc_guides.html#guide-service-client.asciidoc">service client calls</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
With JAX-RS it is important to make sure that each service method is annotated with the proper HTTP method (<code>@GET</code>,<code>@POST</code>,etc.) to avoid unnecessary debugging. So you should take care not to forget to specify one of these annotations.
</td>
</tr>
</tbody></table>
</div>
<div class="sect4">
<h5 id="guide-rest.asciidoc_jax-rs-configuration">JAX-RS Configuration</h5>
<div class="paragraph">
<p>Starting from CXF 3.0.0 it is possible to enable the auto-discovery of JAX-RS roots.</p>
</div>
<div class="paragraph">
<p>When the jaxrs server is instantiated all the scanned root and provider beans (beans annotated with <code>javax.ws.rs.Path</code> and <code>javax.ws.rs.ext.Provider</code>) are configured.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_rest-exception-handling">9.21.6. REST Exception Handling</h4>
<div class="paragraph">
<p>For exceptions a service needs to have an exception fa&#xE7;ade that catches all exceptions and handles them by writing proper log messages and mapping them to a HTTP response with an according <a href="#http-status-codes.asciidoc">HTTP status code</a>. Therefore the devonfw provides a generic solution via <code>RestServiceExceptionFacade</code>. You need to follow the <a href="master-devon4j.asciidoc_guides.html#guide-exceptions.asciidoc">exception guide</a> so that it works out of the box because the fa&#xE7;ade needs to be able to distinguish between business and technical exceptions.
Now your service may throw exceptions but the fa&#xE7;ade with automatically handle them for you.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_recommendations-for-rest-requests-and-responses">9.21.7. Recommendations for REST requests and responses</h4>
<div class="paragraph">
<p>The devonfw proposes, for simplicity, a deviation from the common REST pattern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using <code>POST</code> for updates (instead of <code>PUT</code>)</p>
</li>
<li>
<p>Using the payload for addressing resources on POST (instead of identifier on the <code>URL</code>)</p>
</li>
<li>
<p>Using parametrized <code>POST</code> for searches</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This use of REST will lead to simpler code both on client and on server. We discuss this use on the next points.</p>
</div>
<div class="paragraph">
<p>The following table specifies how to use the HTTP methods (verbs) for collection and element URIs properly (see <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer#Applied_to_web_services">wikipedia</a>).</p>
</div>
<div class="sect4">
<h5 id="guide-rest.asciidoc_unparameterized-loading-of-a-single-resource">Unparameterized loading of a single resource</h5>
<div class="ulist">
<ul>
<li>
<p><strong>HTTP Method</strong>: <code>GET</code></p>
</li>
<li>
<p><strong>URL example</strong>: <code>/products/123</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For loading of a single resource, embed the <code>identifier</code> of the resource in the URL (for example <code>/products/123</code>).</p>
</div>
<div class="paragraph">
<p>The response contains the resource in JSON format, using a JSON object at the top-level, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    &quot;name&quot;: &quot;Steak&quot;,
    &quot;color&quot;: &quot;brown&quot;
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-rest.asciidoc_unparameterized-loading-of-a-collection-of-resources">Unparameterized loading of a collection of resources</h5>
<div class="ulist">
<ul>
<li>
<p><strong>HTTP Method</strong>: <code>GET</code></p>
</li>
<li>
<p><strong>URL example</strong>: <code>/products</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For loading of a collection of resources, make sure that the size of the collection can never exceed a reasonable maximum size. For parameterized loading (searching, pagination), see below.</p>
</div>
<div class="paragraph">
<p>The response contains the collection in JSON format, using a JSON object at the top-level, and the actual collection underneath a <code>result</code> key, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    &quot;result&quot;: [
        {
            &quot;name&quot;: &quot;Steak&quot;,
            &quot;color&quot;: &quot;brown&quot;
        },
        {
            &quot;name&quot;: &quot;Broccoli&quot;,
            &quot;color&quot;: &quot;green&quot;
        }
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-rest.asciidoc_saving-a-resource">Saving a resource</h5>
<div class="ulist">
<ul>
<li>
<p><strong>HTTP Method</strong>: <code>POST</code></p>
</li>
<li>
<p><strong>URL example</strong>: <code>/products</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The resource will be passed via JSON in the request body. If updating an existing resource, include the resource&#x2019;s <code>identifier</code> in the JSON and not in the URL, in order to avoid ambiguity.</p>
</div>
<div class="paragraph">
<p>If saving was successful, an empty HTTP 204 response is generated.</p>
</div>
<div class="paragraph">
<p>If saving was unsuccessful, refer below for the format to return errors to the client.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-rest.asciidoc_parameterized-loading-of-a-resource">Parameterized loading of a resource</h5>
<div class="ulist">
<ul>
<li>
<p><strong>HTTP Method</strong>: <code>POST</code></p>
</li>
<li>
<p><strong>URL example</strong>: <code>/products/search</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to differentiate from an unparameterized load, a special <em>subpath</em> (for example <code>search</code>) is introduced. The parameters are passed via JSON in the request body. An example of a simple, paginated search would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    &quot;status&quot;: &quot;OPEN&quot;,
    &quot;pagination&quot;: {
        &quot;page&quot;: 2,
        &quot;size&quot;: 25
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response contains the requested page of the collection in JSON format, using a JSON object at the top-level, the actual page underneath a <code>result</code> key, and additional pagination information underneath a <code>pagination</code> key, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    &quot;pagination&quot;: {
        &quot;page&quot;: 2,
        &quot;size&quot;: 25,
        &quot;total&quot;: null
    },
    &quot;result&quot;: [
        {
            &quot;name&quot;: &quot;Steak&quot;,
            &quot;color&quot;: &quot;brown&quot;
        },
        {
            &quot;name&quot;: &quot;Broccoli&quot;,
            &quot;color&quot;: &quot;green&quot;
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compare the code needed on server side to accept this request:
com.devonfw.application.mtsj.dishmanagement.service.api.rest</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Path(&quot;/category/search&quot;)
  @POST
  public PaginatedListTo&lt;CategoryEto&gt; findCategorysByPost(CategorySearchCriteriaTo searchCriteriaTo) {
    return this.dishmanagement.findCategoryEtos(searchCriteriaTo);
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the equivalent code required if doing it the RESTful way by issuing a <code>GET</code> request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> @Path(&quot;/category/search&quot;)
  @POST @Path(&quot;/order&quot;)
  @GET
  public PaginatedListTo&lt;CategoryEto&gt; findCategorysByPost( @Context UriInfo info) {

    RequestParameters parameters = RequestParameters.fromQuery(info);
    CategorySearchCriteriaTo criteria = new CategorySearchCriteriaTo();
    criteria.setName(parameters.get(&quot;name&quot;, Long.class, false));
    criteria.setDescription(parameters.get(&quot;description&quot;, OrderState.class, false));
    criteria.setShowOrder(parameters.get(&quot;showOrder&quot;, OrderState.class, false));
    return this.dishmanagement.findCategoryEtos(criteria);

  }</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="guide-rest.asciidoc_pagination-details">Pagination details</h6>
<div class="paragraph">
<p>The client can choose to request a count of the total size of the collection, for example to calculate the total number of available pages. It does so, by specifying the <code>pagination.total</code> property with a value of <code>true</code>.</p>
</div>
<div class="paragraph">
<p>The service is free to honour this request. If it chooses to do so, it returns the total count as the <code>pagination.total</code> property in the response.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-rest.asciidoc_deletion-of-a-resource">Deletion of a resource</h5>
<div class="ulist">
<ul>
<li>
<p><strong>HTTP Method</strong>: <code>DELETE</code></p>
</li>
<li>
<p><strong>URL example</strong>: <code>/products/123</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For deletion of a single resource, embed the <code>identifier</code> of the resource in the URL (for example <code>/products/123</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-rest.asciidoc_error-results">Error results</h5>
<div class="paragraph">
<p>The general format for returning an error to the client is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    &quot;message&quot;: &quot;A human-readable message describing the error&quot;,
    &quot;code&quot;: &quot;A code identifying the concrete error&quot;,
    &quot;uuid&quot;: &quot;An identifier (generally the correlation id) to help identify corresponding requests in logs&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the error is caused by a failed validation of the entity, the above format is extended to also include the list of individual validation errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
    &quot;message&quot;: &quot;A human-readable message describing the error&quot;,
    &quot;code&quot;: &quot;A code identifying the concrete error&quot;,
    &quot;uuid&quot;: &quot;An identifier (generally the correlation id) to help identify corresponding requests in logs&quot;,
    &quot;errors&quot;: {
        &quot;property failing validation&quot;: [
            &quot;First error message on this property&quot;,
            &quot;Second error message on this property&quot;
        ],
        // ....
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_rest-media-types">9.21.8. REST Media Types</h4>
<div class="paragraph">
<p>The payload of a REST service can be in any format as REST by itself does not specify this. The most established ones that the devonfw recommends are <a href="master-devon4j.asciidoc_guides.html#guide-xml.asciidoc">XML</a> and <a href="master-devon4j.asciidoc_guides.html#guide-json.asciidoc">JSON</a>. Follow these links for further details and guidance how to use them properly. <code>JAX-RS</code> and <code>CXF</code> properly support these formats (<code>MediaType.APPLICATION_JSON</code> and <code>MediaType.APPLICATION_XML</code> can be specified for <code>@Produces</code> or <code>@Consumes</code>). Try to decide for a single format for all services if possible and NEVER mix different formats in a service.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_rest-testing">9.21.9. REST Testing</h4>
<div class="paragraph">
<p>For testing REST services in general consult the <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc">testing guide</a>.</p>
</div>
<div class="paragraph">
<p>For manual testing REST services there are browser plugins:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Firefox: <a href="https://addons.mozilla.org/en-US/firefox/addon/httprequester/">httprequester</a> (or <a href="https://addons.mozilla.org/en-US/firefox/addon/poster/">poster</a>)</p>
</li>
<li>
<p>Chrome: <a href="http://www.getpostman.com/">postman</a> (<a href="https://chrome.google.com/webstore/detail/advanced-rest-client/hgmloofddffdnphfgcellkdfbfbjeloo">advanced-rest-client</a>)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="guide-rest.asciidoc_security">9.21.10. Security</h4>
<div class="paragraph">
<p>Your services are the major entry point to your application. Hence security considerations are important here.</p>
</div>
<div class="sect4">
<h5 id="guide-rest.asciidoc_csrf">CSRF</h5>
<div class="paragraph">
<p>A common security threat is <a href="https://www.owasp.org/index.php/Top_10_2013-A8-Cross-Site_Request_Forgery_(CSRF)">CSRF</a> for REST services. Therefore all REST operations that are performing modifications (PUT, POST, DELETE, etc. - all except GET) have to be secured against CSRF attacks. In devon4j we are using spring-security that already solves CSRF token generation and verification. The integration is part of the application template as well as the sample-application.</p>
</div>
<div class="paragraph">
<p>For testing in development environment the CSRF protection can be disabled using the JVM option <code>-DCsrfDisabled=true</code> when starting the application.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-rest.asciidoc_json-top-level-arrays">JSON top-level arrays</h5>
<div class="paragraph">
<p>OWASP suggests to prevent returning JSON arrays at the top-level, to prevent attacks (see <a href="https://www.owasp.org/index.php/OWASP_AJAX_Security_Guidelines" class="bare">https://www.owasp.org/index.php/OWASP_AJAX_Security_Guidelines</a>). However, no rationale is given at OWASP. We digged deep and found <a href="http://haacked.com/archive/2008/11/20/anatomy-of-a-subtle-json-vulnerability.aspx/">anatomy-of-a-subtle-json-vulnerability</a>. To sum it up the attack is many years old and does not work in any recent or relevant browser. Hence it is fine to use arrays as top-level result in a JSON REST service (means you can return <code>List&lt;Foo&gt;</code> in a Java JAX-RS service).</p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-soap.asciidoc">9.22. SOAP</h3>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/SOAP">SOAP</a> is a common protocol for <a href="master-devon4j.asciidoc_layers.html#guide-service-layer.asciidoc">services</a> that is rather complex and heavy. It allows to build inter-operable and well specified services (see WSDL). SOAP is transport neutral what is not only an advantage. We strongly recommend to use HTTPS transport and ignore additional complex standards like WS-Security and use established HTTP-Standards such as RFC2617 (and RFC5280).</p>
</div>
<div class="sect3">
<h4 id="guide-soap.asciidoc_jax-ws">9.22.1. JAX-WS</h4>
<div class="paragraph">
<p>For building web-services with Java we use the <a href="https://jcp.org/en/jsr/detail?id=224">JAX-WS</a> standard.
There are two approaches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>code first</p>
</li>
<li>
<p>contract first</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example in case you define a code-first service.</p>
</div>
<div class="sect4">
<h5 id="guide-soap.asciidoc_web-service-interface">Web-Service Interface</h5>
<div class="paragraph">
<p>We define a regular interface to define the API of the service and annotate it with JAX-WS annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@WebService
public interface TablemanagmentWebService {

  @WebMethod
  @WebResult(name = &quot;message&quot;)
  TableEto getTable(@WebParam(name = &quot;id&quot;) String id);

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-soap.asciidoc_web-service-implementation">Web-Service Implementation</h5>
<div class="paragraph">
<p>And here is a simple implementation of the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
@WebService(endpointInterface = &quot;com.devonfw.application.mtsj.tablemanagement.service.api.ws.TablemanagmentWebService&quot;)
public class TablemanagementWebServiceImpl implements TablemanagmentWebService {

  private Tablemanagement tableManagement;

  @Override
  public TableEto getTable(String id) {

    return this.tableManagement.findTable(id);
  }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-soap.asciidoc_soap-custom-mapping">9.22.2. SOAP Custom Mapping</h4>
<div class="paragraph">
<p>In order to map custom <a href="master-devon4j.asciidoc_guides.html#guide-datatype.asciidoc">datatypes</a> or other types that do not follow the Java bean conventions, you need to write adapters for JAXB (see <a href="master-devon4j.asciidoc_guides.html#guide-xml.asciidoc">XML</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-soap.asciidoc_soap-testing">9.22.3. SOAP Testing</h4>
<div class="paragraph">
<p>For testing SOAP services in general consult the <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc">testing guide</a>.</p>
</div>
<div class="paragraph">
<p>For testing SOAP services manually we strongly recommend <a href="http://www.soapui.org/">SoapUI</a>.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-service-client.asciidoc">9.23. Service Client</h3>
<div class="paragraph">
<p>This guide is about consuming (calling) services from other applications (micro-services). For providing services see the <a href="master-devon4j.asciidoc_layers.html#guide-service-layer.asciidoc">Service-Layer Guide</a>. Services can be consumed in the <a href="master-devon4j.asciidoc_layers.html#guide-client-layer.asciidoc">client</a> or the server. As the client is typically not written in Java you should consult the according guide for your client technology. In case you want to call a service within your Java code this guide is the right place to get help.</p>
</div>
<div class="sect3">
<h4 id="guide-service-client.asciidoc_motivation">9.23.1. Motivation</h4>
<div class="paragraph">
<p>Various solutions already exist for calling services such as <code>RestTemplate</code> from spring or the JAX-RS client API. Further each and every service framework offers its own API as well. These solutions might be suitable for very small and simple projects (with one or two such invocations). However, with the trend of microservices the invocation of a service becomes a very common use-case that occurs all over the place. Have a look at the following features to get an idea why you want to use the solution offered here.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-service-client.asciidoc_requirements">9.23.2. Requirements</h4>
<div class="paragraph">
<p>You need to add (at least one of) these dependencies to your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- Starter for consuming REST services --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.devonfw.java.starters&lt;/groupId&gt;
  &lt;artifactId&gt;devon4j-starter-cxf-client-rest&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- Starter for consuming SOAP services --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.devonfw.java.starters&lt;/groupId&gt;
  &lt;artifactId&gt;devon4j-starter-cxf-client-ws&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-service-client.asciidoc_features">9.23.3. Features</h4>
<div class="paragraph">
<p>When invoking a service you need to consider many cross-cutting aspects. You might not think about them in the very first place and you do not want to implement them multiple times redundantly. Therefore you should consider using this approach. The following sub-sections list the covered features and aspects:</p>
</div>
<div class="sect4">
<h5 id="guide-service-client.asciidoc_simple-usage">Simple usage</h5>
<div class="paragraph">
<p>Assuming you already have a Java interface <code>MyService</code> of the service you want to invoke:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.company.department.foo.mycomponent.service.api.rest;
...

@Path(&quot;/myservice&quot;)
public interface MyService extends RestService {

  @POST
  @Path(&quot;/getresult&quot;)
  MyResult getResult(MyArgs myArgs);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then all you need to do is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
public class UcMyUseCaseImpl extends MyUseCaseBase implements UcMyUseCase {
  @Inject
  private ServiceClientFactory serviceClientFactory;

  ...
  private MyResult callMyServiceMethod(MyArgs myArgs) {
    MyService myService = this.serviceClientFactory.create(MyService.class);
    MyResult myResult = myService.myMethod(myArgs); // synchronous call of service over the wire
    return myResult;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the synchronous invocation of a service is very simple. Still it is very flexible and powerful (see following features). The actual call of <code>myMethod</code> will technically call the remote service over the wire (e.g. via HTTP) including marshaling the arguments (e.g. converting <code>myArgs</code> to JSON) and unmarshalling the result (e.g. converting the received JSON to <code>myResult</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-service-client.asciidoc_configuration">Configuration</h5>
<div class="paragraph">
<p>This solution allows a very flexible configuration on the following levels:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Global configuration (defaults)</p>
</li>
<li>
<p>Configuration per remote service application (microservice)</p>
</li>
<li>
<p>Configuration per invocation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A configuration on a deeper level (e.g. 3) overrides the configuration from a higher level (e.g. 1).</p>
</div>
<div class="paragraph">
<p>The configuration on Level 1 and 2 are configured via <code>application.properties</code>
(see <a href="master-devon4j.asciidoc_guides.html#guide-configuration.asciidoc">configuration guide</a>).
For Level 1 the prefix <code>service.client.default.</code> is used for properties.
Further, for level 2. the prefix <code>service.client.app.&#xAB;application&#xBB;.</code> is used where <code>&#xAB;application&#xBB;</code> is the
technical name of the application providing the service. This name will automatically be derived from
the java package of the service interface (e.g. <code>foo</code> in <code>MyService</code> interface before) following our
<a href="coding-conventions.html#packages">packaging conventions</a>.
In case these conventions are not met it will fallback to the fully qualified name of the service interface.</p>
</div>
<div class="paragraph">
<p>Configuration on Level 3 has to be provided as <code>Map</code> argument to the method
<code>ServiceClientFactory.create(Class&lt;S&gt; serviceInterface, Map&lt;String, String&gt; config)</code>.
The keys of this <code>Map</code> will not use prefixes (such as the ones above). For common configuration
parameters a type-safe builder is offered to create such map via <code>ServiceClientConfigBuilder</code>.
E.g. for testing you may want to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">this.serviceClientFactory.create(MyService.class,
  new ServiceClientConfigBuilder().authBasic().userLogin(login).userPassword(password).buildMap());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>TODO</strong> add configuration properties for external/mock service from Sneha
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="guide-service-client.asciidoc_service-discovery">Service Discovery</h5>
<div class="paragraph">
<p>You do not want to hardwire service URLs in your code, right? Therefore different strategies might apply
to <em>discover</em> the URL of the invoked service. This is done internally by an implementation of the interface
<code>ServiceDiscoverer</code>. The default implementation simply reads the base URL from the configuration (see above).
So you can simply add this to your <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>service.client.app.foo.url=https://foo.company.com:8443/services/rest
service.client.app.bar.url=http://bar.company.com:8080/services/rest
service.client.default.url=https://api.company.com/services/rest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming your service interface would have the fully qualified name
<code>com.company.department.foo.mycomponent.service.api.rest.MyService</code> then the URL would be resolved to
<code><a href="https://foo.company.com:8443/services/rest" class="bare">https://foo.company.com:8443/services/rest</a></code> as the <code>&#xAB;application&#xBB;</code> is <code>foo</code>.</p>
</div>
<div class="paragraph">
<p>Additionally, the URL might use the following variables that will automatically be resolved:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>${app}</code> to <code>&#xAB;application&#xBB;</code> (useful for default URL)</p>
</li>
<li>
<p><code>${type}</code> to the type of the service. E.g. <code>rest</code> in case of a <a href="master-devon4j.asciidoc_guides.html#guide-rest.asciidoc">REST</a> service and <code>ws</code> for a <a href="master-devon4j.asciidoc_guides.html#guide-soap.asciidoc">SOAP</a> service.</p>
</li>
<li>
<p><code>${local.server.port}</code> for the port of your current Java servlet container running the JVM. Should only used for testing with spring-boot random port mechanism (technically spring can not resolve this variable but we do it for you here).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore, the default URL may also be configured as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>service.client.default.url=https://api.company.com/${app}/services/${type}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can use any implementation of <code>ServiceDiscoverer</code>, you can also easily use <a href="https://github.com/Netflix/eureka#eureka">eureka</a> (or anything else) instead to discover your services.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-service-client.asciidoc_headers">Headers</h5>
<div class="paragraph">
<p>A very common demand is to tweak (HTTP) headers in the request to invoke the service. May it be for security (authentication data) or for other cross-cutting concerns (such as the <a href="guide-logging.html#correlation-id">Correlation ID</a>). This is done internally by implementations of the interface  <code>ServiceHeaderCustomizer</code>.
We already provide several implementations such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ServiceHeaderCustomizerBasicAuth</code> for basic authentication (mainly for testing).</p>
</li>
<li>
<p><code>ServiceHeaderCustomizerOAuth</code> for OAuth (passes a security token from security context such as a <a href="https://jwt.io/">JWT</a> via OAuth).</p>
</li>
<li>
<p><code>ServiceHeaderCustomizerCorrelationId</code> passed the <a href="guide-logging.html#correlation-id">Correlation ID</a> to the service request.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, you can add further custom implementations of <code>ServiceHeaderCustomizer</code> for your individual requirements and additional headers.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-service-client.asciidoc_timeouts">Timeouts</h5>
<div class="paragraph">
<p>You can configure timeouts in a very flexible way. First of all you can configure timeouts to establish the connection (<code>timeout.connection</code>) and to wait for the response (<code>timeout.response</code>) separately. These timeouts can be configured on all three levels as described in the configuration section above.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-service-client.asciidoc_error-handling">Error Handling</h5>
<div class="paragraph">
<p>Whilst invoking a remote service an error may occur. This solution will automatically handle such errors and map them to a higher level <code>ServiceInvocationFailedException</code>. In general we separate two different types of errors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Network error</strong><br>
In such case (host not found, connection refused, time out, etc.) there is not even a response from the server. However, in advance to a low-level exception you will get a wrapped <code>ServiceInvocationFailedException</code> (with code <code>ServiceInvoke</code>) with a readable message containing the service that could not be invoked.</p>
</li>
<li>
<p><strong>Service error</strong><br>
In case the service failed on the server-side the <a href="guide-rest.html#error-results">error result</a> will be parsed and thrown as a <code>ServiceInvocationFailedException</code> with the received message and code.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="guide-service-client.asciidoc_logging">Logging</h5>
<div class="paragraph">
<p>By default this solution will log all invocations including the URL of the invoked service, success or error status flag and the duration in seconds (with decimal nano precision as available). Therefore you can easily monitor the status and performance of the service invocations.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-service-client.asciidoc_asynchronous-support">Asynchronous Support</h5>
<div class="paragraph">
<p>An important aspect is also asynchronous (and reactive) support. So far we only propose this as an enhancement for a future release with an API like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ServiceClientAsyncFactory extends ServiceClientFactory {
  AsyncClient&lt;S&gt; createAsync(Class&lt;S&gt; serviceInterface);
}

public interface AsyncClient&lt;S&gt; {
  S getClient();
  &lt;R&gt; Mono&lt;R&gt; call(R result);
  &lt;T&gt; Flux&lt;T&gt; call(Collection&lt;? extends T&gt; result);
  &lt;R&gt; void call(R result, Consumer&lt;R&gt; callback);
  &lt;R&gt; CompletableFuture&lt;R&gt; callFuture(R result);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This API would allow typesafe usage like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
public class UcMyUseCaseImpl extends MyUseCaseBase implements UcMyUseCase {
  @Inject private ServiceClientFactoryAsync clientFactory;

  @Override @RolesAllowed(...)
  public void doSomething(Bar bar) {
    AsyncClient&lt;MyExternalServiceApi&gt; client = this.clientFactory.createAsync(MyExternalServiceApi.class);
    Mono&lt;Some&gt; result = client.call(client.getService().doSomething(convert(bar)));
    // client.call(client.getService().doSomething(convert(bar)), x -&gt; processSync(x));
    return process(result);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>How can this work? The ServiceClientAsyncFactory implementation would create its own dynamic proxy for the given service interface. That proxy would only track the last call that was invoked internally and always return a dummy result (<code>null</code> for Object types, <code>false</code> for boolean, <code>0</code> for primitive numbers). The actual implementation of the <code>call</code> methods can access the internal invocation that has been recorded from the last service call. It will then trigger the actual service call internally according to the desired style (using a <code>Consumer</code> callback, <code>Mono</code>, <code>Flux</code>, <code>Future</code>&#x2026;&#x200B;).</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-service-client.asciidoc_resilience">Resilience</h5>
<div class="paragraph">
<p>Resilience adds a lot of complexity and that typically means that addressing this here would most probably result in not being up-to-date and not meeting all requirements. Therefore we recommend something completely different: the <em>sidecar</em> approach (based on <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar">sidecar pattern</a>). This means that you use a generic proxy app that runs as a separate process on the same host, VM, or container of your actual application. Then in your app you are calling the service via the sidecar proxy on <code>localhost</code> (service discovery URL is e.g. <code><a href="http://localhost:8081/${app}/services/${type}" class="bare">http://localhost:8081/${app}/services/${type}</a></code>) that then acts as proxy to the actual remote service. Now aspects such as resilience with circuit breaking and the actual service discovery can be configured in the sidecar proxy app and independent of your actual application. Therefore, you can even share and reuse configuration and experience with such a sidecar proxy app even across different technologies (Java, .NET/C#, Node.JS, etc.).</p>
</div>
<div class="paragraph">
<p>Various implementations of such sidecar proxy apps are available as free open source software.
<strong>TODO</strong>: Decide for the best available solution and suggest here as default.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Netflix Sidecar - see <a href="http://cloud.spring.io/spring-cloud-netflix/single/spring-cloud-netflix.html#_polyglot_support_with_sidecar">Spring Cloud Netflix docs</a></p>
</li>
<li>
<p><a href="https://lyft.github.io/envoy/">Envoy</a> - see <a href="https://dzone.com/articles/microservices-patterns-with-envoy-sidecar-proxy-pa">Microservices Patterns With Envoy Sidecar Proxy</a></p>
</li>
<li>
<p><a href="https://github.com/netflix/Prana">Prana</a> - see <a href="https://medium.com/netflix-techblog/prana-a-sidecar-for-your-netflix-paas-based-applications-and-services-258a5790a015">Prana: A Sidecar for your Netflix PaaS based Applications and Services</a> &#x2190; <strong>Not updated as it&#x2019;s not used internally by Netflix</strong></p>
</li>
<li>
<p>Keycloak - see <a href="http://www.hawkular.org/blog/2017/07/jaeger-with-security-proxy.html">Protecting Jaeger UI with a sidecar security proxy</a></p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-testing.asciidoc">9.24. Testing</h3>
<div class="sect3">
<h4 id="guide-testing.asciidoc_general-best-practices">9.24.1. General best practices</h4>
<div class="paragraph">
<p>For testing please follow our general best practices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tests should have a clear goal that should also be documented.</p>
</li>
<li>
<p>Tests have to be classified into different <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc_integration-levels">integration levels</a>.</p>
</li>
<li>
<p>Tests should follow a clear naming convention.</p>
</li>
<li>
<p>Automated tests need to properly assert the result of the tested operation(s) in a reliable way. E.g. avoid stuff like <code>assertThat(service.getAllEntities()).hasSize(42)</code> or even worse tests that have no assertion at all.</p>
</li>
<li>
<p>Tests need to be independent of each other. Never write test-cases or tests (in Java @Test methods) that depend on another test to be executed before.</p>
</li>
<li>
<p>Use <a href="http://joel-costigliola.github.io/assertj/">AssertJ</a> to write good readable and maintainable tests that also provide valuable feedback in case a test fails. Do not use legacy JUnit methods like <code>assertEquals</code> anymore!</p>
</li>
<li>
<p>For easy understanding divide your test in three commented sections:</p>
<div class="ulist">
<ul>
<li>
<p><code>//given</code></p>
</li>
<li>
<p><code>//when</code></p>
</li>
<li>
<p><code>//then</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Plan your tests and test data management properly before implementing.</p>
</li>
<li>
<p>Instead of having a too strong focus on test coverage better ensure you have covered your critical core functionality properly and review the code including tests.</p>
</li>
<li>
<p>Test code shall NOT be seen as second class code. You shall consider design, architecture and code-style also for your test code but do not over-engineer it.</p>
</li>
<li>
<p>Test automation is good but should be considered in relation to cost per use. Creating full coverage via <em>automated system tests</em> can cause a massive amount of test-code that can turn out as a huge maintenance hell. Always consider all aspects including product life-cycle, criticality of use-cases to test, and variability of the aspect to test (e.g. UI, test-data).</p>
</li>
<li>
<p>Use continuous integration and establish that the entire team wants to have clean builds and running tests.</p>
</li>
<li>
<p>Prefer delegation over inheritance for cross-cutting testing functionality. Good places to put this kind of code can be realized and reused via the JUnit @Rule mechanism.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="guide-testing.asciidoc_test-automation-technology-stack">9.24.2. Test Automation Technology Stack</h4>
<div class="paragraph">
<p>For test automation we use <a href="http://junit.org/">JUnit</a>. However, we are strictly doing all assertions with <a href="http://joel-costigliola.github.io/assertj/">AssertJ</a>. For <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc_test-doubles">mocking</a> we use <a href="http://mockito.org/">mockito</a>.
In order to mock remote connections we use <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc_wiremock">wiremock</a>.
For testing entire components or sub-systems we recommend to use <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-testing.html">spring-boot-starter-test</a> as lightweight and fast testing infrastructure that is already shipped with <code>devon4j-test</code>.</p>
</div>
<div class="paragraph">
<p>In case you have to use a full blown JEE application server, we recommend to use <a href="http://arquillian.org/">arquillian</a>. To get started with arquillian, look <a href="http://arquillian.org/guides/getting_started/index.html#add_the_arquillian_apis">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-testing.asciidoc_test-doubles">9.24.3. Test Doubles</h4>
<div class="paragraph">
<p>We use <a href="http://xunitpatterns.com/Using%20Test%20Doubles.html">test doubles</a> as generic term for mocks, stubs, fakes, dummies, or spys to avoid confusion. Here is a short summary from <a href="http://martinfowler.com/articles/mocksArentStubs.html">stubs VS mocks</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Dummy</strong> objects specifying no logic at all. May declare data in a POJO style to be used as boiler plate code to parameter lists or even influence the control flow towards the test&#x2019;s needs.</p>
</li>
<li>
<p><strong>Fake</strong> objects actually have working implementations, but usually take some shortcut which makes them not suitable for production (an in memory database is a good example).</p>
</li>
<li>
<p><strong>Stubs</strong> provide canned answers to calls made during the test, usually not responding at all to anything outside what&#x2019;s programmed in for the test. Stubs may also record information about calls, such as an email gateway stub that remembers the messages it &apos;sent&apos;, or maybe only how many messages it &apos;sent&apos;.</p>
</li>
<li>
<p><strong>Mocks</strong> are objects pre-programmed with expectations, which form a specification of the calls they are expected to receive.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We try to give some examples, which should make it somehow clearer:</p>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_stubs">Stubs</h5>
<div class="paragraph">
<p>Best Practices for applications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A good way to replace small to medium large boundary systems, whose impact (e.g. latency) should be ignored during load and performance tests of the application under development.</p>
</li>
<li>
<p>As stub implementation will rely on state-based verification, there is the threat, that test developers will partially reimplement the state transitions based on the replaced code. This will immediately lead to a black maintenance whole, so better use mocks to assure the certain behavior on interface level.</p>
</li>
<li>
<p>Do NOT use stubs as basis of a large amount of test cases as due to state-based verification of stubs, test developers will enrich the stub implementation to become a large monster with its own hunger after maintenance efforts.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_mocks">Mocks</h5>
<div class="paragraph">
<p>Best Practices for applications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace not-needed dependencies of your system-under-test (SUT) to minimize the application context to start of your component framework.</p>
</li>
<li>
<p>Replace dependencies of your SUT to impact the control flow under test without establishing all the context parameters needed to match the control flow.</p>
</li>
<li>
<p>Remember: Not everything has to be mocked! Especially on lower levels of tests like isolated module tests you can be betrayed into a mocking delusion, where you end up in a hundred lines of code mocking the whole context and five lines executing the test and verifying the mocks behavior. Always keep in mind the benefit-cost ratio, when implementing tests using mocks.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_wiremock">Wiremock</h5>
<div class="paragraph">
<p>If you need to mock remote connections such as HTTP-Servers, wiremock offers easy to use functionality. For a full description see the <a href="http://wiremock.org/">homepage</a> or the <a href="https://github.com/tomakehurst/wiremock">github repository</a>. Wiremock can be used either as a JUnit Rule, in Java outside of JUnit or as a standalone process. The mocked server can be configured to respond to specific requests in a given way via a fluent Java API, JSON files and JSON over HTTP. An example as an integration to JUnit can look as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import static com.github.tomakehurst.wiremock.core.WireMockConfiguration.wireMockConfig;
import com.github.tomakehurst.wiremock.junit.WireMockRule;

public class WireMockOfferImport{

  @Rule
  public WireMockRule mockServer = new WireMockRule(wireMockConfig().dynamicPort());

  @Test
  public void requestDataTest() throws Exception {
  int port = this.mockServer.port();
  ...}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a server on a randomly chosen free port on the running machine. You can also specify the port to be used if wanted. Other than that there are several options to further configure the server. This includes HTTPs, proxy settings, file locations, logging and extensions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @Test
  public void requestDataTest() throws Exception {
      this.mockServer.stubFor(get(urlEqualTo(&quot;/new/offers&quot;)).withHeader(&quot;Accept&quot;, equalTo(&quot;application/json&quot;))
      .withHeader(&quot;Authorization&quot;, containing(&quot;Basic&quot;)).willReturn(aResponse().withStatus(200).withFixedDelay(1000)
      .withHeader(&quot;Content-Type&quot;, &quot;application/json&quot;).withBodyFile(&quot;/wireMockTest/jsonBodyFile.json&quot;)));
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will stub the URL <code>localhost:port/new/offers</code> to respond with a status 200 message containing a header (<code>Content-Type: application/json</code>) and a body with content given in <code>jsonBodyFile.json</code> if the request matches several conditions.
It has to be a GET request to <code>../new/offers</code> with the two given header properties.</p>
</div>
<div class="paragraph">
<p>Note that by default files are located in <code>src/test/resources/__files/</code>. When using only one WireMock server one can omit the <code>this.mockServer</code> in before the <code>stubFor</code> call (static method).
You can also add a fixed delay to the response or processing delay with <code>WireMock.addRequestProcessingDelay(time)</code> in order to test for timeouts.</p>
</div>
<div class="paragraph">
<p>WireMock can also respond with different corrupted messages to simulate faulty behaviour.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Test(expected = ResourceAccessException.class)
public void faultTest() {

    this.mockServer.stubFor(get(urlEqualTo(&quot;/fault&quot;)).willReturn(aResponse()
    .withFault(Fault.MALFORMED_RESPONSE_CHUNK)));
...}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A GET request to <code>../fault</code> returns an OK status header, then garbage, and then closes the connection.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-testing.asciidoc_integration-levels">9.24.4. Integration Levels</h4>
<div class="paragraph">
<p>There are many discussions about the right level of integration for test automation. Sometimes it is better to focus on small, isolated modules of the system - whatever a &quot;module&quot; may be. In other cases it makes more sense to test integrated groups of modules. Because there is no universal answer to this question, devonfw only defines a common terminology for what could be tested. Each project must make its own decision where to put the focus of test automation. There is no worldwide accepted terminology for the integration levels of testing. In general we consider <a href="http://istqbexamcertification.com/what-are-software-testing-levels/">ISTQB</a>. However, with a technical focus on test automation we want to get more precise.</p>
</div>
<div class="paragraph">
<p>The following picture shows a simplified view of an application based on the <a href="architecture.html#technical-architecture">devonfw reference architecture</a>. We define four integration levels that are explained in detail below.
The boxes in the picture contain parenthesized numbers. These numbers depict the lowest integration level, a box belongs to. Higher integration levels also contain all boxes of lower integration levels. When writing tests for a given integration level, related boxes with a lower integration level must be replaced by test <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc_test-doubles">doubles</a> or drivers.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/integration-levels.png" alt="Integration Levels">
</div>
</div>
<div class="paragraph">
<p>The main difference between the integration levels is the amount of infrastructure needed to test them. The more infrastructure you need, the more bugs you will find, but the more instable and the slower your tests will be. So each project has to make a trade-off between pros and contras of including much infrastructure in tests and has to select the integration levels that fit best to the project.</p>
</div>
<div class="paragraph">
<p>Consider, that more infrastructure does not automatically lead to a better bug-detection. There may be bugs in your software that are masked by bugs in the infrastructure. The best way to find those bugs is to test with very few infrastructure.</p>
</div>
<div class="paragraph">
<p>External systems do not belong to any of the integration levels defined here. devonfw does not recommend involving real external systems in test automation. This means, they have to be replaced by test <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc_test-doubles">doubles</a> in automated tests. An exception may be external systems that are fully under control of the own development team.</p>
</div>
<div class="paragraph">
<p>The following chapters describe the four integration levels.</p>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_level-1-module-test">Level 1 Module Test</h5>
<div class="paragraph">
<p>The goal of a <em>isolated module test</em> is to provide fast feedback to the developer. Consequently, isolated module tests must not have any interaction with the client, the database, the file system, the network, etc.</p>
</div>
<div class="paragraph">
<p>An isolated module test is testing a single classes or at least a small set of classes in isolation. If such classes depend on other components or external resources, etc. these shall be replaced with a <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc_test-doubles">test double</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyClassTest extends ModuleTest {

  @Test
  public void testMyClass() {

    // given
    MyClass myClass = new MyClass();
    // when
    String value = myClass.doSomething();
    // then
    assertThat(value).isEqualTo(&quot;expected value&quot;);
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For an advanced example see <a href="https://github.com/devonfw/devon4j/blob/develop/modules/rest/src/test/java/com/devonfw/module/rest/service/impl/RestServiceExceptionFacadeTest.java">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_level-2-component-test">Level 2 Component Test</h5>
<div class="paragraph">
<p>A <a href="http://istqbexamcertification.com/what-is-component-testing/"><em>component test</em></a> aims to test components or component parts as a unit.
These tests typically run with a (light-weight) infrastructure such as spring-boot-starter-test and can access resources such as a database (e.g. for DAO tests).
Further, no remote communication is intended here. Access to external systems shall be replaced by a <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc_test-doubles">test double</a>.</p>
</div>
<div class="paragraph">
<p>With devon4j and spring you can write a component-test as easy as illustrated in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootTest(classes = { MySpringBootApp.class }, webEnvironment = WebEnvironment.NONE)
public class UcFindCountryTest extends ComponentTest {
  @Inject
  private UcFindCountry ucFindCountry;

  @Test
  public void testFindCountry() {

    // given
    String countryCode = &quot;de&quot;;

    // when
    TestUtil.login(&quot;user&quot;, MyAccessControlConfig.FIND_COUNTRY);
    CountryEto country = this.ucFindCountry.findCountry(countryCode);

    // then
    assertThat(country).isNotNull();
    assertThat(country.getCountryCode()).isEqualTo(countryCode);
    assertThat(country.getName()).isEqualTo(&quot;Germany&quot;);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This test will start the entire spring-context of your app (<code>MySpringBootApp</code>). Within the test spring will inject according spring-beans into all your fields annotated with <code>@Inject</code>. In the test methods you can use these spring-beans and perform your actual tests. This pattern can be used for testing DAOs/Repositories, Use-Cases, or any other spring-bean with its entire configuration including database and transactions.</p>
</div>
<div class="paragraph">
<p>When you are testing use-cases your <a href="guide-access-control.html#configuration-on-java-method-level">authorization</a> will also be in place. Therefore, you have to simulate a logon in advance what is done via the <code>login</code> method in the above example.  The test-infrastructure will automatically do a <code>logout</code> for you after each test method in <code>doTearDown</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_level-3-subsystem-test">Level 3 Subsystem Test</h5>
<div class="paragraph">
<p>A <em>subsystem test</em> runs against the external interfaces (e.g. HTTP service) of the integrated subsystem. Subsystem tests of the client subsystem are described in the <a href="https://github.com/devonfw/devon4ng/blob/master/documentation/guide-testing">devon4ng testing guide</a>. In devon4j the server (JEE application) is the subsystem under test. The tests act as a client (e.g. service consumer) and the server has to be integrated and started in a container.</p>
</div>
<div class="paragraph">
<p>With devon4j and spring you can write a subsystem-test as easy as illustrated in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootTest(classes = { MySpringBootApp.class }, webEnvironment = WebEnvironment.RANDOM_PORT)
public class CountryRestServiceTest extends SubsystemTest {

  @Inject
  private ServiceClientFactory serviceClientFactory;

  @Test
  public void testFindCountry() {

    // given
    String countryCode = &quot;de&quot;;

    // when
    CountryRestService service = this.serviceClientFactory.create(CountryRestService.class);
    CountryEto country = service.findCountry(countryCode);

    // then
    assertThat(country).isNotNull();
    assertThat(country.getCountryCode()).isEqualTo(countryCode);
    assertThat(country.getName()).isEqualTo(&quot;Germany&quot;);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even though not obvious on the first look this test will start your entire application as a server on a free random port (so that it works in CI with parallel builds for different branches) and tests the invocation of a (REST) service including (un)marshalling of data (e.g. as JSON) and transport via HTTP (all in the invocation of the <code>findCountry</code> method).</p>
</div>
<div class="paragraph">
<p>Do not confuse a <em>subsystem test</em> with a <a href="http://istqbexamcertification.com/what-is-system-integration-testing/">system integration test</a>. A system integration test validates the interaction of several systems where we do not recommend test automation.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_level-4-system-test">Level 4 System Test</h5>
<div class="paragraph">
<p>A <a href="http://istqbexamcertification.com/what-is-system-testing/"><em>system test</em></a> has the goal to test the system as a whole against its official interfaces such as its UI or batches. The system itself runs as a separate process in a way close to a regular deployment. Only external systems are simulated by <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc_test-doubles">test doubles</a>.</p>
</div>
<div class="paragraph">
<p>The devonfw only gives advice for automated system test (TODO see allure testing framework). In nearly every project there must be manual system tests, too. This manual system tests are out of scope here.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_classifying-integration-levels">Classifying Integration-Levels</h5>
<div class="paragraph">
<p>devon4j defines <a href="https://github.com/devonfw/devon4j/tree/develop/modules/test/src/main/java/com/devonfw/module/test/common/api/category">Category-Interfaces</a> that shall be used as <a href="https://github.com/junit-team/junit/wiki/Categories">JUnit Categories</a>.
Also devon4j provides <a href="https://github.com/devonfw/devon4j/tree/develop/modules/test/src/main/java/com/devonfw/module/test/common/base">abstract base classes</a> that you may extend in your test-cases if you like.</p>
</div>
<div class="paragraph">
<p>devon4j further pre-configures the maven build to only run integration levels 1-2 by default (e.g. for fast feedback in continuous integration). It offers the profiles subsystemtest (1-3) and systemtest (1-4). In your nightly build you can simply add -Psystemtest to run all tests.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-testing.asciidoc_implementation">9.24.5. Implementation</h4>
<div class="paragraph">
<p>This section introduces how to implement tests on the different levels with the given devonfw infrastructure and the proposed frameworks.</p>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_module-test">Module Test</h5>
<div class="paragraph">
<p>In devon4j you can extend the abstract class <a href="https://github.com/devonfw/devon4j/blob/develop/modules/test/src/main/java/com/devonfw/module/test/common/base/ModuleTest.java">ModuleTest</a> to basically get access to assertions. In order to test classes embedded in dependencies  and external services one needs to provide mocks for that. As the <a href="master-devon4j.asciidoc_guides.html#guide-testing.asciidoc_test-automation-technology-stack">technology stack</a> recommends we use the Mockito framework to offer this functionality. The following example shows how to implement Mockito into a JUnit test.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import static org.mockito.Mockito.when;
import static org.mockito.Mockito.mock;
...

public class StaffmanagementImplTest extends ModuleTest {
  @Rule
  public MockitoRule rule = MockitoJUnit.rule();

  @Test
  public void testFindStaffMember() {
  ...}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the test class does not use the <code>@SpringApplicationConfiguration</code> annotation. In a module test one does not use the whole application.
The JUnit rule is the best solution to use in order to get all needed functionality of Mockito. Static imports are a convenient option to enhance readability within Mockito tests.
You can define mocks with the <code>@Mock</code> annotation or the <code>mock(*.class)</code> call. To inject the mocked objects into your class under test you can use the <code>@InjectMocks</code> annotation. This automatically uses the setters of <code>StaffmanagementImpl</code> to inject the defined mocks into the <em>class under test (CUT)</em> when there is a setter available. In this case the <code>beanMapper</code> and the <code>staffMemberDao</code> are injected. Of course it is possible to do this manually if you need more control.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @Mock
  private BeanMapper beanMapper;
  @Mock
  private StaffMemberEntity staffMemberEntity;
  @Mock
  private StaffMemberEto staffMemberEto;
  @Mock
  private StaffMemberDao staffMemberDao;
  @InjectMocks
  StaffmanagementImpl staffmanagementImpl = new StaffmanagementImpl();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mocked objects do not provide any functionality at the time being. To define what happens on a method call on a mocked dependency in the CUT one can use <code>when(<em>condition</em>).thenReturn(<em>result</em>)</code>. In this case we want to test <code>findStaffMember(Long id)</code> in the <a href="https://github.com/oasp/oasp4j/blob/master/samples/core/src/main/java/io/oasp/gastronomy/restaurant/staffmanagement/logic/impl/StaffmanagementImpl.java">StaffmanagementImpl</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public StaffMemberEto findStaffMember(Long id) {
  return getBeanMapper().map(getStaffMemberDao().find(id), StaffMemberEto.class);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this simple example one has to stub two calls on the CUT as you can see below. For example the method call of the CUT <code>staffMemberDao.find(id)</code> is stubbed for returning a mock object <code>staffMemberEntity</code> that is also defined as mock.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_subsystem-test">Subsystem Test</h5>
<div class="paragraph">
<p>devon4j provides a simple test infrastructure to aid with the implementation of subsystem tests. It becomes available by simply subclassing <a href="https://github.com/oasp/oasp4j/blob/master/samples/core/src/test/java/io/oasp/gastronomy/restaurant/general/common/base/AbstractRestServiceTest.java">AbstractRestServiceTest.java</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">//given
long id = 1L;
Class&lt;StaffMemberEto&gt; targetClass = StaffMemberEto.class;
when(this.staffMemberDao.find(id)).thenReturn(this.staffMemberEntity);
when(this.beanMapper.map(this.staffMemberEntity, targetClass)).thenReturn(this.staffMemberEto);

//when
StaffMemberEto resultEto = this.staffmanagementImpl.findStaffMember(id);

//then
assertThat(resultEto).isNotNull();
assertThat(resultEto).isEqualTo(this.staffMemberEto);</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the test method call one can verify the expected results. Mockito can check whether a mocked method call was indeed called. This can be done using Mockito <code>verify</code>. Note that it does not generate any value if you check for method calls that are needed to reach the asserted result anyway. Call verification can be useful e.g. when you want to assure that statistics are written out without actually testing them.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_todo">TODO</h5>
<div class="paragraph">
<p>As an example let us go to the class <a href="https://github.com/oasp/oasp4j/blob/master/samples/core/src/main/java/io/oasp/gastronomy/restaurant/tablemanagement/logic/api/Tablemanagement.java">Tablemanagement</a>. When testing the method <em>deleteTable()</em> there are several scenarios that can happen and thus should be covered by tests.</p>
</div>
<div class="paragraph">
<p>First let us see the valid conditions to delete a table:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One needs permission to delete a table <a href="https://github.com/oasp/oasp4j/blob/master/samples/core/src/main/java/io/oasp/gastronomy/restaurant/general/common/api/constants/PermissionConstants.java">PermissionConstants.DELETE_TABLE</a></p>
</li>
<li>
<p>The table to delete needs to exist (the table with the given id has to be in the database) and</p>
</li>
<li>
<p>The table to delete is required to be <a href="https://github.com/oasp/oasp4j/blob/master/samples/core/src/main/java/io/oasp/gastronomy/restaurant/tablemanagement/common/api/datatype/TableState.java">TableState.FREE</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Invalid conditions are: No credentials, table does not exist or table is not free.
If you combine one invalid condition with valid conditions this yields the following test cases. Note that not working actions yield exceptions that can be expected in a test method.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The caller of the method does not have the required credentials</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Test(expected = AccessDeniedException.class)
public void testDeleteTableWithoutCredentials() {...}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The caller has the required credentials but the table to be deleted is occupied</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Test(expected = IllegalEntityStateException.class)
public void testDeleteTableWithCredentialsButNotDeletable() {...}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The caller has the required credentials but the table to be deleted does not exist</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Test(expected = ObjectNotFoundUserException.class)
public void testDeleteTableWithCredentialsNotExisting() {...}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The caller has the required credentials and the table to be deleted exists and is free</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Test
public void testDeleteTableWithCredentials() {...}</pre>
</div>
</div>
<div class="paragraph">
<p>This type of testing is known as <a href="http://epf.eclipse.org/wikis/xp/xp/guidances/guidelines/equivalence_class_analysis_E178943D.html">equivalence class analysis</a>. Note that this is a general practice and can be applied to every level of tests.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-testing.asciidoc_deployment-pipeline">9.24.6. Deployment Pipeline</h4>
<div class="paragraph">
<p>A deployment pipeline is a semi-automated process that gets software-changes from version control into production. It contains several validation steps, e.g. automated tests of all integration levels.
Because devon4j should fit to different project types - from agile to waterfall - it does not define a standard deployment pipeline. But we recommend to define such a deployment pipeline explicitly for each project and to find the right place in it for each type of test.</p>
</div>
<div class="paragraph">
<p>For that purpose, it is advisable to have fast running test suite that gives as much confidence as possible without needing too much time and too much infrastructure. This test suite should run in an early stage of your deployment pipeline. Maybe the developer should run it even before he/she checked in the code. Usually lower integration levels are more suitable for this test suite than higher integration levels.</p>
</div>
<div class="paragraph">
<p>Note, that the deployment pipeline always should contain manual validation steps, at least manual acceptance testing. There also may be manual validation steps that have to be executed for special changes only, e.g. usability testing. Management and execution processes of those manual validation steps are currently not in the scope of devonfw.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-testing.asciidoc_test-coverage">9.24.7. Test Coverage</h4>
<div class="paragraph">
<p>We are using tools (SonarQube/Jacoco) to measure the coverage of the tests. Please always keep in mind that the only reliable message of a code coverage of X% is that (100-X)% of the code is entirely untested. It does not say anything about the quality of the tests or the software though it often relates to it.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-testing.asciidoc_test-configuration">9.24.8. Test Configuration</h4>
<div class="paragraph">
<p>This section covers test configuration in general without focusing on integration levels as in the first chapter.</p>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_configure-test-specific-beans">Configure Test Specific Beans</h5>
<div class="paragraph">
<p>Sometimes it can become handy to provide other or differently configured bean implementations via CDI than those available in production. For example, when creating beans using <code>@Bean</code>-annotated methods they are usually configured within those methods. <a href="https://github.com/oasp/oasp4j/blob/master/samples/core/src/main/java/io/oasp/gastronomy/restaurant/general/service/impl/config/WebSecurityBeansConfig.java">WebSecurityBeansConfig</a> shows an example of such methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
public class WebSecurityBeansConfig {
  //...
  @Bean
  public AccessControlSchemaProvider accessControlSchemaProvider() {
    // actually no additional configuration is shown here
    return new AccessControlSchemaProviderImpl();
  }
  //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>AccessControlSchemaProvider</code> allows to programmatically access data defined in some XML file, e.g. <code>access-control-schema.xml</code>. Now, one can imagine that it would be helpful if <code>AccessControlSchemaProvider</code> would point to some other file than the default within a test class. That file could provide content that differs from the default.
The question is: how can I change resource path of <code>AccessControlSchemaProviderImpl</code> within a test?</p>
</div>
<div class="paragraph">
<p>One very helpful solution is to use <strong>static inner classes</strong>.
Static inner classes can contain <code>@Bean</code> -annotated methods, and by placing them in the <code>classes</code> parameter in <code>@SpringBootTest(classes = { /* place class here*/ })</code> annotation the beans returned by these methods are placed in the application context during test execution. Combining this feature with inheritance allows to override methods defined in other configuration classes as shown in the following listing where <code>TempWebSecurityConfig</code> extends <code>WebSecurityBeansConfig</code>. This relationship allows to override <code>public AccessControlSchemaProvider accessControlSchemaProvider()</code>. Here we are able to configure the instance of type <code>AccessControlSchemaProviderImpl</code> before returning it (and, of course, we could also have used a completely different implementation of the <code>AccessControlSchemaProvider</code> interface). By overriding the method the implementation of the super class is ignored, hence, only the new implementation is called at runtime. Other methods defined in <code>WebSecurityBeansConfig</code> which are not overridden by the subclass are still dispatched to <code>WebSecurityBeansConfig</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">//... Other testing related annotations
@SpringBootTest(classes = { TempWebSecurityConfig.class })
public class SomeTestClass {

  public static class TempWebSecurityConfig extends WebSecurityBeansConfig {

    @Override
    @Bean
    public AccessControlSchemaProvider accessControlSchemaProvider() {

      ClassPathResource resource = new ClassPathResource(locationPrefix + &quot;access-control-schema3.xml&quot;);
      AccessControlSchemaProviderImpl accessControlSchemaProvider = new AccessControlSchemaProviderImpl();
      accessControlSchemaProvider.setAccessControlSchema(resource);
      return accessControlSchemaProvider;
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#testcontext-ctx-management-javaconfig">chapter of the Spring framework documentation</a> explains issue, but uses a slightly different way to obtain the configuration.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_test-data">Test Data</h5>
<div class="paragraph">
<p>It is possible to obtain test data in two different ways depending on your test&#x2019;s integration level.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-testing.asciidoc_debugging-tests">9.24.9. Debugging Tests</h4>
<div class="paragraph">
<p>The following two sections describe two debugging approaches for tests. Tests are either run from within the IDE or from the command line using Maven.</p>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_debugging-with-the-ide">Debugging with the IDE</h5>
<div class="paragraph">
<p>Debugging with the IDE is as easy as always. Even if you want to execute a <code>SubsystemTest</code> which needs a Spring context and a server infrastructure to run properly, you just set your breakpoints and click on Debug As &#x2192; JUnit Test. The test infrastructure will take care of initializing the necessary infrastructure - if everything is configured properly.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-testing.asciidoc_debugging-with-maven">Debugging with Maven</h5>
<div class="paragraph">
<p>Please refer to the following two links to find a guide for debugging tests when running them from Maven.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://maven.apache.org/surefire/maven-surefire-plugin/examples/debugging.html" class="bare">http://maven.apache.org/surefire/maven-surefire-plugin/examples/debugging.html</a></p>
</li>
<li>
<p><a href="https://www.eclipse.org/jetty/documentation/9.3.x/debugging-with-eclipse.html" class="bare">https://www.eclipse.org/jetty/documentation/9.3.x/debugging-with-eclipse.html</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In essence, you first have to start execute a test using the command line. Maven will halt just before the test execution and wait for your IDE to connect to the process. When receiving a connection the test will start and then pause at any breakpoint set in advance.
The first link states that tests are started through the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn -Dmaven.surefire.debug test</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although this is correct, it will run <em>every</em> test class in your project and - which is time consuming and mostly unnecessary - halt before each of these tests.
To counter this problem you can simply execute a single test class through the following command (here we execute the <code>TablemanagementRestServiceTest</code> from the restaurant sample application):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn test -Dmaven.surefire.debug test -Dtest=TablemanagementRestServiceTest</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to notice that you first have to execute the Maven command in the according submodule, e.g. to execute the <code>TablemanagementRestServiceTest</code> you have first to navigate to the core module&#x2019;s directory.</p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-transferobject.asciidoc">9.25. Transfer-Objects</h3>
<div class="paragraph">
<p>The technical data model is defined in form of <a href="guide-jpa.html#entity">persistent entities</a>.
However, passing persistent entities via <em>call-by-reference</em> across the entire application will soon cause problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Changes to a persistent entity are directly written back to the persistent store when the transaction is committed. When the entity is send across the application also changes tend to take place in multiple places endangering data sovereignty and leading to inconsistency.</p>
</li>
<li>
<p>You want to send and receive data via services across the network and have to define what section of your data is actually transferred. If you have relations in your technical model you quickly end up loading and transferring way too much data.</p>
</li>
<li>
<p>Modifications to your technical data model shall not automatically have impact on your external services causing incompatibilities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To prevent such problems transfer-objects are used leading to a <em>call-by-value</em> model and decoupling changes to persistent entities.</p>
</div>
<div class="paragraph">
<p>In the following sections the different types of transfer-objects are explained.
You will find all according naming-conventions in the <a href="coding-conventions.html#architecture-mapping">architecture-mapping</a></p>
</div>
<div class="sect4">
<h5 id="guide-transferobject.asciidoc_eto">ETO</h5>
<div class="paragraph">
<p>For each <a href="guide-jpa.html#entity">persistent entity</a> <code>&#xAB;BusinessObject&#xBB;Entity</code> we create or generate a corresponding <em>entity transfer object</em> (ETO) named <code>&#xAB;BusinessObject&#xBB;Eto</code>. It has the same properties except for relations.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-transferobject.asciidoc_bo">BO</h5>
<div class="paragraph">
<p>In order to centralize the properties (getters and setters with their javadoc) we create a common interface <code>&#xAB;BusinessObject&#xBB;</code> implemented both by the entity and its ETO. This also gives us compile-time safety that
<a href="master-devon4j.asciidoc_guides.html#guide-beanmapping.asciidoc">bean-mapper</a> can properly map all properties between entity and ETO.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-transferobject.asciidoc_cto">CTO</h5>
<div class="paragraph">
<p>If we need to pass an entity with its relation(s) we create a corresponding <em>composite transfer object</em> (CTO) named <code>&#xAB;BusinessObject&#xBB;&#xAB;Subset&#xBB;Cto</code> that only contains other transfer-objects or collections of them. Here <code>&#xAB;Subset&#xBB;</code> is empty for the canonical CTO that holds the ETO together with all its relations.
This is what can be generated automatically with <a href="https://github.com/devonfw/tools-cobigen">CobiGen</a>.
However, be careful to generate CTOs without thinking and considering design.
If there are no relations at all a CTO is pointless and shall be omitted.
However, if there are multiple relations you typically need  multiple CTOs for the same <code>&#xAB;BusinessObject&#xBB;</code> that define different subsets of the related data.
These will typically be designed and implemented by hand.
E.g. you may have <code>CustomerWithAddressCto</code> and <code>CustomerWithContractCto</code>. Most CTOs correspond to a specific <code>&#xAB;BusinessObject&#xBB;</code> and therefore contain a <code>&#xAB;BusinessObject&#xBB;Eto</code>. Such CTOs should inherit from <code>MasterCto</code>.</p>
</div>
<div class="paragraph">
<p>This pattern with entities, ETOs and CTOs is illustrated by the following UML diagram from our sample application.</p>
</div>
<div id="guide-transferobject.asciidoc_img-transfer-objects" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="images/transfer-objects.png"><img src="images/transfer-objects.png" alt="ETOs and CTOs"></a>
</div>
<div class="title">Figure 26. ETOs and CTOs</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-transferobject.asciidoc_to">9.25.4. TO</h4>
<div class="paragraph">
<p>Finally, there are typically transfer-objects for data that is never persistent. For very generic cases
these just carry the suffix <code>To</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-transferobject.asciidoc_searchcriteriato">9.25.5. SearchCriteriaTo</h4>
<div class="literalblock">
<div class="content">
<pre>For searching we create or generate a `&#xAB;BusinessObject&#xBB;SearchCriteriaTo` representing a query to find instances of `&#xAB;BusinessObject&#xBB;`.</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-transferobject.asciidoc_sto">9.25.6. STO</h4>
<div class="paragraph">
<p>We can potentially create separate <em>service transfer objects</em> (STO) (if possible named <code>&#xAB;BusinessObject&#xBB;Sto</code>) to keep the <a href="master-devon4j.asciidoc_layers.html#guide-service-layer.asciidoc">service</a> API stable and independent of the actual data-model.
However, we usually do not need this and want to keep our architecture simple.
Only create STOs if you need <a href="guide-service-layer.html#versioning">service versioning</a> and support previous APIs or to provide legacy service technologies that require their own isolated data-model.
In such case you also need <a href="master-devon4j.asciidoc_guides.html#guide-beanmapping.asciidoc">beanmapping</a> between STOs and ETOs what means extra effort and complexity that should be avoided.
In such case you also need <a href="master-devon4j.asciidoc_guides.html#guide-beanmapping.asciidoc">beanmapping</a> between STOs and ETOs what means extra effort and complexity that should be avoided.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-beanmapping.asciidoc">9.26. Bean-Mapping</h3>
<div class="paragraph">
<p>For decoupling you sometimes need to create separate objects (beans) for a different view. E.g. for an external service you will use a <a href="master-devon4j.asciidoc_guides.html#guide-transferobject.asciidoc">transfer-object</a> instead of the <a href="guide-jpa.html#entity">persistence entity</a> so internal changes to the entity do not implicitly change or break the service.</p>
</div>
<div class="paragraph">
<p>Therefore you have the need to map similar objects what creates a copy. This also has the benefit that modifications to the copy have no side-effect on the original source object. However, to implement such mapping code by hand is very tedious and error-prone (if new properties are added to beans but not to mapping code):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public UserEto mapUser(UserEntity source) {
  UserEto target = new UserEto();
  target.setUsername(source.getUsername());
  target.setEmail(source.getEmail());
  ...
  return target;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore we are using a <code>BeanMapper</code> for this purpose that makes our lives a lot easier.</p>
</div>
<div class="sect3">
<h4 id="guide-beanmapping.asciidoc_bean-mapper-dependency">9.26.1. Bean-Mapper Dependency</h4>
<div class="paragraph">
<p>To get access to the <code>BeanMapper</code> we use this dependency in our POM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;com.devonfw.java&lt;/groupId&gt;
      &lt;artifactId&gt;devon4j-beanmapping&lt;/artifactId&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-beanmapping.asciidoc_bean-mapper-configuration">9.26.2. Bean-Mapper Configuration</h4>
<div class="paragraph">
<p>The <code>BeanMapper</code> implementation is based on an existing open-source bean mapping framework.
In case of Dozer the mapping is configured <code>src/main/resources/config/app/common/dozer-mapping.xml</code>.</p>
</div>
<div class="paragraph">
<p>See the my-thai-star <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/resources/config/app/common/dozer-mapping.xml">dozer-mapping.xml</a> as an example.
Important is that you configure all your custom datatypes as <code>&lt;copy-by-reference&gt;</code> tags and have the mapping from <code>PersistenceEntity</code> (<code>ApplicationPersistenceEntity</code>) to <code>AbstractEto</code> configured properly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml"> &lt;mapping type=&quot;one-way&quot;&gt;
    &lt;class-a&gt;com.devonfw.module.basic.common.api.entity.PersistenceEntity&lt;/class-a&gt;
    &lt;class-b&gt;com.devonfw.module.basic.common.api.to.AbstractEto&lt;/class-b&gt;
    &lt;field custom-converter=&quot;com.devonfw.module.beanmapping.common.impl.dozer.IdentityConverter&quot;&gt;
      &lt;a&gt;this&lt;/a&gt;
      &lt;b is-accessible=&quot;true&quot;&gt;persistentEntity&lt;/b&gt;
    &lt;/field&gt;
&lt;/mapping&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-beanmapping.asciidoc_bean-mapper-usage">9.26.3. Bean-Mapper Usage</h4>
<div class="paragraph">
<p>Then we can get the <code>BeanMapper</code> via <a href="master-devon4j.asciidoc_guides.html#guide-dependency-injection.asciidoc">dependency-injection</a> what we typically already provide by an abstract base class (e.g. <code>AbstractUc</code>). Now we can solve our problem very easy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
UserEntity resultEntity = ...;
...
return getBeanMapper().map(resultEntity, UserEto.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also additional support for mapping entire collections.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-datatype.asciidoc">9.27. Datatypes</h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A datatype is an object representing a value of a specific type with the following aspects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It has a technical or business specific semantic.</p>
</li>
<li>
<p>Its JavaDoc explains the meaning and semantic of the value.</p>
</li>
<li>
<p>It is immutable and therefore stateless (its value assigned at construction time and can not be modified).</p>
</li>
<li>
<p>It is serializable.</p>
</li>
<li>
<p>It properly implements #equals(Object) and #hashCode() (two different instances with the same value are equal and have the same hash).</p>
</li>
<li>
<p>It shall ensure syntactical validation so it is NOT possible to create an instance with an invalid value.</p>
</li>
<li>
<p>It is responsible for formatting its value to a string representation suitable for sinks such as UI, loggers, etc. Also consider cases like a Datatype representing a password where toString() should return something like &quot;<strong><strong></strong></strong>**&quot; instead of the actual password to prevent security accidents.</p>
</li>
<li>
<p>It is responsible for parsing the value from other representations such as a string (as needed).</p>
</li>
<li>
<p>It shall provide required logical operations on the value to prevent redundancies. Due to the immutable attribute all manipulative operations have to return a new Datatype instance (see e.g. BigDecimal.add(java.math.BigDecimal)).</p>
</li>
<li>
<p>It should implement Comparable if a natural order is defined.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Based on the Datatype a presentation layer can decide how to view and how to edit the value. Therefore a structured data model should make use of custom datatypes in order to be expressive.
Common generic datatypes are String, Boolean, Number and its subclasses, Currency, etc.
Please note that both Date and Calendar are mutable and have very confusing APIs. Therefore, use JSR-310 or jodatime instead.
Even if a datatype is technically nothing but a String or a Number but logically something special it is worth to define it as a dedicated datatype class already for the purpose of having a central javadoc to explain it. On the other side avoid to introduce technical datatypes like String32 for a String with a maximum length of 32 characters as this is not adding value in the sense of a real Datatype.
It is suitable and in most cases also recommended to use the class implementing the datatype as API omitting a dedicated interface.</p>
</div>
</blockquote>
<div class="attribution">
&#x2014; mmm project<br>
<cite>datatype javadoc</cite>
</div>
</div>
<div class="paragraph">
<p>See <a href="http://m-m-m.sourceforge.net/apidocs/net/sf/mmm/util/lang/api/Datatype.html">mmm datatype javadoc</a>.</p>
</div>
<div class="sect3">
<h4 id="guide-datatype.asciidoc_datatype-packaging">9.27.1. Datatype Packaging</h4>
<div class="paragraph">
<p>For the devonfw we use a common <a href="coding-conventions.html#packages">packaging schema</a>.
The specifics for datatypes are as following:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Segment</strong></th>
<th class="tableblock halign-left valign-top"><strong>Value</strong></th>
<th class="tableblock halign-left valign-top"><strong>Explanation</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;component&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here we use the (business) component defining the datatype or general for generic datatypes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;layer&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">common</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datatypes are used across all layers and are not assigned to a dedicated layer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;scope&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datatypes are always used directly as API even tough they may contain (simple) implementation logic. Most datatypes are simple wrappers for generic Java types (e.g. String) but make these explicit and might add some validation.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="guide-datatype.asciidoc_technical-concerns">9.27.2. Technical Concerns</h4>
<div class="paragraph">
<p>Many technologies like Dozer and QueryDSL&#x2019;s (alias API) are heavily based on reflection. For them to work properly with custom datatypes, the frameworks must be able to instantiate custom datatypes with no-argument constructors. It is therefore recommended to implement a no-argument constructor for each datatype of at least protected visibility.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-datatype.asciidoc_datatypes-in-entities">9.27.3. Datatypes in Entities</h4>
<div class="paragraph">
<p>The usage of custom datatypes in entities is explained in the <a href="guide-jpa.html#entities-and-datatypes">persistence layer guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-datatype.asciidoc_datatypes-in-transfer-objects">9.27.4. Datatypes in Transfer-Objects</h4>
<div class="sect4">
<h5 id="guide-datatype.asciidoc_xml">XML</h5>
<div class="paragraph">
<p>For mapping datatypes with JAXB see <a href="master-devon4j.asciidoc_guides.html#guide-xml.asciidoc">XML guide</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="guide-datatype.asciidoc_json">JSON</h5>
<div class="paragraph">
<p>For mapping datatypes from and to JSON see <a href="guide-json.html#json-custom-mapping">JSON custom mapping</a>.</p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="guide-accessibility.asciidoc">9.28. Accessibility</h3>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p><a href="http://www.w3.org/TR/WCAG20/" class="bare">http://www.w3.org/TR/WCAG20/</a></p>
</div>
<div class="paragraph">
<p><a href="http://www.w3.org/WAI/intro/aria" class="bare">http://www.w3.org/WAI/intro/aria</a></p>
</div>
<div class="paragraph">
<p><a href="http://www.einfach-fuer-alle.de/artikel/bitv/" class="bare">http://www.einfach-fuer-alle.de/artikel/bitv/</a></p>
</div>
<div class="paragraph">
<p><a href="http://www.banu.bund.de" class="bare">http://www.banu.bund.de</a></p>
</div>
<div class="paragraph">
<p><a href="http://www.de.capgemini.com/public-sector/igov" class="bare">http://www.de.capgemini.com/public-sector/igov</a></p>
</div>
<!-- toc disabled -->
</div>
<div class="sect2">
<h3 id="guide-caching.asciidoc">9.29. Caching</h3>
<div class="paragraph">
<p>Caching is a technical approach to improve performance. While it may appear easy on the first sight it is an advanced topic. In general, try to use caching only when required for performance reasons. If you come to the point that you need caching first think about:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What to cache?<br>
Be sure about what you want to cache. Is it static data? How often will it change? What will happen if the data changes but due to caching you might receive &quot;old&quot; values? Can this be tolerated? For how long? This is not a technical question but a business requirement.</p>
</li>
<li>
<p>Where to cache?<br>
Will you cache data on client or server? Where exactly?</p>
</li>
<li>
<p>How to cache?<br>
Is a local cache sufficient or do you need a shared cache?</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="guide-caching.asciidoc_local-cache">9.29.1. Local Cache</h4>

</div>
<div class="sect3">
<h4 id="guide-caching.asciidoc_shared-cache">9.29.2. Shared Cache</h4>
<div class="sect4">
<h5 id="guide-caching.asciidoc_distributed-cache">Distributed Cache</h5>

</div>
</div>
<div class="sect3">
<h4 id="guide-caching.asciidoc_products">9.29.3. Products</h4>
<div class="ulist">
<ul>
<li>
<p><a href="http://ehcache.org/" class="bare">http://ehcache.org/</a></p>
</li>
<li>
<p><a href="http://hazelcast.org/" class="bare">http://hazelcast.org/</a></p>
</li>
<li>
<p><a href="http://terracotta.org/" class="bare">http://terracotta.org/</a></p>
</li>
<li>
<p><a href="http://memcached.org/" class="bare">http://memcached.org/</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="guide-caching.asciidoc_caching-of-web-resources">9.29.4. Caching of Web-Resources</h4>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.mobify.com/blog/beginners-guide-to-http-cache-headers/" class="bare">http://www.mobify.com/blog/beginners-guide-to-http-cache-headers/</a></p>
</li>
<li>
<p><a href="http://en.wikipedia.org/wiki/Web_cache#Cache_control" class="bare">http://en.wikipedia.org/wiki/Web_cache#Cache_control</a></p>
</li>
<li>
<p><a href="http://en.wikipedia.org/wiki/List_of_HTTP_header_fields#Avoiding_caching" class="bare">http://en.wikipedia.org/wiki/List_of_HTTP_header_fields#Avoiding_caching</a></p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-cors-support.asciidoc">9.30. CORS support</h3>
<div class="paragraph">
<p>When you are developing Javascript client and server application separately, you have to deal with cross domain issues. We have to request from a origin domain distinct to target domain and browser does not allow this.</p>
</div>
<div class="paragraph">
<p>So , we need to prepare server side to accept request from other domains. We need to cover the following points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Accept request from other domains.</p>
</li>
<li>
<p>Accept devonfw used headers like <code>X-CSRF-TOKEN</code> or <code>correlationId.</code></p>
</li>
<li>
<p>Be prepared to receive secured request (cookies).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is important to note that if you are using security in your request (sending cookies) you have to set  <code>withCredentials</code> flag to <code>true</code> in your client side request and deal with special IE8 characteristics.</p>
</div>
<div class="sect3">
<h4 id="guide-cors-support.asciidoc_configuring-cors-support">9.30.1. Configuring CORS support</h4>
<div class="paragraph">
<p>On the server side we have defined a new filter in Spring security chain filters to support CORS and we have configured devonfw security chain filter to use it.</p>
</div>
<div class="paragraph">
<p>You only have to change <code>CORSDisabled</code> property value in <code>application-default.properties</code> properties file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>#CORS support
security.cors.enabled=false</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-blob-support.asciidoc">9.31. BLOB support</h3>
<div class="sect3">
<h4 id="guide-blob-support.asciidoc_introduction">9.31.1. Introduction</h4>
<div class="paragraph">
<p>BLOB stands for <strong>B</strong>inary <strong>L</strong>arge <strong>Ob</strong>ject. A BLOB may be an image, an office document, ZIP archive or any other multimedia object. devon4j supports BLOB via its BinaryObject data type. The devonfw Maven archetype generates the following Java files for dealing with BLOBs:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>general.common.api.BinaryObject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface for a BinaryObject</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>general.dataaccess.api.BinaryObjectEntity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instance of BinaryObject entity, contains the actual BLOB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>general.dataaccess.api.dao.BinaryObjectDao.java</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DAO for BinaryObject entity</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>general.dataaccess.base.dao.BinaryObjectDaoImpl</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implementation of the BinaryObjectDao</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>general.logic.api.to.BinaryObjectEto</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ETO for BinaryObject</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>general.logic.base.UcManageBinaryObject</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use case for managing BinaryObject. This use case contains methods for finding, getting, deleting and saving a BLOB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>general.logic.impl.UCManageBinaryObjectImpl</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implementation of the UcManageBinaryObject</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="guide-blob-support.asciidoc_implementing-blob-support-an-example">9.31.2. Implementing BLOB support: an example</h4>
<div class="paragraph">
<p>In the sample application the business component Offermanagement uses BLOBs for product pictures.
Feel free to use the following approach as starting point for BLOB support in your application.</p>
</div>
<div class="sect4">
<h5 id="guide-blob-support.asciidoc_logic-layer">Logic Layer</h5>
<div class="paragraph">
<p>Use the methods declared in <code>general.logic.base.UcManageBinaryObject</code> in the implementation of your business component.
Let&#x2019;s take a look at an example from the sample application.</p>
</div>
<div class="paragraph">
<p>The method</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">OffermanagementImpl.updateProductPicture(Long productId, Blob blob, BinaryObjectEto binaryObjectEto)</code></pre>
</div>
</div>
<div class="paragraph">
<p>saves a new picture for a given product.</p>
</div>
<div class="paragraph">
<p>This is done by calling an appropriate method, declared in the BinaryObject use case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Override
@RolesAllowed(PermissionConstants.SAVE_PRODUCT_PICTURE)
public void updateProductPicture(Long productId, Blob blob, BinaryObjectEto binaryObjectEto) {

    ...
      binaryObjectEto = getUcManageBinaryObject().saveBinaryObject(blob, binaryObjectEto);
    ...
 }</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-blob-support.asciidoc_service-layer">Service Layer</h5>
<div class="paragraph">
<p>Following the devonfw conventions, you must implement a REST service for each business component. There you define, how BLOBs are uploaded/downloaded. According to that, the REST service for the business component Offermanagement is implemented in a class named OffermanagementRestServiceImpl.</p>
</div>
<div class="paragraph">
<p>The coding examples below are taken from the afore mentioned class.</p>
</div>
<div class="paragraph">
<p>The sample application uses the content-type &quot;multipart/mixed&quot; to transfer pictures plus additional header data.</p>
</div>
<div class="paragraph">
<p><strong>Upload</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Consumes(&quot;multipart/mixed&quot;)
@POST
@Path(&quot;/product/{id}/picture&quot;)
  public void updateProductPicture(@PathParam(&quot;id&quot;) long productId,
      @Multipart(value = &quot;binaryObjectEto&quot;, type = MediaType.APPLICATION_JSON) BinaryObjectEto binaryObjectEto,
      @Multipart(value = &quot;blob&quot;, type = MediaType.APPLICATION_OCTET_STREAM) InputStream picture)
      throws SerialException, SQLException, IOException {

    Blob blob = new SerialBlob(IOUtils.readBytesFromStream(picture));
    this.offerManagement.updateProductPicture(productId, blob, binaryObjectEto);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new Blob object is being created by reading the data (<code>IOUtils.readBytesFromStream(picture)</code>).</p>
</div>
<div class="paragraph">
<p><strong>Download</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Produces(&quot;multipart/mixed&quot;)
@GET
@Path(&quot;/product/{id}/picture&quot;)
public MultipartBody getProductPicture(@PathParam(&quot;id&quot;) long productId) throws SQLException, IOException {

    Blob blob = this.offerManagement.findProductPictureBlob(productId);
    byte[] data = IOUtils.readBytesFromStream(blob.getBinaryStream());

    List&lt;Attachment&gt; atts = new LinkedList&lt;&gt;();
    atts.add(new Attachment(&quot;binaryObjectEto&quot;, MediaType.APPLICATION_JSON, this.offerManagement
        .findProductPicture(productId)));
    atts.add(new Attachment(&quot;blob&quot;, MediaType.APPLICATION_OCTET_STREAM, new ByteArrayInputStream(data)));
    return new MultipartBody(atts, true);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you may have noticed, the data is loaded into the heap before it is added as an Attachement to the MultiPart body.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Caution!</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using a byte array will cause problems, when dealing with large BLOBs.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Why is the sample application using a byte array then?</strong></p>
</div>
<div class="paragraph">
<p>As of now, there is no universal solid way of streaming a BLOB directly from a database to the client without reading the BLOB&#x2019;s content to memory, when streaming over a RESTful service based on JDBC and JAX RS.
Following this approach means:  whenever a file is uploaded or downloaded as BLOB it is loaded completely to memory before it is written to the database.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-blob-support.asciidoc_further-reading">9.31.3. Further Reading</h4>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.w3.org/Protocols/rfc1341/7_2_Multipart.html">The multipart content type</a></p>
</li>
<li>
<p><a href="http://cxf.apache.org/docs/jax-rs-multiparts.html">JAX-RS : Support for Multiparts</a></p>
</li>
<li>
<p><a href="guide-logic-layer.html#component-implementation">Component Implementation</a></p>
</li>
<li>
<p><a href="guide-jpa.html#blob">BLOBs and the Data Access Layer</a></p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Unrestricted_File_Upload">Security Vulnerability Unrestricted File Upload</a></p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-jdk.asciidoc">9.32. Java Development Kit</h3>
<div class="paragraph">
<p>The <a href="https://en.wikipedia.org/wiki/Java_Development_Kit">Java Development Kit</a> is an implementation of the Java platform. It provides the <a href="https://en.wikipedia.org/wiki/Java_virtual_machine">Java Virtual Machine</a> (JVM) and the Java Runtime Environment (JRE).</p>
</div>
<div class="sect3">
<h4 id="guide-jdk.asciidoc_editions">9.32.1. Editions</h4>
<div class="paragraph">
<p>The JDK exists in different editions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://openjdk.java.net/">OpenJDK</a> is a free and open-source edition of the JDK.</p>
</li>
<li>
<p><a href="https://www.oracle.com/technetwork/java/javase/overview/index.html">OracleJDK</a> is a commercial edition of the JDK.</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/List_of_Java_virtual_machines">Various alternative JDK editions</a> either commercial (e.g. IBM&#x2019;s JVM) or open-source.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As Java is evolving and also complex maintaining a JVM requires a lot of energy.
Therefore many alternative JDK editions are unable to cope with this and support latest Java versions and according compatibility.
Unfortunately OpenJDK only maintains a specific version of Java for a relative short period of time before moving to the next major version.
In the end, this technically means that OpenJDK is continuous beta and can not be used in production for reasonable software projects.
As OracleJDK changed its licensing model and can not be used for commercial usage even during development, things can get tricky.
You may want to use OpenJDK for development and OracleJDK only in production.
However, e.g. OpenJDK 11 never released a version that is stable enough for reasonable development (e.g. javadoc tool is <a href="https://bugs.openjdk.java.net/browse/JDK-8212233">broken</a> and fixes are not available of OpenJDK 11 - fixed in 11.0.3 what is only available as OracleJDK 11 or you need to go to OpenJDK 12+, what has other bugs) so in the end there is no working release of OpenJDK 11.
This more or less forces you to use OracleJDK what requires you to buy a subscription so you can use it for commercial development.
However, there is <a href="https://github.com/AdoptOpenJDK">AdoptOpenJDK</a> that provides forked releases of OpenJDK with bug-fixes what might be an option.
Anyhow, as you want to have your development environment close to production, the productively used JDK (most likely OracleJDK) should be preferred also for development.</p>
</div>
</div>
<div class="sect3">
<h4 id="guide-jdk.asciidoc_upgrading">9.32.2. Upgrading</h4>
<div class="paragraph">
<p>Until Java 8 compatibility was one of the key aspects for Java version updates (after the mess on the Swing updates with Java2 many years ago).
However, Java 9 introduced a lot of breaking changes.
This documentation wants to share the experience we collected in devonfw when upgrading from Java 8 to newer versions.
First of all we separate runtime changes that you need if you want to build your software with JDK 8 but such that it can also run on newer versions (e.g. JRE 11)
from changes required to also build your software with more recent JDKs (e.g. JDK 11 or 12).</p>
</div>
<div class="sect4">
<h5 id="guide-jdk.asciidoc_runtime-changes">Runtime Changes</h5>
<div class="paragraph">
<p>This section describes required changes to your software in order to make it run also with versions newer than Java 8.</p>
</div>
<div class="sect5">
<h6 id="guide-jdk.asciidoc_classes-removed-from-jdk">Classes removed from JDK</h6>
<div class="paragraph">
<p>The first thing that most users hit when running their software with newer Java versions is a <code>ClassNotFoundException</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Caused by: java.lang.ClassNotFoundException: javax.xml.bind.JAXBException</code></pre>
</div>
</div>
<div class="paragraph">
<p>As Java 9 introduced a module system with <a href="https://www.baeldung.com/project-jigsaw-java-modularity">Jigsaw</a>, the JDK that has been a monolithic mess is now a well-defined set of structured modules.
Some of the classes that used to come with the JDK moved to modules that where not available by default in Java 9 and have even been removed entirely in later versions of Java.
Therefore you should simply treat such code just like any other 3rd party component that you can add as a (maven) dependency.
The following table gives you the required hints to make your software work even with such classes / modules removed from the JDK (please note that the specified version is just a suggestion that worked, feel free to pick a more recent or more appropriate version):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Dependencies for classes removed from Java 8 since 9+</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Class</strong></th>
<th class="tableblock halign-left valign-top"><strong>GroupId</strong></th>
<th class="tableblock halign-left valign-top"><strong>ArtifactId</strong></th>
<th class="tableblock halign-left valign-top"><strong>Version</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.xml.bind.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.xml.bind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jaxb-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.3.1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.sun.xml.bind.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.glassfish.jaxb</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jaxb-runtime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.3.1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.activation.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.activation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.activation-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.2.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.transaction.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.transaction</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.transaction-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.xml.ws.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.xml.ws</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jaxws-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.3.1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.jws.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.jws</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.jws-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.annotation.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.annotation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.annotation-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.3.2</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="guide-jdk.asciidoc_3rd-party-updates">3rd Party Updates</h6>
<div class="paragraph">
<p>Further, internal and inofficial APIs (e.g. <code>sun.misc.Unsafe</code>) have been removed.
These are typically not used by your software directly but by low-level 3rd party libraries like <code>asm</code> that need to be updated.
Also simple things like the Java version have changed (from <code>1.8.x</code> to <code>9.x</code>, <code>10.x</code>, <code>11.x</code>, <code>12.x</code>, etc.).
Some 3rd party libraries were parsing the Java version in a very naive way making them unable to be used with Java 9+:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Caused by: java.lang.NullPointerException
   at org.apache.maven.surefire.shade.org.apache.commons.lang3.SystemUtils.isJavaVersionAtLeast (SystemUtils.java:1626)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore the following table gives an overview of common 3rd party libraries that have been affected by such breaking changes and need to be updated to at least the specified version:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Minimum recommended versions of common 3rd party for Java 9+</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>GroupId</strong></th>
<th class="tableblock halign-left valign-top"><strong>ArtifactId</strong></th>
<th class="tableblock halign-left valign-top"><strong>Version</strong></th>
<th class="tableblock halign-left valign-top"><strong>Issue</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.commons</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commons-lang3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.7</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://issues.apache.org/jira/browse/LANG-1365">LANG-1365</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cglib</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cglib</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.2.9</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/cglib/cglib/issues/102">102</a>, <a href="https://github.com/cglib/cglib/issues/93">93</a>, <a href="https://github.com/cglib/cglib/issues/133">133</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.ow2.asm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>asm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7.1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/eclipse/jetty.project/issues/2941">2941</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.javassist</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javassist</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.25.0-GA</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/jboss-javassist/javassist/issues/194">194</a>, <a href="https://github.com/jboss-javassist/javassist/issues/228">228</a>, <a href="https://github.com/jboss-javassist/javassist/issues/246">246</a>, <a href="https://github.com/jboss-javassist/javassist/issues/171">171</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="guide-jdk.asciidoc_resourcebundles">ResourceBundles</h6>
<div class="paragraph">
<p>For internationalization (i18n) and localization (l10n) <code>ResourceBundle</code> is used for language and country specific texts and configurations as properties (e.g. <code>MyResourceBundle_de.properties</code>). With Java modules there are changes and impacts you need to know to get things working. The most important change is documented in the <a href="https://docs.oracle.com/javase/9/docs/api/java/util/ResourceBundle.html#bundleprovider">JavaDoc of ResourceBundle</a>. However, instead of using <a href="https://docs.oracle.com/javase/9/docs/api/java/util/spi/ResourceBundleProvider.html">ResourceBundleProvider</a> and refactoring your entire code causing incompatibilities, you can simply put the resource bundles in a regular JAR on the classpath rather than a named module (or into the lauching app).
If you want to implement (new) Java modules with i18n support, you can have a look at <a href="https://github.com/m-m-m/nls#mmm-nls">mmm-nls</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="guide-jdk.asciidoc_buildtime-changes">Buildtime Changes</h5>
<div class="paragraph">
<p>If you also want to change your build to work with a recent JDK you also need to ensure that test frameworks and maven plugins properly support this.</p>
</div>
<div class="sect5">
<h6 id="guide-jdk.asciidoc_findbugs">Findbugs</h6>
<div class="paragraph">
<p>Findbugs does not work with Java 9+ and is actually a dead project.
The new findbugs is <a href="https://spotbugs.github.io/">SpotBugs</a>.
For maven the new solution is <a href="https://spotbugs.github.io/spotbugs-maven-plugin/">spotbugs-maven-plugin</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;plugin&gt;
  &lt;groupId&gt;com.github.spotbugs&lt;/groupId&gt;
  &lt;artifactId&gt;spotbugs-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;3.1.11&lt;/version&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="guide-jdk.asciidoc_test-frameworks">Test Frameworks</h6>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Minimum recommended versions of common 3rd party test frameworks for Java 9+</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>GroupId</strong></th>
<th class="tableblock halign-left valign-top"><strong>ArtifactId</strong></th>
<th class="tableblock halign-left valign-top"><strong>Version</strong></th>
<th class="tableblock halign-left valign-top"><strong>Issue</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.mockito</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mockito-core</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.23.4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/mockito/mockito/issues/1419">1419</a>, <a href="https://github.com/mockito/mockito/issues/1696">1696</a>, <a href="https://github.com/mockito/mockito/issues/1607">1607</a>, <a href="https://github.com/mockito/mockito/issues/1594">1594</a>, <a href="https://github.com/mockito/mockito/issues/1577">1577</a>, <a href="https://github.com/mockito/mockito/issues/1482">1482</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="guide-jdk.asciidoc_maven-plugins">Maven Plugins</h6>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. Minimum recommended versions of common maven plugins for Java 9+</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>GroupId</strong></th>
<th class="tableblock halign-left valign-top"><strong>ArtifactId</strong></th>
<th class="tableblock halign-left valign-top"><strong>(min.) Version</strong></th>
<th class="tableblock halign-left valign-top"><strong>Issue</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-compiler-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.8.1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-surefire-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.22.2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://issues.apache.org/jira/browse/SUREFIRE-1439">SUREFIRE-1439</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-surefire-report-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.22.2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://issues.apache.org/jira/browse/SUREFIRE-1439">SUREFIRE-1439</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-archetype-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.1.0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-javadoc-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.1.0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.jacoco</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jacoco-maven-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.8.3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/jacoco/jacoco/issues/663">663</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="guide-jdk.asciidoc_maven-usage">Maven Usage</h6>
<div class="paragraph">
<p>With Java modules you can not run Javadoc standalone anymore or you will get this error when running <code>mvn javadoc:javadoc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[ERROR] Failed to execute goal org.apache.maven.plugins:maven-javadoc-plugin:3.1.1:javadoc (default-cli) on project mmm-base: An error has occurred in Javadoc report generation:
[ERROR] Exit code: 1 - error: module not found: io.github.mmm.base
[ERROR]
[ERROR] Command line was: /projects/mmm/software/java/bin/javadoc @options @packages @argfile</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a solution or workaround you need to include the <code>compile</code> goal into your build lifecycle so the module-path is properly configured:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn compile javadoc:javadoc</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-jdk.asciidoc_sources-and-links">9.32.3. Sources and Links</h4>
<div class="paragraph">
<p>We want to give credits and say thanks to the following articles that have been there before and helped us on our way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://blog.codefx.org/java/java-9-migration-guide/">Java 9 Migration Guide: The Seven Most Common Challenges</a></p>
</li>
<li>
<p><a href="https://medium.com/criciumadev/its-time-migrating-to-java-11-5eb3868354f9">It&#x2019;s time! Migrating to Java 11</a></p>
</li>
<li>
<p><a href="https://winterbe.com/posts/2018/08/29/migrate-maven-projects-to-java-11-jigsaw/">Migrate Maven Projects to Java 11</a></p>
</li>
<li>
<p><a href="https://www.jesperdj.com/2018/09/30/jaxb-on-java-9-10-11-and-beyond/">JAXB on Java 9, 10, 11 and beyond</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/26413431/which-artifacts-should-i-use-for-jaxb-ri-in-my-maven-project">JAXB Artifacts</a></p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="guide-apm.asciidoc">9.33. Application Performance Management</h3>
<div class="paragraph">
<p>This guide gives hints how to manage, monitor and analyse performance of Java applications.</p>
</div>
<div class="sect3">
<h4 id="guide-apm.asciidoc_temporary-analysis">9.33.1. Temporary Analysis</h4>
<div class="paragraph">
<p>If you are facing performance issues and want to do a punctual analysis we recommend you to use <a href="https://glowroot.org/">glowroot</a>. It is ideal in cases where monitoring in your local development environment is suitable. However, it is also possible to use it in your test environment. It is entirely free and open-source. Still it is very powerful and helps to trace down bottlenecks. To get a first impression of the tool take a look at the <a href="https://demo.glowroot.org">demo</a>.</p>
</div>
<div class="sect4">
<h5 id="guide-apm.asciidoc_jeewtp">JEE/WTP</h5>
<div class="paragraph">
<p>In case you are forced to use an <a href="master-devon4j.asciidoc_guides.html#guide-jee.asciidoc">JEE application server</a> and want to do a temporary analysis you can double click your server instance from the servers view in Eclipse and click on the link <code>Open launch configuration</code> in order to add the <code>-javaagent</code> JVM option.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="guide-apm.asciidoc_regular-analysis">9.33.2. Regular Analysis</h4>
<div class="paragraph">
<p>In case you want to manage application performance regularly we recommend to use <a href="https://github.com/javamelody/javamelody#javamelody">JavaMelody</a> that can be integrated into your application. More information on javamelody is available on the <a href="https://github.com/javamelody/javamelody/wiki">JavaMelody Wiki</a></p>
</div>
</div>
<div class="sect3">
<h4 id="guide-apm.asciidoc_alternatives">9.33.3. Alternatives</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/naver/pinpoint">PinPoint</a></p>
</li>
<li>
<p><a href="https://openapm.io/">OpenAPM</a></p>
</li>
<li>
<p><a href="https://www.appdynamics.com/java/">AppDynamics</a></p>
</li>
<li>
<p><a href="https://www.zabbix.com/features">Zabbix</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>&#x2190;&#xA0;Previous:&#xA0;<a href="master-devon4j.asciidoc_layers.html">Layers</a>&#xA0;| &#x2191;&#xA0;Up:&#xA0;<a href="master-devon4j.asciidoc.html">devon4j</a>&#xA0;| &#x2302;&#xA0;Home:&#xA0;<a href="master.html">devonfw guide</a>&#xA0;| Next:&#xA0;<a href="master-devon4j.asciidoc_devonfw-development.html">devonfw Development</a>&#xA0;&#x2192;</p>
</div>
</div>
<div id="footer" class="footer">
<div class="openblock footerLinks">
<div class="content">
<div class="dlist linklist">
<dl>
<dt class="hdlist1">About</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/getting-started-what-is-devonfw.asciidoc.html">About devonfw</a></p>
</li>
<li>
<p><a href="/website/pages/docs/getting-started-why-should-i-use-devonfw.asciidoc.html">Features</a></p>
</li>
<li>
<p><a href="/website/pages/docs/getting-started-what-is-devonfw.asciidoc.html#getting-started-what-is-devonfw.asciidoc_devonfw-technology-stack">Technology Stack</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Explore</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/master-general-start.asciidoc.html">Getting started</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master-devon4j.asciidoc_introduction.html#architecture.asciidoc">Architecture</a></p>
</li>
<li>
<p><a href="/website/pages/resources/resources.html">Resources</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Docs</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/master-ide.asciidoc_integrated-development-environment.html">User guide</a></p>
</li>
<li>
<p><a href="/website/pages/docs/general-release-notes.asciidoc.html">Releases information</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">Wiki</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Community</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/orgs/devonfw/people">Contributors</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw/devonfw.github.io/blob/develop/README.asciidoc">Website Contribution</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="ulist footerFooter">
<ul>
<li>
<p><a href="#/index.html">Terms of Use</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw">Support</a></p>
</li>
</ul>
</div>
</div>
    <script type="module">
      import { UtilsModule } from '/website/shared/utils.js';
      import { HeaderModule } from '/website/components/header/header.js';

      let searchData = { index: null, documents: null };
      UtilsModule.loadIndex(searchData);

      $(window).on('load', function() {
        const queryFun = () => {
          HeaderModule.queryFunction(searchData);
        };

        HeaderModule.searchOnClick(queryFun);
      });
    </script>
    <script>
      let bb = document.getElementById('menu-button');
      bb.addEventListener('click', function() {
        document.querySelector('.website-navbar ul').classList.toggle('visible');
        console.log(document.querySelector('.website-navbar ul'))
      })
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<div class="footnote"><sub>

Last updated 2019-11-13 14:12:50 UTC
</sub></div>



</body></html>